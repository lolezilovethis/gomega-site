<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gomega — Reset Password</title>
  <style>
    :root{--bg:#f6f7fb;--card:#fff;--accent:#1976d2;--danger:#d32f2f;--muted:#6b7280}
    html,body{height:100%}
    body{
      margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial;
      background:linear-gradient(180deg,#f4f6fb, #eef2fb); display:flex; align-items:center; justify-content:center;
      padding:24px;
    }
    .card{
      width:100%; max-width:520px; background:var(--card); border-radius:12px; box-shadow:0 8px 30px rgba(20,30,60,0.08);
      padding:28px;
    }
    h1{margin:0 0 6px; font-size:20px}
    p.lead{margin:0 0 18px; color:var(--muted); font-size:14px}
    label{display:block; font-size:13px; margin-top:12px; color:#111827}
    input[type="email"], input[type="password"]{
      width:100%; padding:10px 12px; margin-top:6px; border-radius:8px; border:1px solid #e6e9ef; font-size:14px;
      box-sizing:border-box;
    }
    .row{display:flex; gap:8px; margin-top:18px; align-items:center}
    button{
      background:var(--accent); color:#fff; border:none; padding:10px 14px; border-radius:8px; cursor:pointer;
      font-size:14px;
    }
    button.secondary{background:#eef2fb; color:var(--accent); border:1px solid rgba(25,118,210,0.12)}
    button[disabled]{opacity:0.6; cursor:default}
    .muted{color:var(--muted); font-size:13px; margin-top:12px}
    .msg{margin-top:12px; padding:10px 12px; border-radius:8px; font-size:13px; display:none}
    .msg.ok{background:#eefcf3;color:#064e3b;border:1px solid #d1fae5}
    .msg.err{background:#fff4f4;color:#7f1d1d;border:1px solid #fecaca}
    .link{color:var(--accent); text-decoration:none}
    .small{font-size:12px;color:var(--muted)}
    .help{margin-top:12px; font-size:13px}
    .strength{height:8px; width:100%; background:#f1f5f9; border-radius:6px; margin-top:8px; overflow:hidden}
    .strength > i{display:block; height:100%; width:0%; transition:width .18s ease}
  </style>
  <!-- DO NOT include compat SDKs here. Using modular imports below. -->
</head>
<body>
  <div class="card" role="main" aria-labelledby="title">
    <h1 id="title">Reset your Gomega password</h1>
    <p class="lead">Enter your email to receive a reset link — or, if you followed the reset email link, complete your reset on this page.</p>

    <form id="request-area" autocomplete="on">
      <label for="email">Email address</label>
      <input id="email" name="email" type="email" autocomplete="email" placeholder="you@example.com" required />
      <div class="row">
        <button id="sendBtn" type="submit">Send reset email</button>
        <button id="backSignIn" class="secondary" type="button">Back to sign in</button>
      </div>
      <div id="requestMsg" class="msg" role="status" aria-live="polite"></div>
      <p class="help small">If you don't get the email, check your spam folder or try again. Contact support: <a class="link" href="mailto:gomegaassist@gmail.com">gomegaassist@gmail.com</a>.</p>
    </form>

    <form id="reset-area" style="display:none" autocomplete="off">
      <p class="small">Please choose a new password for your account.</p>
      <label for="newPass">New password</label>
      <input id="newPass" name="newPass" type="password" autocomplete="new-password" placeholder="At least 8 characters" required />
      <div class="strength" aria-hidden="true"><i id="strengthBar"></i></div>
      <label for="confirmPass">Confirm password</label>
      <input id="confirmPass" name="confirmPass" type="password" autocomplete="new-password" placeholder="Repeat new password" required />
      <div class="row">
        <button id="confirmBtn" type="submit">Set new password</button>
        <button id="cancelReset" class="secondary" type="button">Cancel</button>
      </div>
      <div id="resetMsg" class="msg" role="status" aria-live="polite"></div>
    </form>

    <p class="muted small" style="margin-top:18px">Need help? Email <a class="link" href="mailto:gomegaassist@gmail.com">gomegaassist@gmail.com</a></p>
  </div>

  <script type="module">
    // Import your modular auth export and needed functions from firebase-auth
    import { auth } from '/js/firebase.js'; // your file already exports `auth`
    import {
      sendPasswordResetEmail,
      verifyPasswordResetCode,
      confirmPasswordReset
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    // DOM
    const requestArea = document.getElementById('request-area');
    const emailEl = document.getElementById('email');
    const sendBtn = document.getElementById('sendBtn');
    const requestMsg = document.getElementById('requestMsg');
    const backSignIn = document.getElementById('backSignIn');

    const resetArea = document.getElementById('reset-area');
    const newPassEl = document.getElementById('newPass');
    const confPassEl = document.getElementById('confirmPass');
    const confirmBtn = document.getElementById('confirmBtn');
    const resetMsg = document.getElementById('resetMsg');
    const cancelReset = document.getElementById('cancelReset');
    const strengthBar = document.getElementById('strengthBar');

    function showMsg(el, text, type = 'ok') {
      el.textContent = text;
      el.className = 'msg ' + (type === 'ok' ? 'ok' : 'err');
      el.style.display = 'block';
    }
    function clearMsg(el) { el.style.display = 'none'; el.textContent = ''; el.className = 'msg'; }

    // Make sure auth is available
    if (!auth) {
      showMsg(requestMsg, 'Firebase auth not initialized. Check /js/firebase.js', 'err');
      throw new Error('Firebase auth not initialized');
    }

    const actionCodeSettings = {
      url: window.location.origin + window.location.pathname
    };

    function getParam(name) {
      return new URLSearchParams(window.location.search).get(name);
    }
    const oobCode = getParam('oobCode') || getParam('oobcode') || null;
    const mode = getParam('mode') || null;

    if (oobCode && mode === 'resetPassword') {
      requestArea.style.display = 'none';
      resetArea.style.display = 'block';
      verifyPasswordResetCode(auth, oobCode)
        .then(email => {
          showMsg(resetMsg, 'Resetting password for: ' + email, 'ok');
        })
        .catch(err => {
          console.error('verifyPasswordResetCode error', err);
          showMsg(resetMsg, 'This reset link is invalid or expired. Request a new reset email.', 'err');
          setTimeout(() => {
            resetArea.style.display = 'none';
            requestArea.style.display = 'block';
          }, 2000);
        });
    } else {
      requestArea.style.display = 'block';
      resetArea.style.display = 'none';
    }

    function genericSentMessage(email) {
      return 'If an account exists for ' + email + ', a password reset email has been sent. Check your inbox (and spam).';
    }

    // Send reset email
    requestArea.addEventListener('submit', async (ev) => {
      ev.preventDefault();
      clearMsg(requestMsg);
      const email = (emailEl.value || '').trim();
      if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
        showMsg(requestMsg, 'Please enter a valid email address.', 'err');
        return;
      }
      sendBtn.disabled = true;
      sendBtn.textContent = 'Sending…';
      try {
        await sendPasswordResetEmail(auth, email, actionCodeSettings);
        showMsg(requestMsg, genericSentMessage(email), 'ok');
        emailEl.value = '';
      } catch (err) {
        console.error('sendPasswordResetEmail error', err);
        if (err && err.code === 'auth/invalid-email') showMsg(requestMsg, 'Please enter a valid email address.', 'err');
        else if (err && err.code === 'auth/too-many-requests') showMsg(requestMsg, 'Too many requests. Try again later.', 'err');
        else showMsg(requestMsg, genericSentMessage(email), 'ok'); // generic to avoid enumeration
      } finally {
        sendBtn.disabled = false;
        sendBtn.textContent = 'Send reset email';
      }
    });

    // Confirm password
    resetArea.addEventListener('submit', async (ev) => {
      ev.preventDefault();
      clearMsg(resetMsg);
      const p1 = newPassEl.value || '';
      const p2 = confPassEl.value || '';
      if (p1.length < 8) { showMsg(resetMsg, 'Password must be at least 8 characters.', 'err'); return; }
      if (p1 !== p2) { showMsg(resetMsg, 'Passwords do not match.', 'err'); return; }
      if (!oobCode) { showMsg(resetMsg, 'Missing reset code. Use the link from your email.', 'err'); return; }

      confirmBtn.disabled = true;
      confirmBtn.textContent = 'Setting…';
      try {
        await confirmPasswordReset(auth, oobCode, p1);
        showMsg(resetMsg, 'Password updated. Redirecting to sign in…', 'ok');
        setTimeout(() => window.location.href = '/signin', 1500);
      } catch (err) {
        console.error('confirmPasswordReset error', err);
        let msg = 'Unable to reset password. The link may be expired or invalid.';
        if (err && err.code === 'auth/weak-password') msg = 'Password is too weak.';
        if (err && err.code === 'auth/expired-action') msg = 'This reset link has expired. Request a new reset email.';
        showMsg(resetMsg, msg, 'err');
      } finally {
        confirmBtn.disabled = false;
        confirmBtn.textContent = 'Set new password';
      }
    });

    backSignIn.addEventListener('click', () => window.location.href = '/signin');
    cancelReset.addEventListener('click', () => window.location.href = '/signin');

    // Strength meter
    function calcStrength(pw) {
      let score = 0;
      if (pw.length >= 8) score++;
      if (/[A-Z]/.test(pw)) score++;
      if (/[0-9]/.test(pw)) score++;
      if (/[^A-Za-z0-9]/.test(pw)) score++;
      return Math.min(4, score);
    }
    function updateStrength() {
      const s = calcStrength(newPassEl.value || '');
      const pct = (s / 4) * 100;
      strengthBar.style.width = pct + '%';
    }
    newPassEl.addEventListener('input', updateStrength);

    // initial focus
    if (oobCode && mode === 'resetPassword') newPassEl.focus(); else emailEl.focus();
  </script>
</body>
</html>
