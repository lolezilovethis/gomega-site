<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Invoice</title>
  <style>
    body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:#071427;color:#e6eef6;padding:28px}
    .card{background:rgba(255,255,255,0.02);padding:18px;border-radius:12px;max-width:760px;margin:24px auto;border:1px solid rgba(255,255,255,0.03)}
    .muted{color:#9aa5b1;font-size:13px}
    .cta{display:inline-block;padding:8px 12px;border-radius:8px;background:linear-gradient(90deg,#6ee7b7,#60a5fa);color:#022;font-weight:700;text-decoration:none}
    pre{background:rgba(0,0,0,0.2);padding:8px;border-radius:6px;overflow:auto}
  </style>
</head>
<body>
  <div class="card" id="root">
    <h2>Invoice</h2>
    <div id="info" class="muted">Loading…</div>
    <div id="content" style="margin-top:12px"></div>
    <div style="margin-top:12px">
      <a id="adminMark" class="cta" href="#" style="display:none">Mark paid (admin)</a>
    </div>
  </div>

  <script>
    (function(){
      const pathParts = window.location.pathname.split('/');
      const invoiceId = pathParts[pathParts.length-1] || '';
      const info = document.getElementById('info');
      const content = document.getElementById('content');
      const adminMark = document.getElementById('adminMark');

      if(!invoiceId){ info.textContent = 'Invoice ID not found in URL.'; return; }

      async function load(){
        info.textContent = 'Loading invoice ' + invoiceId + '…';
        try {
          const res = await fetch('/api/invoice/' + invoiceId);
          if(!res.ok){
            // try to load mock invoice from localStorage
            if(res.status === 404){
              const mockRaw = localStorage.getItem(`mock-invoice-${invoiceId}`);
              if(mockRaw){
                const inv = JSON.parse(mockRaw);
                renderInvoice(inv, true);
                return;
              }
            }
            // read raw text for debugging
            const text = await res.text();
            info.textContent = `Error fetching invoice: ${res.status}`;
            content.innerHTML = `<pre>${text}</pre>`;
            return;
          }
          const inv = await res.json();
          renderInvoice(inv, false);
        } catch (err){
          // network error -> fallback to localStorage
          const mockRaw = localStorage.getItem(`mock-invoice-${invoiceId}`);
          if(mockRaw){
            const inv = JSON.parse(mockRaw);
            renderInvoice(inv, true);
            return;
          }
          info.textContent = 'Network error loading invoice: ' + err.message;
        }
      }

      function renderInvoice(inv, isMock){
        info.textContent = `Invoice ${inv.id} — status: ${inv.status} ${isMock? '(local mock)':''}`;
        content.innerHTML = `
          <div><strong>Plan:</strong> ${inv.plan} (${inv.billing || 'n/a'})</div>
          <div><strong>Amount:</strong> ${typeof inv.amount === 'number' ? ('$' + inv.amount.toFixed(2)) : inv.amount}</div>
          <div><strong>Email:</strong> ${inv.email || '—'}</div>
          <div style="margin-top:8px"><strong>Created:</strong> ${inv.createdAt ? new Date(inv.createdAt).toLocaleString() : '—'}</div>
          <div style="margin-top:12px"><strong>Method:</strong> ${inv.method || '—'}</div>
          <div style="margin-top:12px"><strong>Raw invoice data:</strong><pre>${JSON.stringify(inv, null, 2)}</pre></div>
        `;
        // show admin mark button always for convenience (server will reject if not allowed)
        adminMark.style.display = 'inline-block';
      }

      adminMark.addEventListener('click', async (e)=>{
        e.preventDefault();
        if(!confirm('Mark this invoice as PAID? (admin only)')) return;
        const token = prompt('If you have an admin token, enter it (optional):');
        try {
          const r = await fetch('/api/admin/mark-paid', {
            method: 'POST',
            headers: {'Content-Type':'application/json', ...(token?{'x-admin-token': token}: {})},
            body: JSON.stringify({ invoiceId })
          });
          const json = await r.json();
          if(!r.ok){
            // server failed — update local mock if present and notify
            alert('Server failed to mark paid: ' + (json?.message || r.status) + '\nAttempting local fallback...');
            const mockRaw = localStorage.getItem(`mock-invoice-${invoiceId}`);
            if(mockRaw){
              const inv = JSON.parse(mockRaw);
              inv.status = 'paid';
              inv.paidAt = new Date().toISOString();
              localStorage.setItem(`mock-invoice-${invoiceId}`, JSON.stringify(inv));
              alert('Local mock invoice marked paid.');
              load(); // reload to reflect status
            }
            return;
          }
          alert('Invoice marked paid on server.');
          load();
        } catch (err){
          alert('Network or fetch error: ' + err.message + '\nAttempting local fallback.');
          const mockRaw = localStorage.getItem(`mock-invoice-${invoiceId}`);
          if(mockRaw){
            const inv = JSON.parse(mockRaw);
            inv.status = 'paid';
            inv.paidAt = new Date().toISOString();
            localStorage.setItem(`mock-invoice-${invoiceId}`, JSON.stringify(inv));
            alert('Local mock invoice marked paid.');
            load();
          }
        }
      });

      load();
    })();
  </script>
</body>
</html>
