<!DOCTYPE html>
<html lang="en">
<head>
  <script type="module" src="/js/ban-guard.js"></script>
  <meta charset="UTF-8" />
  <title>Add Script ‚Äì Gomega Watch</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style.css">
  <!-- (styles omitted for brevity ‚Äî keep your existing styles) -->
  <style>/* ... keep your existing CSS ... */</style>
</head>
<body>
  <div class="container">
    <h1>üÜï Add New Script</h1>
    <form id="scriptForm"> 
      <!-- (form elements unchanged) -->
      <!-- same inputs as you had -->
    </form>
  </div>

  <script type="module">
    import { auth, db } from './js/firebase.js';
    import {
      doc, setDoc, getDoc, collection, addDoc, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    let currentUser;

    // small helpers (same as before)
    function brandToId(brand) {
      if (!brand) return '';
      return brand.trim().toLowerCase()
        .replace(/[^a-z0-9\-_\.]/g, '-')
        .replace(/-+/g, '-')
        .replace(/(^-|-$)/g, '');
    }

    async function checkBrandAvailabilityUI(brandName) {
      const availEl = document.getElementById('brandAvailable');
      availEl.className = 'unknown';
      availEl.textContent = '';
      const id = brandToId(brandName);
      if (!id) return;
      try {
        const bRef = doc(db, 'brands', id);
        const snap = await getDoc(bRef);
        if (snap.exists()) {
          if (currentUser && snap.data().ownerId === currentUser.uid) {
            availEl.className = 'ok';
            availEl.textContent = '‚úÖ You own this brand.';
          } else {
            availEl.className = 'taken';
            availEl.textContent = 'üö´ That brand is taken.';
          }
        } else {
          availEl.className = 'ok';
          availEl.textContent = '‚úÖ Brand available';
        }
      } catch (err) {
        console.warn('brand availability check error', err);
        availEl.className = 'unknown';
        availEl.textContent = '';
      }
    }

    // wire UI bits
    document.getElementById('includeAds').addEventListener('change', e => {
      document.getElementById('numAds').disabled = !e.target.checked;
    });

    // Auth guard + brand UI wiring
    onAuthStateChanged(auth, async user => {
      if (!user) return location.href = "/";
      currentUser = user;

      const userRef = doc(db, 'users', user.uid);
      try {
        const snap = await getDoc(userRef);
        if (snap.exists() && snap.data().brandName) {
          const brandInput = document.getElementById('brandName');
          brandInput.value = snap.data().brandName;
          brandInput.disabled = true;
          document.getElementById('brandHint').textContent = 'Brand locked';
          document.getElementById('brandAvailable').className = 'ok';
          document.getElementById('brandAvailable').textContent = '‚úÖ You own this brand.';
        } else {
          const brandInput = document.getElementById('brandName');
          brandInput.addEventListener('input', () => {
            const v = brandInput.value.trim();
            if (v.length === 0) {
              document.getElementById('brandAvailable').textContent = '';
              document.getElementById('brandAvailable').className = 'unknown';
              return;
            }
            if (brandInput._availTimeout) clearTimeout(brandInput._availTimeout);
            brandInput._availTimeout = setTimeout(() => checkBrandAvailabilityUI(v), 350);
          });
        }
      } catch (err) {
        console.error('Failed to load user doc:', err);
        // still attach availability check in case reads are blocked
        const brandInput = document.getElementById('brandName');
        brandInput.addEventListener('input', () => {
          const v = brandInput.value.trim();
          if (v.length === 0) {
            document.getElementById('brandAvailable').textContent = '';
            document.getElementById('brandAvailable').className = 'unknown';
            return;
          }
          if (brandInput._availTimeout) clearTimeout(brandInput._availTimeout);
          brandInput._availTimeout = setTimeout(() => checkBrandAvailabilityUI(v), 350);
        });
      }
    });

    document.getElementById('scriptForm').addEventListener('submit', async e => {
      e.preventDefault();
      const errorEl = document.getElementById('errorMsg');
      const successEl = document.getElementById('successMsg');
      const submitBtn = document.getElementById('submitBtn');

      errorEl.textContent = '';
      successEl.textContent = '';
      submitBtn.disabled = true;

      const title = document.getElementById('title').value.trim();
      const description = document.getElementById('description').value.trim();
      const code = document.getElementById('code').value.trim();
      const brandInput = document.getElementById('brandName');
      const brandName = brandInput.value.trim();
      const includeAds = document.getElementById('includeAds').checked;
      const rawNumAds = document.getElementById('numAds').value;
      const numAds = includeAds ? (parseInt(rawNumAds, 10) || 1) : 0;
      const getPaid = document.getElementById('getPaid').checked;

      if (!title || !code || !brandName) {
        errorEl.textContent = 'Please fill in title, code, and brand.';
        submitBtn.disabled = false;
        return;
      }
      if (includeAds && (numAds < 1 || numAds > 15)) {
        errorEl.textContent = 'Ads count must be between 1 and 15.';
        submitBtn.disabled = false;
        return;
      }

      // Reserve/claim brand if necessary
      if (!brandInput.disabled) {
        const brandId = brandToId(brandName);
        if (!brandId) {
          errorEl.textContent = 'Brand name contains no valid characters.';
          submitBtn.disabled = false;
          return;
        }

        const brandRef = doc(db, 'brands', brandId);
        try {
          await setDoc(brandRef, {
            ownerId: currentUser.uid,
            name: brandName,
            displayName: brandName,
            createdAt: serverTimestamp()
          });
          console.log('Brand reserved:', brandId);
        } catch (brandErr) {
          console.error('Brand reservation failed', brandErr);
          // Try to read existing doc to determine if it's a collision
          try {
            const existing = await getDoc(brandRef);
            if (existing.exists()) {
              if (existing.data().ownerId === currentUser.uid) {
                // already owned by user ‚Äî ok
                console.log('You already own this brand, proceeding.');
              } else {
                errorEl.textContent = 'üö´ That brand is already taken by someone else.';
                submitBtn.disabled = false;
                return;
              }
            } else {
              errorEl.textContent = 'üö´ Could not reserve brand (permission or validation error).';
              submitBtn.disabled = false;
              return;
            }
          } catch (readErr) {
            console.warn('brand read after failed create also failed', readErr);
            errorEl.textContent = 'üö´ Could not reserve brand name.';
            submitBtn.disabled = false;
            return;
          }
        }
      }

      // --- SAFE users doc create/update: check existence first ---
      const userRef = doc(db, 'users', currentUser.uid);
      try {
        const userSnap = await getDoc(userRef);
        if (userSnap.exists()) {
          // update (merge) ‚Äî allowed by your rules
          try {
            await setDoc(userRef, { brandName }, { merge: true });
            console.log('User doc updated: merged brandName');
          } catch (uErr) {
            console.error('Failed to update existing user doc', uErr);
            errorEl.textContent = '‚ùå Failed to update your user profile. Check console for details.';
            submitBtn.disabled = false;
            return;
          }
        } else {
          // create with required fields (rules expect uid and displayName)
          const displayName = currentUser.displayName || '';
          try {
            await setDoc(userRef, { uid: currentUser.uid, displayName, brandName });
            console.log('User doc created with uid & displayName');
          } catch (uErr2) {
            console.error('Failed to create user doc', uErr2);
            errorEl.textContent = '‚ùå Could not create user profile (permission denied).';
            submitBtn.disabled = false;
            return;
          }
        }
      } catch (readUserErr) {
        console.error('Failed to check user doc existence', readUserErr);
        errorEl.textContent = '‚ùå Could not verify user profile. Please try again.';
        submitBtn.disabled = false;
        return;
      }

      // Now create the approved_scripts doc (rules require ownerId == auth.uid)
      try {
        const scriptData = {
          title,
          description,
          code,
          brandName,
          includeAds,
          numAds: includeAds ? numAds : 0,
          getPaid,
          ownerId: currentUser.uid,
          submittedBy: currentUser.uid,
          timestamp: serverTimestamp()
        };

        await addDoc(collection(db, 'approved_scripts'), scriptData);
        successEl.textContent = '‚úÖ Script published successfully!';
        document.getElementById('scriptForm').reset();
        document.getElementById('numAds').disabled = true;
        brandInput.disabled = true;
        document.getElementById('brandHint').textContent = 'Brand locked';
        document.getElementById('brandAvailable').className = 'ok';
        document.getElementById('brandAvailable').textContent = '‚úÖ You own this brand.';
      } catch (err) {
        console.error('Publish failed', err);
        // give precise hint
        if (err?.code === 'permission-denied' || (err && /permission/i.test(String(err)))) {
          errorEl.textContent = '‚ùå Permission denied when publishing script. Check Firestore rules and required fields.';
        } else {
          errorEl.textContent = '‚ùå Failed to publish script. Please try again.';
        }
      } finally {
        submitBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
