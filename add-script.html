<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Add Script ‚Äì Gomega Watch</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container center">
    <h1>üÜï Add New Script</h1>
    <form id="scriptForm">
      <label>
        Title:<br>
        <input type="text" id="title" placeholder="Example: Auto Farm" required>
      </label><br><br>

      <label>
        Description:<br>
        <input type="text" id="description" placeholder="Short description (optional)">
      </label><br><br>

      <label>
        Script Code:<br>
        <textarea id="code" rows="10" placeholder="Paste Lua script here..." required></textarea>
      </label><br><br>

      <label>
        Brand Name:<br>
        <input type="text" id="brandName" placeholder="Your publishing brand" required>
      </label><br><br>

      <label>
        <input type="checkbox" id="includeAds">
        Include Ads?
      </label><br><br>

      <label>
        Number of Ads (1‚Äì15):<br>
        <input type="number" id="numAds" value="1" min="1" max="15">
      </label><br><br>

      <label>
        <input type="checkbox" id="getPaid">
        üí∏ I want to get paid in the future
      </label><br><br>

      <button type="submit">üíæ Publish Script</button>
    </form>

    <p id="successMsg" style="color: green; margin-top: 20px;"></p>
  </div>

  <script type="module">
    import { auth, db } from './js/firebase.js';
    import {
      doc,
      setDoc,
      getDoc,
      collection,
      addDoc
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    let currentUser;

    onAuthStateChanged(auth, async (user) => {
      if (!user) return location.href = "/";
      currentUser = user;

      const userDoc = doc(db, "users", user.uid);
      const snapshot = await getDoc(userDoc);

      if (snapshot.exists()) {
        const brandName = snapshot.data().brandName;
        document.getElementById("brandName").value = brandName;
        document.getElementById("brandName").disabled = true;
      }
    });

    document.getElementById("scriptForm").addEventListener("submit", async function (e) {
      e.preventDefault();

      const title = document.getElementById("title").value.trim();
      const description = document.getElementById("description").value.trim();
      const code = document.getElementById("code").value.trim();
      const brandNameInput = document.getElementById("brandName");
      const brandName = brandNameInput.value.trim();
      const includeAds = document.getElementById("includeAds").checked;
      const numAds = parseInt(document.getElementById("numAds").value);
      const getPaid = document.getElementById("getPaid").checked;

      if (!title || !code || !brandName) {
        return alert("‚ùå Title, Code, and Brand Name are required.");
      }

      if (includeAds && (numAds < 1 || numAds > 15)) {
        return alert("‚ùå Number of ads must be between 1 and 15.");
      }

      // Save brand name if it's first time
      if (!brandNameInput.disabled) {
        await setDoc(doc(db, "users", currentUser.uid), {
          brandName: brandName
        });
      }

      // Save the script directly to "approved_scripts"
      const scriptData = {
        title,
        description,
        code,
        brandName,
        includeAds,
        numAds: includeAds ? numAds : 0,
        getPaid,
        submittedBy: currentUser.uid,
        timestamp: Date.now()
      };

      try {
        await addDoc(collection(db, "approved_scripts"), scriptData);
        document.getElementById("successMsg").textContent = "‚úÖ Script published successfully!";
        document.getElementById("scriptForm").reset();
        if (brandNameInput.disabled === false) {
          brandNameInput.disabled = true;
        }
      } catch (err) {
        console.error("Error publishing script:", err);
        alert("‚ùå Failed to publish script.");
      }
    });
  </script>
</body>
</html>
