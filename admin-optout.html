<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>School Admin Panel ‚Äì Gomega</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="container center">
    <h1>üìö School Administrator Panel</h1>
    <p>You can opt your school out of this website or request moderation features.</p>

    <textarea id="reason" placeholder="Explain why you want to opt out or what features you need..." rows="6" style="width: 100%;"></textarea>
    <button onclick="submitOptOut()">Submit Request</button>
  </div>

  <script type="module">
    import { auth } from './js/firebase.js';
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    onAuthStateChanged(auth, user => {
      const cameFromWelcome = localStorage.getItem("userRoute") === "admin-optout.html";
      const isSchoolEmail = /(@henrico\.k12\.va\.us|\.edu)$/i.test(user?.email || "");

      if (!user || !cameFromWelcome || !isSchoolEmail) {
        alert("Access denied: Admin-only section.");
        location.href = "welcome.html";
      } else {
        window.currentEmail = user.email;
      }
    });

    window.submitOptOut = async () => {
      const reason = document.getElementById("reason").value.trim();
      if (!reason) return alert("Please describe your request.");

      const content = `üì¨ **New School Opt-Out Request**
**Email:** ${window.currentEmail}
**Reason:** ${reason}`;

      try {
        await fetch("https://discord.com/api/webhooks/1395130152584876195/inn8hj4U9DFU8Q1ppNBdsJx8vDgCYF1WhC7bf49ECQmRLMAE9eT7j5Q9Jcf49ny-9Gxc", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ content })
        });
        alert("‚úÖ Your request has been sent to our team.");
        document.getElementById("reason").value = "";
      } catch (err) {
        alert("‚ùå Failed to send request. Try again later.");
        console.error(err);
      }
    };
  </script>
</body>
</html>
