<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Account Suspended — Gomega Watch</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="/style.css">
  <style>
    :root{
      --bg:#0f0f10; --card:#141416; --muted:#a6a6a6; --accent:#00d4ff; --danger:#ff5252;
      --glass: rgba(255,255,255,0.02);
      --glow: 0 10px 40px rgba(0,212,255,0.12);
    }
    html,body{height:100%; margin:0; font-family:Inter,Arial,Helvetica,sans-serif; background:linear-gradient(180deg,#0b0b0c,#0f0f10); color:#eef2f3;}
    .wrap{max-width:960px;margin:36px auto;padding:20px;}
    .card{background:var(--card); border-radius:12px; padding:20px; box-shadow:0 10px 40px rgba(0,0,0,0.6); border:1px solid rgba(255,255,255,0.02);}
    h1{color:var(--accent); margin:0 0 6px 0;}
    .sub{color:var(--muted); margin-bottom:16px;}
    .ban-list{display:flex;flex-direction:column;gap:12px;margin-top:12px;}
    .ban{background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00)); border-radius:8px; padding:12px; border:1px solid rgba(255,255,255,0.03);}
    .ban.active{outline: 2px solid rgba(0,212,255,0.14); box-shadow: 0 8px 30px rgba(0,212,255,0.04) inset;}
    .ban .row{display:flex; gap:12px; align-items:center; flex-wrap:wrap;}
    .tag{font-weight:700; padding:6px 8px; border-radius:6px; font-size:0.85rem;}
    .tag.duration{background:rgba(255,255,255,0.02);}
    .left{flex:1;}
    .meta{color:var(--muted); font-size:0.9rem; margin-top:8px;}
    .reason{font-weight:700; color:#fff; margin-top:8px;}
    .note{background:rgba(0,0,0,0.25); padding:10px; border-radius:6px; margin-top:8px; color:var(--muted); font-size:0.95rem;}
    .actions{display:flex;gap:8px;margin-top:12px;}
    .btn{background:linear-gradient(90deg,var(--accent),#0066ff); color:#001; padding:10px 12px; border-radius:8px; font-weight:700; border:none; cursor:pointer;}
    .btn.ghost{background:transparent; color:var(--accent); border:1px solid rgba(255,255,255,0.04);}
    .btn.danger{background:linear-gradient(90deg,#ff7b7b,#ff4040); color:#fff;}
    .muted{color:var(--muted);}
    .small{font-size:0.9rem;}
    .center{display:flex; align-items:center; justify-content:center;}
    .notice{background:linear-gradient(90deg, rgba(255,212,0,0.06), rgba(255,255,255,0.01)); border-left:4px solid rgba(255,212,0,0.25); padding:10px; border-radius:6px; color:#fff; margin-top:12px;}
    .hidden{display:none;}
    a.link{color:var(--accent); text-decoration:none; font-weight:700;}
    pre.code{background:#0b0b0c;padding:10px;border-radius:6px;overflow:auto;color:#d3f6ff;font-size:0.92rem;}

    /* New additions */
    .reactivate-available {
      animation: pulse 1.6s infinite;
      box-shadow: var(--glow);
      transform: translateY(-2px);
    }
    @keyframes pulse {
      0% { box-shadow: 0 8px 30px rgba(0,212,255,0.06); transform: translateY(0); }
      50% { box-shadow: 0 18px 60px rgba(0,212,255,0.14); transform: translateY(-3px); }
      100% { box-shadow: 0 8px 30px rgba(0,212,255,0.06); transform: translateY(0); }
    }

    .countdown { font-weight:800; color:#fff; font-size:1.05rem; margin-top:8px; }
    .reactivate-note { margin-left:8px; color:var(--muted); font-size:0.95rem; max-width: 520px; }
    .muted-strong { color:#d6e9ef; font-weight:700; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card" id="mainCard">
      <h1>Account Suspended</h1>
      <div class="sub">Your account has been suspended due to one or more policy violations. This page lists your ban history and the current suspension details.</div>

      <!-- Summary area -->
      <div id="summary" class="card" style="margin-bottom:14px; padding:14px; background:var(--glass);">
        <div id="summaryText" class="muted">Loading ban information…</div>
        <div id="countdownWrap" class="hidden" style="margin-top:8px;">
          <div class="countdown" id="countdownText"></div>
        </div>
      </div>

      <!-- Ban list -->
      <div>
        <h3 style="margin:0 0 6px 0">Ban history</h3>
        <p class="muted small">Multiple bans are shown below. Active/most recent ban is highlighted.</p>

        <div id="banList" class="ban-list">
          <!-- ban cards injected here -->
        </div>
      </div>

      <div class="notice" id="appealNotice">
        <strong>To request an appeal</strong>: visit <a class="link" href="/violations">Violations &amp; Appeals</a> and follow the instructions. Include any relevant details and dates.
      </div>

      <div style="display:flex; gap:8px; margin-top:16px; justify-content:flex-end; align-items:center;">
        <button id="goHome" class="btn ghost">Go to Homepage</button>
        <div style="display:flex;flex-direction:column;align-items:flex-end;">
          <button id="reactivateBtn" class="btn" disabled>Reactivate (when available)</button>
          <div id="reactivateHelper" class="reactivate-note muted small" style="display:block; margin-top:6px;">
            By clicking <span class="muted-strong">Reactivate account</span> you request the system to clear the suspension flag on your account. This attempts a server update — if it fails, contact support or file an appeal.
          </div>
        </div>
      </div>

      <p class="muted small" style="margin-top:10px;">If you believe this is a mistake contact <a class="link" href="mailto:gomegaassist@gmail.com">gomegaassist@gmail.com</a>.</p>
    </div>
  </div>

  <script type="module">
    // IMPORTANT: This file expects /js/firebase.js to export named `auth` and `db`.
    import { auth, db } from '/js/firebase.js';
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { doc, getDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const summaryText = document.getElementById('summaryText');
    const banListEl = document.getElementById('banList');
    const goHomeBtn = document.getElementById('goHome');
    const reactivateBtn = document.getElementById('reactivateBtn');
    const reactivateHelper = document.getElementById('reactivateHelper');
    const countdownWrap = document.getElementById('countdownWrap');
    const countdownText = document.getElementById('countdownText');

    let currentUser = null;
    let userDoc = null;
    let countdownInterval = null;

    function fmtDate(ts) {
      if (!ts) return '—';
      try {
        const d = ts.toDate ? ts.toDate() : new Date(ts);
        return d.toLocaleString(undefined, { dateStyle: 'medium', timeStyle: 'short' });
      } catch (e) {
        return String(ts);
      }
    }

    function makeBanCard(ban, idx, active) {
      const el = document.createElement('div');
      el.className = 'ban' + (active ? ' active' : '');
      // header row
      const header = document.createElement('div');
      header.className = 'row';
      const left = document.createElement('div');
      left.className = 'left';
      const title = document.createElement('div');
      title.innerHTML = `<div style="font-weight:800">${ban.title || 'Suspension'}</div>`;
      const meta = document.createElement('div');
      meta.className = 'meta';
      meta.innerHTML = `
        <span class="tag duration">${ban.lengthText || ban.length || '—'}</span>
        &nbsp; • &nbsp; Reviewed: <strong>${fmtDate(ban.reviewedAt)}</strong>
        &nbsp; • &nbsp; Start: <strong>${fmtDate(ban.start)}</strong>
        &nbsp; • &nbsp; Reactivate: <strong>${fmtDate(ban.end)}</strong>
      `;
      left.appendChild(title);
      left.appendChild(meta);

      header.appendChild(left);
      el.appendChild(header);

      // reason
      const reason = document.createElement('div');
      reason.className = 'reason';
      reason.textContent = `Reason: ${ban.reason || '—'}`;
      el.appendChild(reason);

      // offensive item / place
      if (ban.offensiveItem) {
        const off = document.createElement('div');
        off.className = 'muted small';
        off.textContent = `Offensive Item: ${ban.offensiveItem}`;
        el.appendChild(off);
      }

      // moderator note
      if (ban.moderatorNote) {
        const note = document.createElement('div');
        note.className = 'note';
        note.innerHTML = `<strong>Moderator Note:</strong><br>${ban.moderatorNote}`;
        el.appendChild(note);
      }

      return el;
    }

    async function attemptReactivate(uid) {
      reactivateBtn.disabled = true;
      const origText = reactivateBtn.textContent;
      reactivateBtn.textContent = 'Reactivating…';

      try {
        const userRef = doc(db, 'users', uid);
        // check server to avoid overwriting current state
        const snap = await getDoc(userRef);
        if (!snap.exists()) {
          alert('Account record not found on server. Contact support.');
          reactivateBtn.disabled = false;
          reactivateBtn.textContent = origText;
          return;
        }
        const serverData = snap.data();
        // If already not banned, simply acknowledge and redirect
        if (!serverData.banned) {
          alert('Your account is already unbanned. Redirecting to homepage.');
          location.href = '/';
          return;
        }

        // attempt to clear banned flag and record reactivatedAt
        await updateDoc(userRef, { banned: false, reactivatedAt: serverTimestamp() });

        // success
        alert('Your account has been reactivated. Redirecting to homepage…');
        location.href = '/';
      } catch (err) {
        console.error('reactivate failed', err);
        // show helpful failure message
        alert('Unable to automatically reactivate your account. If this persists, please contact support or file an appeal via Violations & Appeals.');
        reactivateBtn.disabled = false;
        reactivateBtn.textContent = origText;
      }
    }

    // update UI for the reactivate button based on userDoc and bans
    function updateReactivateUI(normalizedBans = []) {
      // clear any previous countdown
      if (countdownInterval) {
        clearInterval(countdownInterval);
        countdownInterval = null;
      }
      countdownWrap.classList.add('hidden');
      countdownText.textContent = '';

      const now = Date.now();
      const hasBannedFlag = !!(userDoc && userDoc.banned);
      const hasAnyBans = Array.isArray(normalizedBans) && normalizedBans.length > 0;

      // find soonest ban end (if any)
      const ends = (normalizedBans || []).map(b => {
        try {
          return b.end ? (b.end.getTime ? b.end.getTime() : new Date(b.end).getTime()) : null;
        } catch { return null; }
      }).filter(x => x !== null && !isNaN(x));

      const soonestEnd = ends.length ? Math.min(...ends) : null;

      // Case A: userDoc.banned === false (already unbanned) -> show reactivate button enabled
      if (userDoc && userDoc.banned === false) {
        reactivateBtn.disabled = false;
        reactivateBtn.textContent = 'Reactivate account (available)';
        reactivateBtn.classList.add('reactivate-available');
        reactivateHelper.innerHTML = 'By clicking <strong class="muted-strong">Reactivate account</strong> you confirm you want to restore access. This attempts to clear the suspension flag on your account — if a server-side review still finds a problem your access may be restricted again.';
        return;
      }

      // Case B: ban has expired (soonestEnd <= now) -> enable button and show it prominently
      if (soonestEnd && soonestEnd <= now) {
        reactivateBtn.disabled = false;
        reactivateBtn.textContent = 'Reactivate account (ban expired)';
        reactivateBtn.classList.add('reactivate-available');
        reactivateHelper.innerHTML = 'Your ban period has ended. Click <strong class="muted-strong">Reactivate account</strong> to request reactivation. This attempts a server update — server-side checks may still apply.';
        return;
      }

      // Case C: No banned flag but also no ban entries — (edge) enable to be safe
      if (!hasBannedFlag && !hasAnyBans) {
        reactivateBtn.disabled = false;
        reactivateBtn.textContent = 'Reactivate account (available)';
        reactivateBtn.classList.add('reactivate-available');
        reactivateHelper.innerHTML = 'No active suspension found. Click to restore your account.';
        return;
      }

      // Otherwise (active ban in future) -> disable and show countdown if we have an end
      reactivateBtn.disabled = true;
      reactivateBtn.classList.remove('reactivate-available');
      reactivateBtn.textContent = 'Reactivate (when available)';
      reactivateHelper.innerHTML = 'Your account is currently suspended. You may be eligible to reactivate when the suspension period ends. To appeal now visit <a class="link" href="/violations">Violations & Appeals</a>.';

      if (soonestEnd) {
        countdownWrap.classList.remove('hidden');
        // update every second
        function updateCountdown() {
          const remaining = soonestEnd - Date.now();
          if (remaining <= 0) {
            countdownText.textContent = 'Available to reactivate now';
            // enable button and style
            reactivateBtn.disabled = false;
            reactivateBtn.classList.add('reactivate-available');
            reactivateBtn.textContent = 'Reactivate account (available)';
            reactivateHelper.innerHTML = 'Your ban period ended — you can click <strong class="muted-strong">Reactivate account</strong> to attempt reactivation. Server checks may still apply.';
            clearInterval(countdownInterval);
            countdownInterval = null;
            return;
          }
          // format remaining as D H M S
          const seconds = Math.floor(remaining / 1000) % 60;
          const minutes = Math.floor(remaining / (1000 * 60)) % 60;
          const hours = Math.floor(remaining / (1000 * 60 * 60)) % 24;
          const days = Math.floor(remaining / (1000 * 60 * 60 * 24));
          let parts = [];
          if (days) parts.push(days + 'd');
          if (hours) parts.push(hours + 'h');
          if (minutes) parts.push(minutes + 'm');
          parts.push(seconds + 's');
          countdownText.textContent = 'Reactivation available in: ' + parts.join(' ');
        }
        updateCountdown();
        countdownInterval = setInterval(updateCountdown, 1000);
      }
    }

    goHomeBtn.addEventListener('click', () => location.href = '/');

    reactivateBtn.addEventListener('click', async () => {
      if (!currentUser) return;
      // Local check: find any ban whose end <= now
      const now = Date.now();
      const bans = Array.isArray(userDoc?.bans) ? userDoc.bans : [];
      const canReactivate = !userDoc?.banned || bans.some(b => {
        try {
          const end = b.end && b.end.toDate ? b.end.toDate().getTime() : (b.end ? new Date(b.end).getTime() : null);
          return end && end <= now;
        } catch (e) { return false; }
      });
      if (!canReactivate) {
        alert('Reactivation is not yet available for your account. See the countdown above for when you can reactivate, or file an appeal via Violations & Appeals.');
        return;
      }
      if (!confirm('Reactivate your account now? This will attempt to clear the suspension flag on your account. Server-side checks may still re-apply a suspension.')) return;
      await attemptReactivate(currentUser.uid);
    });

    // Main: check auth and load ban info
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        summaryText.innerHTML = 'You are not signed in. <a class="link" href="/signin">Sign in</a> to view details about your account.';
        document.getElementById('mainCard').scrollIntoView();
        return;
      }
      currentUser = user;

      try {
        const uRef = doc(db, 'users', user.uid);
        const snap = await getDoc(uRef);
        if (!snap.exists()) {
          summaryText.innerHTML = 'No account information found. If you believe this is an error, contact support.';
          return;
        }
        userDoc = snap.data();

        // Expected structure:
        // userDoc.banned === true/false
        // userDoc.bans === [ { title, reason, moderatorNote, offensiveItem, reviewedAt: Timestamp, start: Timestamp, end: Timestamp, lengthText } , ... ]
        const now = Date.now();
        const bansArray = Array.isArray(userDoc.bans) ? userDoc.bans : [];

        // Normalize timestamps (if using Firestore Timestamps)
        const normalized = bansArray.map(b => {
          const copy = {...b};
          try {
            if (b.reviewedAt && b.reviewedAt.toDate) copy.reviewedAt = b.reviewedAt.toDate();
            else if (b.reviewedAt) copy.reviewedAt = new Date(b.reviewedAt);
            if (b.start && b.start.toDate) copy.start = b.start.toDate();
            else if (b.start) copy.start = new Date(b.start);
            if (b.end && b.end.toDate) copy.end = b.end.toDate();
            else if (b.end) copy.end = new Date(b.end);
          } catch(e) {}
          return copy;
        });

        // find active bans (s<=now<=e)
        const activeBans = normalized.filter(b => {
          try {
            if (!b.start && !b.end) return true;
            const s = b.start ? b.start.getTime() : -Infinity;
            const e = b.end ? b.end.getTime() : Infinity;
            return s <= now && now <= e;
          } catch { return false; }
        });

        // sort descending by reviewedAt or start
        normalized.sort((A,B) => {
          const a = (A.reviewedAt && A.reviewedAt.getTime()) || (A.start && A.start.getTime()) || 0;
          const b = (B.reviewedAt && B.reviewedAt.getTime()) || (B.start && B.start.getTime()) || 0;
          return b - a;
        });

        // If user is not banned and there are no active bans, allow them to stay on page and show reactivate
        const hasActive = activeBans.length > 0 || !!userDoc.banned;
        if (!hasActive) {
          // Not actively banned — show message and enable reactivate by default
          summaryText.innerHTML = `
            <div class="muted small">No active suspensions found on your account. You may reactivate immediately.</div>
          `;
          // render previously bans (if any) then enable reactivate
          banListEl.innerHTML = '';
          normalized.forEach((b, i) => {
            const isActive = false;
            const card = makeBanCard({
              title: b.title || `Suspension #${i+1}`,
              reviewedAt: b.reviewedAt || b.reviewed || b.timestamp || b.start || null,
              start: b.start || b.reviewedAt || null,
              end: b.end || null,
              lengthText: b.lengthText || b.duration || b.length || 'Temporary',
              reason: b.reason || 'Violation of Terms of Use',
              moderatorNote: b.moderatorNote || b.note || '',
              offensiveItem: b.offensiveItem || b.offensive || ''
            }, i, isActive);
            banListEl.appendChild(card);
          });
          // set userDoc.banned to false if present locally and update UI
          updateReactivateUI(normalized);
          return;
        }

        // show summary text for active ban
        if (activeBans.length) {
          const a = activeBans[0];
          const reactivateStr = a.end ? a.end.toLocaleString() : 'Unknown';
          summaryText.innerHTML = `
            <strong class="small">Banned until</strong>
            <div style="font-weight:800; font-size:1.05rem; margin-top:6px;">${reactivateStr}</div>
            <div class="muted small" style="margin-top:6px;">Reason: ${a.reason || '—'}</div>
          `;
        } else {
          // no active bans but banned flag true (edge case) — show helpful text
          const recent = normalized[0];
          const expiry = recent && recent.end ? recent.end.toLocaleString() : 'Unknown';
          summaryText.innerHTML = `
            <div class="muted small">Your account is suspended (recent ban ended ${expiry}). You may be eligible to reactivate.</div>
          `;
        }

        // Render ban list
        banListEl.innerHTML = '';
        normalized.forEach((b, i) => {
          const isActive = (activeBans.findIndex(x => x === b) >= 0) || false;
          const card = makeBanCard({
            title: b.title || `Suspension #${i+1}`,
            reviewedAt: b.reviewedAt || b.reviewed || b.timestamp || b.start || null,
            start: b.start || b.reviewedAt || null,
            end: b.end || null,
            lengthText: b.lengthText || b.duration || b.length || 'Temporary',
            reason: b.reason || 'Violation of Terms of Use',
            moderatorNote: b.moderatorNote || b.note || '',
            offensiveItem: b.offensiveItem || b.offensive || ''
          }, i, isActive);
          banListEl.appendChild(card);
        });

        // Decide whether reactivation should be available (expired bans or unbanned)
        updateReactivateUI(normalized);

      } catch (err) {
        console.error('Failed to load user/ban info', err);
        summaryText.innerHTML = 'Failed to load ban information. If this persists, contact support.';
      }
    });
  </script>
</body>
</html>
