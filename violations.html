<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Violations & Support ‚Äî Gomega Watch</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/style.css">
  <style>
    :root{
      --bg:#0b0b0c; --card:#111214; --muted:#9aa4aa; --accent:#00d4ff; --glass: rgba(255,255,255,0.02);
      --danger:#ff5252; --success:#40d88a;
    }
    html,body{height:100%; margin:0; font-family:Inter,Arial,Helvetica,sans-serif; background:linear-gradient(180deg,#050506,#0b0b0c); color:#eaf1f3;}
    .wrap{max-width:1000px;margin:30px auto;padding:18px;}
    .card{background:var(--card); border-radius:12px; padding:18px; box-shadow:0 8px 30px rgba(0,0,0,0.6); border:1px solid rgba(255,255,255,0.02); margin-bottom:16px;}
    h1{margin:0 0 8px 0; color:var(--accent);}
    p.muted{color:var(--muted); margin:0 0 12px 0;}
    .row{display:flex; gap:12px; align-items:center; flex-wrap:wrap;}
    .small{font-size:0.9rem; color:var(--muted);}
    .btn{background:linear-gradient(90deg,var(--accent),#0066ff); color:#001; padding:10px 12px; border-radius:8px; font-weight:700; border:none; cursor:pointer;}
    .btn.ghost{background:transparent; color:var(--accent); border:1px solid rgba(255,255,255,0.04);}
    .btn.danger{background:linear-gradient(90deg,#ff7b7b,#ff4040); color:#fff;}
    .controls { display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }
    .muted-note{background:rgba(255,255,255,0.02); padding:8px; border-radius:6px; color:var(--muted); margin-top:8px;}
    .ban-list{display:flex;flex-direction:column;gap:10px;margin-top:12px;}
    .ban{background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00)); border-radius:8px; padding:12px; border:1px solid rgba(255,255,255,0.03);}
    .ban.active{outline: 2px solid rgba(0,212,255,0.12);}
    .meta{color:var(--muted); font-size:0.9rem; margin-top:8px;}
    .why-list{display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:12px; margin-top:12px;}
    .why-item{background:rgba(255,255,255,0.02); padding:12px; border-radius:8px; color:var(--muted); font-size:0.95rem;}
    .checklist{background:rgba(255,255,255,0.015); padding:12px; border-radius:8px; margin-top:10px;}
    .hidden{display:none;}
    table { width:100%; border-collapse:collapse; margin-top:12px; }
    th,td { padding:8px 10px; text-align:left; border-bottom:1px solid rgba(255,255,255,0.02); font-size:0.9rem; color:#dfeef0; }
    .tag { padding:4px 8px; border-radius:6px; font-weight:700; font-size:0.85rem; display:inline-block; }
    .tag.pending{ background:rgba(255,212,0,0.08); color: #ffd54f; }
    .tag.approved{ background:rgba(64,216,138,0.08); color:var(--success); }
    .tag.denied{ background:rgba(255,82,82,0.06); color:var(--danger); }
    a.link{color:var(--accent); text-decoration:none;}
    @media (max-width:700px) { .row{flex-direction:column; align-items:stretch;} .controls { justify-content:flex-start; } }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <div>
          <h1>Violations & Support</h1>
          <p class="muted">View your ban history, download a ban report, and find instructions if you think a decision is unfair.</p>
        </div>
        <div class="small">
          <a class="link" href="/not-approved">Why am I here?</a> ¬∑ <a class="link" href="/help">Help</a>
        </div>
      </div>
    </div>

    <!-- USER BAN SUMMARY -->
    <div id="banCard" class="card">
      <h2 style="margin-top:0">Your ban summary</h2>
      <div id="banSummary" class="muted-note">Loading account info‚Ä¶</div>

      <div id="banList" class="ban-list" style="margin-top:12px;"></div>

      <div class="controls" style="margin-top:12px;">
        <button id="downloadReport" class="btn">üì• Download ban report</button>
        <button id="copyTemplate" class="btn ghost">üìã Copy appeal template</button>
        <button id="emailSupport" class="btn">‚úâÔ∏è Email Support</button>
        <button id="openDiscord" class="btn">üí¨ Appeal on Discord</button>
        <button id="prepareChecklist" class="btn ghost">üßæ Prepare appeal checklist</button>
      </div>

      <div id="supportNote" class="muted-note" style="margin-top:12px;">
        If you believe this decision is unfair, please email us at
        <a class="link" href="mailto:gomegaassist@gmail.com">gomegaassist@gmail.com</a>
        or appeal in our Discord server: <a id="discordInvite" class="link" href="#" target="_blank">Join Discord</a>.
        Include your UID (displayed below) and any relevant evidence (screenshots, timestamps, links).
      </div>
    </div>

    <!-- WHY USERS GET BANNED -->
    <div class="card" id="whyCard">
      <h2 style="margin-top:0">Why users commonly get banned</h2>
      <p class="small">Most bans are caused by a small number of rule violations. Below are the most frequent reasons and tips to avoid them.</p>

      <div class="why-list">
        <div class="why-item">
          <strong>Harassment / Hate Speech</strong>
          <div class="small" style="margin-top:6px;">Abusive language, threats, or targeted harassment of other users. Tip: be respectful ‚Äî delete aggressive messages and apologize if needed.</div>
        </div>
        <div class="why-item">
          <strong>Cheating / Exploits</strong>
          <div class="small" style="margin-top:6px;">Using cheats, exploits, or tools that provide unfair advantage. Tip: stop using/existing cheat tools and provide proof you no longer use them.</div>
        </div>
        <div class="why-item">
          <strong>Spam & Scams</strong>
          <div class="small" style="margin-top:6px;">Mass messaging, phishing, or posting scam links. Tip: remove scam content and provide evidence of cleanup.</div>
        </div>
        <div class="why-item">
          <strong>Impersonation</strong>
          <div class="small" style="margin-top:6px;">Pretending to be staff, other users, or brands. Tip: keep accurate display names and avoid misleading claims.</div>
        </div>
        <div class="why-item">
          <strong>Copyright / DMCA</strong>
          <div class="small" style="margin-top:6px;">Sharing copyrighted material without permission. Tip: remove infringing content and provide proof of rights/permission.</div>
        </div>
        <div class="why-item">
          <strong>Evading a Ban</strong>
          <div class="small" style="margin-top:6px;">Creating alternate accounts to bypass previous bans. Tip: stop evasion and contact staff from the original account if possible.</div>
        </div>
      </div>

      <div class="checklist" id="appealChecklist" style="display:none; margin-top:12px;">
        <strong>Appeal checklist ‚Äî what to include</strong>
        <ol style="margin-top:8px;">
          <li>Clear description of what happened and why you think the ban is wrong.</li>
          <li>Timestamps and links (if referring to specific messages or posts).</li>
          <li>Screenshots or recordings as evidence.</li>
          <li>Your account UID (below) and any alt accounts you may have used.</li>
          <li>Steps you took to fix the issue (removed content, uninstalled tools, etc.).</li>
        </ol>
      </div>
    </div>

    <!-- ADMIN PANEL (hidden unless admin) -->
    <div id="adminPanel" class="card admin-panel hidden">
      <h2 style="margin-top:0">Moderator: Appeals queue</h2>
      <p class="small">Approve/deny appeals, add moderator notes, and ban/unban users. Recommended: perform ban/unban server-side (Cloud Function) for security.</p>

      <div id="appealsTableWrap">
        <table id="appealsTable">
          <thead><tr><th>Submitted</th><th>User</th><th>Subject</th><th>Message</th><th>Status</th><th>Actions</th></tr></thead>
          <tbody id="appealsTbody"></tbody>
        </table>
      </div>
    </div>

    <div class="small muted-note">
      <strong>Note:</strong>This page provides convenience tools for preparing an appeal and contacting support.
    </div>
  </div>

  <script type="module">
    // Violations & Support page (updated ‚Äî no client-side appeal submission)
    import { auth, db } from '/js/firebase.js';
    import { onAuthStateChanged, getIdTokenResult } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import {
      doc, getDoc, collection, query, orderBy, onSnapshot, updateDoc, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const banSummary = document.getElementById('banSummary');
    const banListEl = document.getElementById('banList');
    const downloadReportBtn = document.getElementById('downloadReport');
    const copyTemplateBtn = document.getElementById('copyTemplate');
    const emailSupportBtn = document.getElementById('emailSupport');
    const openDiscordBtn = document.getElementById('openDiscord');
    const prepareChecklistBtn = document.getElementById('prepareChecklist');
    const appealChecklist = document.getElementById('appealChecklist');
    const discordInviteLink = document.getElementById('discordInvite');

    const adminPanel = document.getElementById('adminPanel');
    const appealsTbody = document.getElementById('appealsTbody');

    // replace with your actual invite (or keep an endpoint that redirects to invite)
    const DISCORD_INVITE = 'https://discord.gg/kZtW4y2Q7u';
    discordInviteLink.href = DISCORD_INVITE;

    let currentUser = null;
    let currentUserDoc = null;
    let isAdmin = false;

    function fmtDate(ts) {
      if (!ts) return '‚Äî';
      try {
        const d = ts.toDate ? ts.toDate() : new Date(ts);
        return d.toLocaleString();
      } catch (e) {
        return String(ts);
      }
    }

    function makeBanCard(b, idx, active) {
      const el = document.createElement('div');
      el.className = 'ban' + (active ? ' active' : '');
      const title = document.createElement('div');
      title.innerHTML = `<strong>${b.title || 'Suspension'}</strong>`;
      const meta = document.createElement('div');
      meta.className = 'meta';
      meta.innerHTML = `
        ${b.lengthText ? `<span class="tag">${b.lengthText}</span>` : ''}
        &nbsp; &bull; Reviewed: <strong>${fmtDate(b.reviewedAt || b.start)}</strong>
        &nbsp; &bull; Reactivate: <strong>${b.end ? fmtDate(b.end) : 'Unknown'}</strong>
      `;
      const reason = document.createElement('div');
      reason.className = 'small';
      reason.style.marginTop = '8px';
      reason.textContent = `Reason: ${b.reason || '‚Äî'}`;
      el.appendChild(title);
      el.appendChild(meta);
      el.appendChild(reason);
      if (b.moderatorNote) {
        const note = document.createElement('div');
        note.className = 'muted-note';
        note.style.marginTop = '8px';
        note.textContent = `Moderator note: ${b.moderatorNote}`;
        el.appendChild(note);
      }
      return el;
    }

    // Load user and show ban info
    async function loadUserInfo(uid) {
      try {
        const uref = doc(db, 'users', uid);
        const snap = await getDoc(uref);
        if (!snap.exists()) {
          banSummary.textContent = 'No account document found.';
          banListEl.innerHTML = '';
          currentUserDoc = null;
          return;
        }
        const data = snap.data();
        currentUserDoc = data;
        const bannedFlag = !!data.banned;
        const bans = Array.isArray(data.bans) ? data.bans.slice().reverse() : [];

        if (bannedFlag || bans.length) {
          banSummary.innerHTML = bannedFlag ? `Your account is currently flagged as <strong>banned</strong> (UID: <code>${uid}</code>).` : 'Your account has suspension records.';
        } else {
          banSummary.textContent = `No active suspensions found on your account (UID: ${uid}).`;
        }

        banListEl.innerHTML = '';
        const now = Date.now();
        bans.forEach((b, i) => {
          // normalize Firestore timestamps for display
          const normalized = {...b};
          try {
            if (b.reviewedAt && b.reviewedAt.toDate) normalized.reviewedAt = b.reviewedAt.toDate();
            if (b.start && b.start.toDate) normalized.start = b.start.toDate();
            if (b.end && b.end.toDate) normalized.end = b.end.toDate();
          } catch(e){}
          const isActive = (() => {
            try {
              const s = normalized.start ? normalized.start.getTime() : -Infinity;
              const e = normalized.end ? normalized.end.getTime() : Infinity;
              return s <= now && now <= e;
            } catch { return false; }
          })();
          banListEl.appendChild(makeBanCard(normalized, i, isActive));
        });
      } catch (err) {
        console.error('loadUserInfo error', err);
        banSummary.textContent = 'Failed to load account info.';
      }
    }

    // Build a ban report and trigger download
    function downloadBanReport() {
      if (!currentUser) return alert('Sign in to download your ban report.');
      const payload = {
        uid: currentUser.uid,
        email: currentUser.email || null,
        fetchedAt: new Date().toISOString(),
        bans: currentUserDoc && currentUserDoc.bans ? currentUserDoc.bans : [],
        bannedFlag: !!(currentUserDoc && currentUserDoc.banned)
      };
      const blob = new Blob([JSON.stringify(payload, null, 2)], {type: 'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `gomega-ban-report-${currentUser.uid}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    // Copy a prefilled appeal template to clipboard
    async function copyAppealTemplate() {
      if (!currentUser) return alert('Sign in to copy an appeal template.');
      const template = [
        `Appeal for account: ${currentUser.uid}`,
        `Email: ${currentUser.email || '(none)'}`,
        '',
        'Brief summary of the issue (what happened):',
        '- ',
        '',
        'Why this ban is incorrect / mitigation steps taken:',
        '- ',
        '',
        'Evidence links (screenshots, timestamps):',
        '- ',
        '',
        'Anything else staff should know:',
        '- '
      ].join('\n');
      try {
        await navigator.clipboard.writeText(template);
        alert('Appeal template copied to clipboard. Paste it into an email or your Discord appeal message.');
      } catch (e) {
        console.error('copy failed', e);
        alert('Unable to copy automatically. Please select and copy the following template manually:\n\n' + template);
      }
    }

    // Compose an email using mailto with prefilled subject/body
    function openEmailSupport() {
      if (!currentUser) return location.href = 'mailto:gomegaassist@gmail.com';
      const subject = encodeURIComponent(`Appeal request ‚Äî UID ${currentUser.uid}`);
      const body = encodeURIComponent([
        `Account UID: ${currentUser.uid}`,
        `Registered email: ${currentUser.email || '(none)'}`,
        '',
        'Brief explanation (replace this text):',
        '- '
      ].join('\n'));
      location.href = `mailto:gomegaassist@gmail.com?subject=${subject}&body=${body}`;
    }

    // Open Discord invite
    function openDiscord() {
      window.open(DISCORD_INVITE, '_blank');
    }

    // Toggle checklist
    function toggleChecklist() {
      const show = appealChecklist.style.display !== 'block';
      appealChecklist.style.display = show ? 'block' : 'none';
    }

    // ADMIN: render appeals row (if you still collect appeals server-side)
    function renderAppealsRow(docId, data) {
      const tr = document.createElement('tr');
      const created = data.createdAt && data.createdAt.toDate ? data.createdAt.toDate().toLocaleString() : (data.createdAt ? String(data.createdAt) : '‚Äî');
      const userCell = `<td><a class="link" href="/profile?uid=${data.uid}" target="_blank">${data.uid}</a><div class="small">${data.email || ''}</div></td>`;
      const subjectCell = `<td>${escapeHtml(data.subject || '')}</td>`;
      const messageCell = `<td style="max-width:400px; white-space:pre-wrap;">${escapeHtml(data.message || '')}${data.evidence ? '<div class="small" style="margin-top:6px;"><a class="link" href="'+escapeAttr(data.evidence)+'" target="_blank">Evidence</a></div>' : ''}</td>`;
      const statusCell = `<td><span class="tag ${data.status === 'pending' ? 'pending' : data.status === 'approved' ? 'approved' : 'denied'}">${escapeHtml(data.status||'pending')}</span></td>`;
      tr.innerHTML = `<td style="white-space:nowrap">${escapeHtml(created)}</td>${userCell}${subjectCell}${messageCell}${statusCell}<td></td>`;

      const actionsTd = tr.querySelector('td:last-child');

      const approveBtn = document.createElement('button');
      approveBtn.className = 'btn';
      approveBtn.textContent = 'Approve';
      approveBtn.addEventListener('click', async () => {
        if (!confirm('Approve this appeal?')) return;
        try {
          await updateDoc(doc(db, 'appeals', docId), { status: 'approved', moderatedAt: serverTimestamp() });
        } catch (e) {
          alert('Failed to approve: ' + e.message);
        }
      });

      const denyBtn = document.createElement('button');
      denyBtn.className = 'btn danger';
      denyBtn.textContent = 'Deny';
      denyBtn.style.marginLeft = '6px';
      denyBtn.addEventListener('click', async () => {
        const note = prompt('Optional moderator note to include with denial (leave empty for none)');
        try {
          await updateDoc(doc(db, 'appeals', docId), { status: 'denied', moderatedAt: serverTimestamp(), moderatorNote: note || '' });
        } catch (e) {
          alert('Failed to deny: ' + e.message);
        }
      });

      const banToggle = document.createElement('button');
      banToggle.className = 'btn ghost';
      banToggle.style.marginLeft = '6px';
      banToggle.textContent = 'Toggle Ban';
      banToggle.addEventListener('click', async () => {
        if (!confirm('Toggle banned flag for this user? Server-side recommended.')) return;
        try {
          const uref = doc(db, 'users', data.uid);
          const usnap = await getDoc(uref);
          const udata = usnap.exists() ? usnap.data() : {};
          const next = !udata.banned;
          await updateDoc(uref, { banned: next, lastBanToggledAt: serverTimestamp() });
          alert('Updated banned flag to ' + String(next));
        } catch (e) {
          alert('Failed to toggle ban: ' + e.message);
        }
      });

      actionsTd.appendChild(approveBtn);
      actionsTd.appendChild(denyBtn);
      actionsTd.appendChild(banToggle);

      return tr;
    }

    // Load appeals for admin if available
    function loadAdminAppeals() {
      try {
        const q = query(collection(db, 'appeals'), orderBy('createdAt', 'desc'));
        onSnapshot(q, snap => {
          appealsTbody.innerHTML = '';
          snap.docs.forEach(d => {
            const row = renderAppealsRow(d.id, d.data());
            appealsTbody.appendChild(row);
          });
        }, err => {
          console.error('appeals onSnapshot err', err);
        });
      } catch (e) {
        console.warn('Admin appeals load failed', e);
      }
    }

    // Utilities
    function escapeHtml(s) {
      if (s === null || s === undefined) return '';
      return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');
    }
    function escapeAttr(s){ return escapeHtml(s).replace(/"/g, '&quot;'); }

    // Attach UI handlers
    downloadReportBtn.addEventListener('click', downloadBanReport);
    copyTemplateBtn.addEventListener('click', copyAppealTemplate);
    emailSupportBtn.addEventListener('click', openEmailSupport);
    openDiscordBtn.addEventListener('click', openDiscord);
    prepareChecklistBtn.addEventListener('click', toggleChecklist);

    // Auth state
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        location.href = '/signin';
        return;
      }
      currentUser = user;
      await loadUserInfo(user.uid);

      // determine admin privileges: check users/{uid}.isAdmin and token claims
      try {
        const uref = doc(db, 'users', user.uid);
        const snap = await getDoc(uref);
        const src = snap.exists() ? snap.data() : {};
        if (src && src.isAdmin) {
          isAdmin = true;
        } else {
          try {
            const token = await getIdTokenResult(user, false);
            if (token && token.claims && (token.claims.admin || token.claims.moderator || token.claims.staff)) {
              isAdmin = true;
            }
          } catch (e) { console.warn('getIdTokenResult error', e); }
        }
      } catch (err) { console.warn('admin check failed', err); }

      if (isAdmin) {
        adminPanel.classList.remove('hidden');
        loadAdminAppeals();
      } else {
        adminPanel.classList.add('hidden');
      }
    });
  </script>
</body>
</html>
