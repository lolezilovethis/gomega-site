<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Violations & Appeals — Gomega Watch</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/style.css">
  <style>
    :root{
      --bg:#0b0b0c; --card:#111214; --muted:#9aa4aa; --accent:#00d4ff; --glass: rgba(255,255,255,0.02);
      --danger:#ff5252; --success:#40d88a;
    }
    html,body{height:100%; margin:0; font-family:Inter,Arial,Helvetica,sans-serif; background:linear-gradient(180deg,#050506,#0b0b0c); color:#eaf1f3;}
    .wrap{max-width:1000px;margin:30px auto;padding:18px;}
    .card{background:var(--card); border-radius:12px; padding:18px; box-shadow:0 8px 30px rgba(0,0,0,0.6); border:1px solid rgba(255,255,255,0.02); margin-bottom:16px;}
    h1{margin:0 0 8px 0; color:var(--accent);}
    p.muted{color:var(--muted); margin:0 0 12px 0;}
    .row{display:flex; gap:12px; align-items:center; flex-wrap:wrap;}
    label{display:block; font-size:0.9rem; color:var(--muted); margin-bottom:6px;}
    input[type="text"], input[type="url"], textarea, select { width:100%; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.03); background:rgba(255,255,255,0.02); color:#eef2f3; box-sizing:border-box; }
    textarea{min-height:120px; resize:vertical;}
    .btn{background:linear-gradient(90deg,var(--accent),#0066ff); color:#001; padding:10px 12px; border-radius:8px; font-weight:700; border:none; cursor:pointer;}
    .btn.ghost{background:transparent; color:var(--accent); border:1px solid rgba(255,255,255,0.04);}
    .btn.danger{background:linear-gradient(90deg,#ff7b7b,#ff4040); color:#fff;}
    .small{font-size:0.9rem; color:var(--muted);}
    .ban-list{display:flex;flex-direction:column;gap:10px;margin-top:12px;}
    .ban{background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00)); border-radius:8px; padding:12px; border:1px solid rgba(255,255,255,0.03);}
    .ban.active{outline: 2px solid rgba(0,212,255,0.12);}
    .meta{color:var(--muted); font-size:0.9rem; margin-top:8px;}
    .muted-note{background:rgba(255,255,255,0.02); padding:8px; border-radius:6px; color:var(--muted); margin-top:8px;}
    .admin-panel{margin-top:12px;}
    table { width:100%; border-collapse:collapse; margin-top:12px; }
    th,td { padding:8px 10px; text-align:left; border-bottom:1px solid rgba(255,255,255,0.02); font-size:0.9rem; color:#dfeef0; }
    .tag { padding:4px 8px; border-radius:6px; font-weight:700; font-size:0.85rem; display:inline-block; }
    .tag.pending{ background:rgba(255,212,0,0.08); color: #ffd54f; }
    .tag.approved{ background:rgba(64,216,138,0.08); color:var(--success); }
    .tag.denied{ background:rgba(255,82,82,0.06); color:var(--danger); }
    .flex-between{display:flex; justify-content:space-between; align-items:center;}
    .note-small{font-size:0.85rem; color:var(--muted);}
    a.link{color:var(--accent); text-decoration:none;}
    .hidden{display:none;}
    @media (max-width:700px) { .row{flex-direction:column; align-items:stretch;} }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="flex-between">
        <div>
          <h1>Violations & Appeals</h1>
          <p class="muted">View your ban history and submit an appeal. Appeals are reviewed by staff — please include any relevant evidence and a clear explanation.</p>
        </div>
        <div class="small">
          <a class="link" href="/not-approved">Why am I here?</a> · <a class="link" href="/help">Help</a>
        </div>
      </div>
    </div>

    <!-- USER BAN SUMMARY -->
    <div id="banCard" class="card">
      <h2 style="margin-top:0">Your ban summary</h2>
      <div id="banSummary" class="muted-note">Loading account info…</div>

      <div id="banList" class="ban-list" style="margin-top:12px;"></div>
    </div>

    <!-- APPEAL FORM -->
    <div class="card" id="appealCard">
      <h2 style="margin-top:0">Submit an appeal</h2>
      <p class="small">Filing an appeal will create a pending ticket for moderators. Do not submit duplicate appeals for the same suspension — update your appeal instead.</p>

      <form id="appealForm">
        <label for="appealSubject">Subject</label>
        <input id="appealSubject" name="subject" type="text" placeholder="e.g. Mistaken ban for DMCA violation" required>

        <label for="appealMessage" style="margin-top:10px">Message / Explanation</label>
        <textarea id="appealMessage" name="message" placeholder="Explain why you think the ban is incorrect, include dates, usernames, and context..." required></textarea>

        <label for="evidenceUrl" style="margin-top:10px">Evidence URL (optional)</label>
        <input id="evidenceUrl" name="evidence" type="url" placeholder="Direct link to screenshot or other evidence (optional)">

        <div style="display:flex; gap:8px; margin-top:12px; align-items:center;">
          <button class="btn" type="submit">Submit Appeal</button>
          <button id="cancelAppeal" type="button" class="btn ghost">Clear</button>
          <div id="appealStatus" class="small" style="margin-left:auto"></div>
        </div>
      </form>
    </div>

    <!-- ADMIN PANEL (hidden unless admin) -->
    <div id="adminPanel" class="card admin-panel hidden">
      <h2 style="margin-top:0">Moderator: Appeals queue</h2>
      <p class="small">Approve/deny appeals, add moderator notes, and ban/unban users. Recommended: perform ban/unban server-side (Cloud Function) for security.</p>

      <div id="appealsTableWrap">
        <table id="appealsTable">
          <thead><tr><th>Submitted</th><th>User</th><th>Subject</th><th>Message</th><th>Status</th><th>Actions</th></tr></thead>
          <tbody id="appealsTbody"></tbody>
        </table>
      </div>
    </div>

    <div class="small muted-note">
      <strong>Note:</strong> For security, it's best to perform any permanent ban/unban actions using an admin-only server-side endpoint (Cloud Functions) rather than client-side updates. This page attempts client-side updates for convenience, but if your Firestore rules block those updates you'll need a server admin function.
    </div>
  </div>

  <script type="module">
    // Violations & Appeals page
    // Expects /js/firebase.js to export `auth` and `db` (named exports).
    import { auth, db } from '/js/firebase.js';
    import { onAuthStateChanged, getIdTokenResult } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import {
      doc, getDoc, collection, addDoc, serverTimestamp, query, orderBy, onSnapshot, updateDoc, getDocs
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const banSummary = document.getElementById('banSummary');
    const banListEl = document.getElementById('banList');
    const appealForm = document.getElementById('appealForm');
    const appealStatus = document.getElementById('appealStatus');
    const cancelAppeal = document.getElementById('cancelAppeal');
    const adminPanel = document.getElementById('adminPanel');
    const appealsTbody = document.getElementById('appealsTbody');

    let currentUser = null;
    let currentUserDoc = null;
    let isAdmin = false;

    function fmtDate(ts) {
      if (!ts) return '—';
      try {
        const d = ts.toDate ? ts.toDate() : new Date(ts);
        return d.toLocaleString();
      } catch (e) {
        return String(ts);
      }
    }

    // make a ban card
    function makeBanCard(b, idx, active) {
      const el = document.createElement('div');
      el.className = 'ban' + (active ? ' active' : '');
      const title = document.createElement('div');
      title.innerHTML = `<strong>${b.title || 'Suspension'}</strong>`;
      const meta = document.createElement('div');
      meta.className = 'meta';
      meta.innerHTML = `
        ${b.lengthText ? `<span class="tag">${b.lengthText}</span>` : ''}
        &nbsp; &bull; Reviewed: <strong>${fmtDate(b.reviewedAt || b.start)}</strong>
        &nbsp; &bull; Reactivate: <strong>${b.end ? fmtDate(b.end) : 'Unknown'}</strong>
      `;
      const reason = document.createElement('div');
      reason.className = 'small';
      reason.style.marginTop = '8px';
      reason.textContent = `Reason: ${b.reason || '—'}`;
      el.appendChild(title);
      el.appendChild(meta);
      el.appendChild(reason);
      if (b.moderatorNote) {
        const note = document.createElement('div');
        note.className = 'muted-note';
        note.style.marginTop = '8px';
        note.textContent = `Moderator note: ${b.moderatorNote}`;
        el.appendChild(note);
      }
      return el;
    }

    // Load user and show ban info
    async function loadUserInfo(uid) {
      try {
        const uref = doc(db, 'users', uid);
        const snap = await getDoc(uref);
        if (!snap.exists()) {
          banSummary.textContent = 'No account document found.';
          banListEl.innerHTML = '';
          currentUserDoc = null;
          return;
        }
        const data = snap.data();
        currentUserDoc = data;
        const bannedFlag = !!data.banned;
        const bans = Array.isArray(data.bans) ? data.bans.slice().reverse() : [];

        if (bannedFlag || bans.length) {
          banSummary.innerHTML = bannedFlag ? 'Your account is currently flagged as <strong>banned</strong>.' : 'Your account has suspension records.';
        } else {
          banSummary.textContent = 'No active suspensions found on your account.';
        }

        banListEl.innerHTML = '';
        const now = Date.now();
        bans.forEach((b, i) => {
          // normalize Firestore timestamps for display
          const normalized = {...b};
          try {
            if (b.reviewedAt && b.reviewedAt.toDate) normalized.reviewedAt = b.reviewedAt.toDate();
            if (b.start && b.start.toDate) normalized.start = b.start.toDate();
            if (b.end && b.end.toDate) normalized.end = b.end.toDate();
          } catch(e){}
          const isActive = (() => {
            try {
              const s = normalized.start ? normalized.start.getTime() : -Infinity;
              const e = normalized.end ? normalized.end.getTime() : Infinity;
              return s <= now && now <= e;
            } catch { return false; }
          })();
          banListEl.appendChild(makeBanCard(normalized, i, isActive));
        });
      } catch (err) {
        console.error('loadUserInfo error', err);
        banSummary.textContent = 'Failed to load account info.';
      }
    }

    // Submit appeal
    appealForm.addEventListener('submit', async (ev) => {
      ev.preventDefault();
      appealStatus.textContent = '';
      if (!currentUser) {
        appealStatus.textContent = 'You must be signed in to submit an appeal.';
        return;
      }
      const subject = document.getElementById('appealSubject').value.trim();
      const message = document.getElementById('appealMessage').value.trim();
      const evidence = document.getElementById('evidenceUrl').value.trim() || null;
      if (!subject || !message) {
        appealStatus.textContent = 'Subject and message are required.';
        return;
      }

      appealStatus.textContent = 'Submitting…';
      try {
        const payload = {
          uid: currentUser.uid,
          email: currentUser.email || null,
          subject,
          message,
          evidence,
          status: 'pending',
          createdAt: serverTimestamp(),
        };
        const docRef = await addDoc(collection(db, 'appeals'), payload);
        appealStatus.textContent = 'Appeal submitted. Ticket ID: ' + docRef.id;
        appealForm.reset();

        // Optional: send a notification to a moderator webhook (server-side recommended)
        // If you want client-side webhook calls, make sure webhook is protected server-side.
        // Uncomment and replace WEBHOOK_URL if you have a protected endpoint that posts to Discord.
        /*
        try {
          await fetch('/api/notify-moderators', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ type: 'appeal', id: docRef.id, uid: currentUser.uid, subject })
          });
        } catch (e) { console.warn('notify failed', e); }
        */
      } catch (err) {
        console.error('submit appeal err', err);
        appealStatus.textContent = 'Failed to submit appeal. Please try again later or contact support.';
      }
    });

    cancelAppeal.addEventListener('click', () => {
      appealForm.reset();
      appealStatus.textContent = '';
    });

    // ADMIN: render appeals table
    function renderAppealsRow(docId, data) {
      const tr = document.createElement('tr');
      const created = data.createdAt && data.createdAt.toDate ? data.createdAt.toDate().toLocaleString() : (data.createdAt ? String(data.createdAt) : '—');
      const userCell = `<td><a class="link" href="/profile?uid=${data.uid}" target="_blank">${data.uid}</a><div class="note-small">${data.email || ''}</div></td>`;
      const subjectCell = `<td>${escapeHtml(data.subject || '')}</td>`;
      const messageCell = `<td style="max-width:400px; white-space:pre-wrap;">${escapeHtml(data.message || '')}${data.evidence ? '<div class="note-small" style="margin-top:6px;"><a class="link" href="'+escapeAttr(data.evidence)+'" target="_blank">Evidence</a></div>' : ''}</td>`;
      const statusCell = `<td><span class="tag ${data.status === 'pending' ? 'pending' : data.status === 'approved' ? 'approved' : 'denied'}">${escapeHtml(data.status||'pending')}</span></td>`;
      tr.innerHTML = `<td style="white-space:nowrap">${escapeHtml(created)}</td>${userCell}${subjectCell}${messageCell}${statusCell}<td></td>`;
      // actions
      const actionsTd = tr.querySelector('td:last-child');
      const approveBtn = document.createElement('button');
      approveBtn.className = 'btn';
      approveBtn.textContent = 'Approve';
      approveBtn.addEventListener('click', async () => {
        if (!confirm('Approve this appeal? Approving will mark appeal approved. Optionally ban/unban users below.')) return;
        try {
          await updateDoc(doc(db, 'appeals', docId), { status: 'approved', moderatedAt: serverTimestamp() });
          // Optionally: update user's banned flag using admin action — recommend server-side
          // Example of client-side update (requires appropriate Firestore rules):
          // await updateDoc(doc(db,'users', data.uid), { banned: false });
        } catch (e) {
          alert('Failed to approve: ' + e.message);
        }
      });
      const denyBtn = document.createElement('button');
      denyBtn.className = 'btn danger';
      denyBtn.textContent = 'Deny';
      denyBtn.style.marginLeft = '6px';
      denyBtn.addEventListener('click', async () => {
        const note = prompt('Optional moderator note to include with denial (leave empty for none)');
        try {
          await updateDoc(doc(db, 'appeals', docId), { status: 'denied', moderatedAt: serverTimestamp(), moderatorNote: note || '' });
        } catch (e) {
          alert('Failed to deny: ' + e.message);
        }
      });

      const banToggle = document.createElement('button');
      banToggle.className = 'btn ghost';
      banToggle.style.marginLeft = '6px';
      banToggle.textContent = 'Toggle Ban';
      banToggle.addEventListener('click', async () => {
        if (!confirm('Toggle banned flag for this user? This will flip the users/{uid}.banned boolean. Server-side recommended.')) return;
        try {
          // fetch user doc current
          const uref = doc(db, 'users', data.uid);
          const usnap = await getDoc(uref);
          const udata = usnap.exists() ? usnap.data() : {};
          const next = !udata.banned;
          await updateDoc(uref, { banned: next, lastBanToggledAt: serverTimestamp() });
          alert('Updated banned flag to ' + String(next));
        } catch (e) {
          alert('Failed to toggle ban: ' + e.message + '\nIf permission denied, implement a server admin function.');
        }
      });

      actionsTd.appendChild(approveBtn);
      actionsTd.appendChild(denyBtn);
      actionsTd.appendChild(banToggle);

      return tr;
    }

    // Load appeals for admin (real-time)
    function loadAdminAppeals() {
      const q = query(collection(db, 'appeals'), orderBy('createdAt', 'desc'));
      onSnapshot(q, snap => {
        appealsTbody.innerHTML = '';
        snap.docs.forEach(d => {
          const row = renderAppealsRow(d.id, d.data());
          appealsTbody.appendChild(row);
        });
      }, err => {
        console.error('appeals onSnapshot err', err);
      });
    }

    // Utilities
    function escapeHtml(s) {
      if (s === null || s === undefined) return '';
      return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');
    }
    function escapeAttr(s){ return escapeHtml(s).replace(/"/g, '&quot;'); }

    // Auth state
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        // Redirect to home or signin (we require sign-in)
        // comment the next line if you want anonymous access
        location.href = '/signin';
        return;
      }
      currentUser = user;
      // load user doc and bans
      await loadUserInfo(user.uid);

      // determine admin privileges:
      // 1) check users/{uid}.isAdmin
      // 2) check custom claims admin via getIdTokenResult
      try {
        // check user doc for isAdmin
        const uref = doc(db, 'users', user.uid);
        const snap = await getDoc(uref);
        const src = snap.exists() ? snap.data() : {};
        if (src && src.isAdmin) {
          isAdmin = true;
        } else {
          // check token claims
          try {
            const token = await getIdTokenResult(user, /* forceRefresh */ false);
            if (token && token.claims && (token.claims.admin || token.claims.moderator || token.claims.staff)) {
              isAdmin = true;
            }
          } catch (e) {
            // ignore token read errors
            console.warn('getIdTokenResult error', e);
          }
        }
      } catch (err) {
        console.warn('admin check failed', err);
      }

      if (isAdmin) {
        adminPanel.classList.remove('hidden');
        loadAdminAppeals();
      } else {
        adminPanel.classList.add('hidden');
      }
    });
  </script>
</body>
</html>
