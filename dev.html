<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gomega — Profile (fixed)</title>
  <style>
    :root { --accent:#1e88e5; --bg:#071022; --card:#071827; color-scheme: dark; }
    body { margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial; background: linear-gradient(180deg,#071023 0%, #071020 60%); color:#ddd; display:flex; min-height:100vh; align-items:center; justify-content:center; padding:24px; }
    .card { background:rgba(255,255,255,0.03); border-radius:12px; padding:20px; width:100%; max-width:880px; box-shadow: 0 8px 30px rgba(2,6,23,0.6); }
    .profile { display:flex; gap:18px; align-items:center; }
    .avatar { width:110px; height:110px; border-radius:12px; background:linear-gradient(135deg,var(--accent),#8ab4ff); display:flex; align-items:center; justify-content:center; font-weight:700; font-size:36px; color:#021025; box-shadow:0 6px 20px rgba(0,0,0,0.6); }
    .meta { flex:1; }
    h1 { margin:0 0 6px 0; font-size:20px; }
    .username-url { color:var(--accent); font-weight:600; cursor:pointer; user-select:none; }
    .badges { margin-top:8px; display:flex; gap:8px; flex-wrap:wrap; }
    .badge { background:rgba(255,255,255,0.04); padding:6px 8px; border-radius:8px; font-size:13px; display:inline-flex; gap:8px; align-items:center; }
    .actions { margin-left:auto; display:flex; gap:8px; }
    .btn { background:var(--accent); color:white; border:none; padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:600; }
    .btn.secondary { background:transparent; border:1px solid rgba(255,255,255,0.06); color:inherit; }
    .small { font-size:13px; color:#aaa; margin-top:6px; }
    .center { text-align:center; padding:20px; }
    input[type="text"] { padding:8px 10px; border-radius:8px; border:1px solid rgba(255,255,255,0.06); background:transparent; color:inherit; width:260px; }
    .signin { display:flex; gap:8px; align-items:center; }
    @media (max-width:600px) {
      .profile { flex-direction:column; align-items:flex-start; }
      .actions { margin-left:0; width:100%; }
    }
    .hint { margin-top:10px; color:#9aa7b2; font-size:13px; }
    .error { color:#ff7b7b; font-weight:700; }
  </style>
</head>
<body>
  <div class="card" id="root">
    <div id="loading" class="center">Loading profile…</div>

    <div id="profileTemplate" style="display:none">
      <div class="profile">
        <div class="avatar" id="avatar">GK</div>
        <div class="meta">
          <h1 id="displayName">User</h1>
          <div>
            <span id="usernameLine"></span>
          </div>
          <div class="badges" id="badges"></div>
          <div class="small" id="bio"></div>
        </div>

        <div class="actions" id="actions">
          <!-- dynamic -->
        </div>
      </div>

      <hr style="margin:16px 0; border:none; height:1px; background: rgba(255,255,255,0.03)">

      <div id="ownerControls" style="display:none">
        <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap">
          <input id="newUsername" placeholder="enter username (3-30 chars)" />
          <button class="btn" id="claimBtn">Claim / Change Username</button>
          <button class="btn secondary" id="copyLinkBtn">Copy profile link</button>
          <div class="small" id="ownerInfo"></div>
        </div>
        <div class="hint" id="claimHint">Claiming uses the server to ensure uniqueness & cooldowns.</div>
      </div>

      <div id="signinArea" style="margin-top:12px;"></div>
      <div id="errorArea" style="margin-top:12px;"></div>
    </div>
  </div>

  <script type="module">
    // Robust dev.html: dynamic import of your firebase.js (preferred), with modular fallbacks.
    import {
      getAuth as sdkGetAuth,
      GoogleAuthProvider,
      signInWithPopup,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    import {
      getFirestore as sdkGetFirestore,
      doc as sdkDoc,
      getDoc as sdkGetDoc
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    import {
      getFunctions as sdkGetFunctions,
      httpsCallable as sdkHttpsCallable
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-functions.js";

    // Utility: query path for requested username (first path segment)
    const pathParts = window.location.pathname.split('/').filter(Boolean);
    const requested = pathParts[0] || null; // e.g., "iii_dev"

    // UI references
    const loading = document.getElementById('loading');
    const profileTemplate = document.getElementById('profileTemplate');
    const avatarEl = document.getElementById('avatar');
    const displayNameEl = document.getElementById('displayName');
    const usernameLine = document.getElementById('usernameLine');
    const badgesEl = document.getElementById('badges');
    const bioEl = document.getElementById('bio');
    const actionsEl = document.getElementById('actions');
    const ownerControls = document.getElementById('ownerControls');
    const claimBtn = document.getElementById('claimBtn');
    const newUsernameInput = document.getElementById('newUsername');
    const copyLinkBtn = document.getElementById('copyLinkBtn');
    const ownerInfo = document.getElementById('ownerInfo');
    const signinArea = document.getElementById('signinArea');
    const errorArea = document.getElementById('errorArea');

    // variables set after firebase import
    let firebaseApp = null;
    let auth = null;
    let db = null;
    let functions = null;
    let createUsernameCallable = null;

    // Try to dynamically import your firebase.js and adapt to common export patterns.
    async function loadFirebaseGlue() {
      try {
        const mod = await import('./js/firebase.js');
        // try common export names
        firebaseApp = mod.firebase || mod.app || mod.firebaseApp || mod.default || null;

        // auth / db / functions preferred exported
        auth = mod.auth || mod.getAuth || null;
        db = mod.db || mod.getFirestore || null;
        functions = mod.functions || mod.getFunctions || null;

        // If any are functions (getAuth/getFirestore/getFunctions), call them with the app if available.
        if (typeof auth === 'function' && firebaseApp) auth = auth(firebaseApp);
        if (typeof db === 'function' && firebaseApp) db = db(firebaseApp);
        if (typeof functions === 'function' && firebaseApp) functions = functions(firebaseApp);

        // If exports not provided, fall back to SDK initializers which require firebaseApp to exist
        if (!auth && firebaseApp) auth = sdkGetAuth(firebaseApp);
        if (!db && firebaseApp) db = sdkGetFirestore(firebaseApp);
        if (!functions && firebaseApp) functions = sdkGetFunctions(firebaseApp);

        // If still missing firebaseApp (some firebase.js simply exported auth/db directly),
        // try to read firebaseApp from default export subfields
        if (!firebaseApp && mod.default && typeof mod.default === 'object') {
          firebaseApp = mod.default.app || mod.default.firebaseApp || null;
        }

        // Last fallback: if any of auth/db/functions still missing, attempt SDK without app (this requires firebase.js to have initialized default app elsewhere)
        if (!auth) try { auth = sdkGetAuth(); } catch(e){ /* ignore */ }
        if (!db) try { db = sdkGetFirestore(); } catch(e){ /* ignore */ }
        if (!functions) try { functions = sdkGetFunctions(); } catch(e){ /* ignore */ }

        // If functions is present, create the callable wrapper
        if (functions) {
          createUsernameCallable = sdkHttpsCallable(functions, 'createOrChangeUsername');
        }

        // final check
        if (!db || !auth || !functions) {
          showError(`firebase.js did not expose the required exports (auth, db, functions).
Please ensure ./js/firebase.js exports at least auth, db, and functions (or initializes the default app).`);
          throw new Error("Missing firebase exports");
        }

        return { auth, db, functions };
      } catch (err) {
        // if dynamic import fails, inform the user
        console.error('Failed to import ./js/firebase.js or initialize Firebase:', err);
        showError('Failed to load ./js/firebase.js or Firebase SDK. Make sure that file exists and exports auth, db, and functions (or that it initializes the default app). Check browser console for details.');
        throw err;
      }
    }

    function showError(msg) {
      errorArea.innerHTML = `<div class="error">${escapeHtml(msg)}</div>`;
    }
    function escapeHtml(s) { return String(s).replace(/[&<>"']/g, (m)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

    // read mapping: /usernames/{name} -> { uid }
    async function fetchProfileByUsername(name) {
      if (!name) return null;
      try {
        const usernameRef = sdkDoc(db, 'usernames', name);
        const mappingSnap = await sdkGetDoc(usernameRef);
        if (!mappingSnap.exists()) return null;
        const data = mappingSnap.data();
        const uid = data.uid;
        if (!uid) return null;
        const profileRef = sdkDoc(db, 'profiles', uid);
        const profSnap = await sdkGetDoc(profileRef);
        if (!profSnap.exists()) return null;
        return { uid, ...(profSnap.data()) };
      } catch (err) {
        console.error('fetchProfileByUsername error', err);
        showError('Error reading profile. Check Firestore rules / read permissions. See console for details.');
        return null;
      }
    }

    function showProfile(p) {
      loading.style.display = 'none';
      profileTemplate.style.display = 'block';
      avatarEl.textContent = (p.displayName || p.username || '').slice(0,2).toUpperCase();
      displayNameEl.textContent = p.displayName || ("Player " + (p.uid ? p.uid.slice(0,6) : 'unknown'));
      if (p.username) {
        usernameLine.innerHTML = `<span class="username-url" title="Open profile" onclick="window.location.href='/${encodeURIComponent(p.username)}'">/${escapeHtml(p.username)}</span>`;
      } else {
        usernameLine.innerHTML = `<em>no username set</em>`;
      }

      badgesEl.innerHTML = '';
      (p.badges || []).forEach(b => {
        const bEl = document.createElement('span');
        bEl.className = 'badge';
        bEl.textContent = b;
        badgesEl.appendChild(bEl);
      });

      bioEl.textContent = p.bio || '';

      // public actions
      actionsEl.innerHTML = '';
      const openBtn = document.createElement('button');
      openBtn.className = 'btn secondary';
      openBtn.textContent = 'Open in new tab';
      openBtn.onclick = () => window.open(location.origin + '/' + (p.username || p.uid), '_blank');
      actionsEl.appendChild(openBtn);

      // owner controls visibility handled elsewhere based on auth state
      ownerControls.style.display = 'none';
    }

    // Initialize page: load firebase, then show profile or available UI
    async function init() {
      try {
        await loadFirebaseGlue(); // sets db, auth, functions, createUsernameCallable
      } catch (err) {
        loading.textContent = 'Failed to load Firebase. See error message below.';
        return;
      }

      // show sign-in area and attach auth state watcher
      setupAuthUI();

      // initial profile attempt
      if (requested) {
        const profile = await fetchProfileByUsername(requested);
        if (profile) {
          showProfile(profile);
        } else {
          // username not claimed yet
          loading.style.display = 'none';
          profileTemplate.style.display = 'block';
          displayNameEl.textContent = 'No profile';
          usernameLine.innerHTML = `<span class="username-url">/${escapeHtml(requested)}</span> — available?`;
          badgesEl.innerHTML = '';
          bioEl.textContent = '';
          ownerControls.style.display = 'none'; // will show if owner is signed in
        }
      } else {
        // no username in path - minimal landing
        loading.style.display = 'none';
        profileTemplate.style.display = 'block';
        displayNameEl.textContent = 'Profile viewer';
        usernameLine.innerHTML = `<em>Enter a username in the URL (e.g. /iii_dev)</em>`;
        ownerControls.style.display = 'none';
      }
    }

    function setupAuthUI() {
      // create sign-in button area
      signinArea.innerHTML = `
        <div class="signin" id="signinLine">
          <button class="btn" id="googleSignBtn">Sign in with Google</button>
          <div class="small" id="signedAs"></div>
        </div>
      `;
      const googleSignBtn = document.getElementById('googleSignBtn');
      const signedAs = document.getElementById('signedAs');

      googleSignBtn.onclick = async () => {
        try {
          const provider = new GoogleAuthProvider();
          await signInWithPopup(auth, provider);
        } catch (err) {
          console.error('Sign-in error', err);
          showError('Sign-in failed: ' + (err.message || err.code || 'unknown'));
        }
      };

      onAuthStateChanged(auth, async (user) => {
        if (user) {
          signedAs.textContent = `Signed in as ${user.email || user.uid}`;
          googleSignBtn.style.display = 'none';
          // if the requested username is available and the signed-in user wants to claim, show ownerControls
          const profile = requested ? await fetchProfileByUsername(requested) : null;
          if (!requested) {
            // if visiting without username, owner controls remain hidden
            ownerControls.style.display = 'none';
          } else if (!profile) {
            // username is available — allow claim
            ownerControls.style.display = 'block';
            newUsernameInput.value = requested;
            ownerInfo.textContent = `You are logged in as ${user.email || user.uid}.`;
          } else {
            // profile exists: if current user is the owner, show controls to change username
            if (profile.uid === user.uid) {
              ownerControls.style.display = 'block';
              ownerInfo.textContent = `You can change username once every 15 days (unless admin). Current: ${profile.username || '(none)'}`;
              newUsernameInput.value = profile.username || requested;
            } else {
              ownerControls.style.display = 'none';
            }
          }
        } else {
          signedAs.textContent = '';
          googleSignBtn.style.display = 'inline-block';
          ownerControls.style.display = 'none';
        }
      }, (err) => {
        console.error('onAuthStateChanged error', err);
      });
    }

    // Wire the copy link button
    copyLinkBtn.onclick = () => {
      const u = location.origin + '/' + (requested || '');
      navigator.clipboard.writeText(u).then(()=> {
        copyLinkBtn.textContent = 'Copied!';
        setTimeout(()=> copyLinkBtn.textContent = 'Copy profile link', 1500);
      }).catch(err => {
        showError('Copy failed: ' + (err.message || err));
      });
    };

    // Claim button: IMPORTANT — uses the Callable function createOrChangeUsername
    claimBtn.onclick = async () => {
      const v = newUsernameInput.value.trim();
      if (!v) return alert('Enter a username');
      if (!/^[a-zA-Z0-9_.-]{3,30}$/.test(v)) return alert('Bad username format (3-30 chars letters/numbers/_/./-)');

      claimBtn.disabled = true;
      claimBtn.textContent = 'Claiming…';
      errorArea.innerHTML = '';

      try {
        if (!createUsernameCallable) {
          throw new Error('Callable function not available. Ensure functions are initialized and createOrChangeUsername deployed.');
        }
        const res = await createUsernameCallable({ username: v });
        // callable returns an object with data in res.data
        if (res && res.data && res.data.success) {
          alert('Username claimed: ' + res.data.username);
          // Redirect to new vanity URL
          window.location.href = '/' + encodeURIComponent(res.data.username);
        } else {
          // unpredictable response shape
          console.warn('Unexpected callable response', res);
          showError('Unexpected server response. Check console.');
        }
      } catch (err) {
        console.error('Claim error', err);
        // Extract helpful message where possible (functions returns errors differently)
        const msg = err?.message || err?.code || JSON.stringify(err);
        if (err?.code === 'permission-denied') {
          showError('Permission denied. Are you authenticated? Does your Cloud Function allow this user?');
        } else if (err?.code === 'already-exists') {
          showError('That username is already taken.');
        } else {
          showError('Claim failed: ' + msg);
        }
      } finally {
        claimBtn.disabled = false;
        claimBtn.textContent = 'Claim / Change Username';
      }
    };

    // boot
    init().catch(err => {
      console.error('init error', err);
    });
  </script>
</body>
</html>
