<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gomega — Profile / Username Manager</title>
  <style>
    :root { --accent:#1e88e5; --bg:#071023; --card:#0b1320; color-scheme: dark; }
    body { margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial; background: linear-gradient(180deg,#071023 0%, #071020 60%); color:#ddd; display:flex; min-height:100vh; align-items:center; justify-content:center; padding:24px; }
    .card { background:rgba(255,255,255,0.03); border-radius:12px; padding:20px; width:100%; max-width:980px; box-shadow: 0 8px 30px rgba(2,6,23,0.6); }
    .row { display:flex; gap:12px; align-items:center; }
    .profileHeader { display:flex; gap:18px; align-items:center; width:100%; }
    .avatar { width:110px; height:110px; border-radius:12px; background:linear-gradient(135deg,var(--accent),#8ab4ff); display:flex; align-items:center; justify-content:center; font-weight:700; font-size:36px; color:#021025; box-shadow:0 6px 20px rgba(0,0,0,0.6); }
    h1 { margin:0 0 6px 0; font-size:20px; color:#fff; }
    .username-url { color:var(--accent); font-weight:700; cursor:pointer; }
    .muted { color:#9aa6b2; }
    .badges { margin-top:8px; display:flex; gap:8px; flex-wrap:wrap; }
    .badge { background:rgba(255,255,255,0.04); padding:6px 8px; border-radius:8px; font-size:13px; display:inline-flex; gap:8px; align-items:center; }
    .btn { background:var(--accent); color:white; border:none; padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:600; }
    .btn.secondary { background:transparent; border:1px solid rgba(255,255,255,0.06); color: #dceeff; }
    input[type="text"], input[type="search"] { padding:8px 10px; border-radius:8px; border:1px solid rgba(255,255,255,0.06); background:transparent; color:inherit; width:260px; }
    .note { font-size:13px; color:#9aa6b2; margin-top:6px; }
    .grid { display:grid; grid-template-columns: 1fr 380px; gap:18px; }
    @media (max-width:900px) { .grid { grid-template-columns: 1fr; } .avatar { width:76px; height:76px; font-size:20px; } }
    .adminPanel { margin-top:12px; background: rgba(255,255,255,0.02); padding:12px; border-radius:8px; }
    .center { text-align:center; }
    .small { font-size:13px; color:#aaa; }
    .danger { background:#7b2121; }
    .sugg { color: #cbd8e6; font-size:13px; cursor:pointer; text-decoration:underline; }
  </style>
</head>
<body>
  <div class="card" id="root">
    <div class="grid">
      <div>
        <div id="loading" class="center">Loading…</div>

        <div id="profileCard" style="display:none">
          <div class="profileHeader">
            <div class="avatar" id="avatar">GK</div>
            <div style="flex:1">
              <h1 id="displayName">User</h1>
              <div id="usernameLine" class="muted">/username</div>
              <div class="badges" id="badges"></div>
              <div class="note" id="bio">Profile bio…</div>
            </div>

            <div style="display:flex; flex-direction:column; gap:8px; align-items:flex-end;">
              <div id="publicActions"></div>
              <div class="small muted">UID: <span id="uidShort"></span></div>
            </div>
          </div>

          <hr style="margin:14px 0; border:none; height:1px; background: rgba(255,255,255,0.03)">

          <div id="ownerControls" style="display:none">
            <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap">
              <input id="usernameInput" placeholder="pick username (3-30 chars)" />
              <button class="btn" id="claimBtn">Claim / Change</button>
              <button class="btn secondary" id="copyBtn">Copy profile link</button>
            </div>
            <div class="note" id="ownerNote"></div>
            <div style="margin-top:10px;" id="suggestions"></div>
          </div>

          <div id="anonPrompt" style="display:none; margin-top:12px;">
            <div class="note">You aren't signed in. <button class="btn secondary" id="signinBtn">Sign in with Google</button></div>
          </div>

        </div>
      </div>

      <div>
        <div class="card" style="padding:12px; box-shadow:none; background:transparent;">
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <div><strong>Profile Manager</strong></div>
            <div><span class="muted" id="loggedInAs">—</span></div>
          </div>

          <div style="margin-top:10px;">
            <div class="note">Open <code>gomega.watch/&lt;username&gt;</code> to view a profile. Use this page to claim and manage your username and badges.</div>
          </div>

          <div style="margin-top:10px;">
            <div style="display:flex; gap:8px;">
              <input id="lookupInput" placeholder="Lookup username or UID" />
              <button class="btn secondary" id="lookupBtn">Lookup</button>
            </div>
            <div class="note" id="lookupResult"></div>
          </div>

          <div class="adminPanel" id="adminPanel" style="display:none;">
            <div style="display:flex; gap:8px; align-items:center;">
              <input id="adminUid" placeholder="target UID" />
              <input id="adminBadge" placeholder="badge id (e.g. founder)" />
              <button class="btn" id="assignBadgeBtn">Assign badge</button>
              <button class="btn danger" id="removeBadgeBtn">Remove badge</button>
            </div>
            <div class="note">Admins can add/remove badges. (Requires admin claim or special email.)</div>
          </div>

        </div>

        <div style="margin-top:12px;">
          <div class="small muted">Reserved names: <span id="reservedList">admin, moderator, support, www, api</span></div>
        </div>

      </div>
    </div>
  </div>

  <script type="module">
  (async function main(){
    // CONFIG: reserved names & regex
    const RESERVED = new Set(["admin","administrator","mod","moderator","support","www","api","firebase","null","undefined"]);
    const NAME_RE = /^[a-zA-Z0-9_.-]{3,30}$/;
    const COOLDOWN_DAYS = 15;
    const specialAdminEmail = "gomegaassist@gmail.com";

    // dynamic import of your firebase.js (you said you won't change it)
    let fb;
    try {
      fb = await import('./js/firebase.js');
    } catch (e) {
      console.error("Could not import ./js/firebase.js — make sure it exists and is a module that exports auth and db.", e);
      document.getElementById('root').innerHTML = '<div class="center">Error: cannot load ./js/firebase.js. Make sure the file exists and exports auth and db.</div>';
      return;
    }

    // extract auth & db in a flexible way (support multiple export shapes)
    let auth = fb.auth || (fb.getAuth ? fb.getAuth() : null);
    let db = fb.db || (fb.getFirestore ? fb.getFirestore() : null);

    // if not exported as named values, check for default firebase object
    if (!auth && fb.firebase && fb.firebase.auth) {
      auth = fb.firebase.auth();
    }
    if (!db && fb.firebase && fb.firebase.firestore) {
      db = fb.firebase.firestore();
    }

    if (!auth || !db) {
      console.error("firebase.js did not expose 'auth' or 'db'. Please export them. Example: export const auth = getAuth(); export const db = getFirestore();");
      document.getElementById('root').innerHTML = '<div class="center">Error: firebase.js must export auth and db (see console).</div>';
      return;
    }

    // Import Firestore helpers from modular SDK (these functions don't re-init app)
    const {
      doc, getDoc, setDoc, deleteDoc, serverTimestamp, runTransaction, updateDoc, arrayUnion, arrayRemove, query, where, collection, limit, getDocs
    } = await import("https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js");

    const { GoogleAuthProvider, signInWithPopup, onAuthStateChanged, getIdTokenResult } =
      await import("https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js");

    // UI refs
    const loading = document.getElementById('loading');
    const profileCard = document.getElementById('profileCard');
    const avatar = document.getElementById('avatar');
    const displayName = document.getElementById('displayName');
    const usernameLine = document.getElementById('usernameLine');
    const badgesEl = document.getElementById('badges');
    const bioEl = document.getElementById('bio');
    const uidShort = document.getElementById('uidShort');
    const publicActions = document.getElementById('publicActions');
    const ownerControls = document.getElementById('ownerControls');
    const anonPrompt = document.getElementById('anonPrompt');
    const usernameInput = document.getElementById('usernameInput');
    const claimBtn = document.getElementById('claimBtn');
    const copyBtn = document.getElementById('copyBtn');
    const ownerNote = document.getElementById('ownerNote');
    const suggestionsDiv = document.getElementById('suggestions');
    const signinBtn = document.getElementById('signinBtn');
    const loggedInAs = document.getElementById('loggedInAs');

    const lookupInput = document.getElementById('lookupInput');
    const lookupBtn = document.getElementById('lookupBtn');
    const lookupResult = document.getElementById('lookupResult');

    const adminPanel = document.getElementById('adminPanel');
    const adminUid = document.getElementById('adminUid');
    const adminBadge = document.getElementById('adminBadge');
    const assignBadgeBtn = document.getElementById('assignBadgeBtn');
    const removeBadgeBtn = document.getElementById('removeBadgeBtn');

    const pathParts = window.location.pathname.split('/').filter(Boolean);
    const requested = pathParts[0] || null; // desired username from URL

    // Helpers
    function shortUid(u){ return u ? u.slice(0,6) : ''; }
    function originLink(u){ return location.origin + '/' + encodeURIComponent(u); }
    function isValidName(n){ return NAME_RE.test(n) && !RESERVED.has(n.toLowerCase()); }

    async function isAdminUser(user) {
      if (!user) return false;
      try {
        const token = await getIdTokenResult(user);
        if (token && token.claims && token.claims.admin) return true;
      } catch(e){ /* ignore */ }
      if ((user.email || '').toLowerCase() === specialAdminEmail.toLowerCase()) return true;
      return false;
    }

    // Fetch profile by username mapping
    async function fetchProfileByUsername(name) {
      if (!name) return null;
      const mappingRef = doc(db, 'usernames', name);
      const mappingSnap = await getDoc(mappingRef);
      if (!mappingSnap.exists()) return null;
      const { uid } = mappingSnap.data();
      const profRef = doc(db, 'profiles', uid);
      const profSnap = await getDoc(profRef);
      if (!profSnap.exists()) return { uid, username:name };
      return { uid, ...profSnap.data() };
    }

    // Render profile
    async function showProfile(profile) {
      loading.style.display='none';
      profileCard.style.display='block';
      avatar.textContent = (profile.displayName || profile.username || profile.uid).slice(0,2).toUpperCase();
      displayName.textContent = profile.displayName || ('Player ' + shortUid(profile.uid));
      usernameLine.innerHTML = profile.username ? `<span class="username-url" onclick="window.open('${originLink(profile.username)}','_self')">/${profile.username}</span>` : `<em class="muted">no username</em>`;
      badgesEl.innerHTML = '';
      (profile.badges || []).forEach(b => {
        const el = document.createElement('span'); el.className='badge'; el.textContent = b; badgesEl.appendChild(el);
      });
      bioEl.textContent = profile.bio || '';
      uidShort.textContent = shortUid(profile.uid);

      publicActions.innerHTML = '';
      const openBtn = document.createElement('button');
      openBtn.className='btn secondary'; openBtn.textContent = 'Open in new tab';
      openBtn.onclick = ()=> window.open(originLink(profile.username || profile.uid), '_blank');
      publicActions.appendChild(openBtn);
    }

    // Create profile doc if missing (owner-only call)
    async function ensureProfileExists(uid){
      const ref = doc(db, 'profiles', uid);
      const snap = await getDoc(ref);
      if (!snap.exists()) {
        await setDoc(ref, {
          createdAt: serverTimestamp(),
          displayName: '',
          badges: []
        }, { merge: true });
      }
    }

    // Core: client-side transaction to claim/change username
    async function claimUsernameAtomic(uid, desiredName, isAdminFlag=false) {
      if (!desiredName) throw new Error('no username');
      if (!NAME_RE.test(desiredName)) throw new Error('bad format');
      if (RESERVED.has(desiredName.toLowerCase())) throw new Error('reserved');

      const usernameRef = doc(db, 'usernames', desiredName);
      const profileRef = doc(db, 'profiles', uid);

      return await runTransaction(db, async (tx) => {
        const usernameSnap = await tx.get(usernameRef);
        if (usernameSnap.exists()) throw new Error('username_taken');

        const profileSnap = await tx.get(profileRef);
        const profileData = profileSnap.exists() ? profileSnap.data() : {};

        // cooldown check (unless admin)
        if (!isAdminFlag && profileData.lastUsernameChange) {
          const last = profileData.lastUsernameChange.toDate();
          const diffDays = (Date.now() - last.getTime()) / (1000*60*60*24);
          if (diffDays < COOLDOWN_DAYS) throw new Error('cooldown');
        }

        // delete old mapping if exists
        if (profileData.username) {
          const oldName = profileData.username;
          const oldRef = doc(db, 'usernames', oldName);
          // ensure oldRef was owned by uid before deleting
          const oldSnap = await tx.get(oldRef);
          if (oldSnap.exists() && oldSnap.data().uid === uid) {
            tx.delete(oldRef);
          } else {
            // if mismatch, don't delete
          }
        }

        // create new mapping and update profile
        tx.set(usernameRef, { uid: uid, createdAt: serverTimestamp() });
        tx.set(profileRef, { username: desiredName, lastUsernameChange: serverTimestamp() }, { merge: true });

        return { username: desiredName };
      });
    }

    // Admin badge functions
    async function adminAssignBadge(targetUid, badgeId) {
      if (!targetUid || !badgeId) throw new Error('missing params');
      const profileRef = doc(db, 'profiles', targetUid);
      await updateDoc(profileRef, { badges: arrayUnion(badgeId) });
      return true;
    }
    async function adminRemoveBadge(targetUid, badgeId) {
      if (!targetUid || !badgeId) throw new Error('missing params');
      const profileRef = doc(db, 'profiles', targetUid);
      await updateDoc(profileRef, { badges: arrayRemove(badgeId) });
      return true;
    }

    // lookup helpers
    async function lookupByUid(uid) {
      if(!uid) return null;
      const ref = doc(db, 'profiles', uid);
      const snap = await getDoc(ref);
      if (!snap.exists()) return null;
      return { uid, ...snap.data() };
    }

    async function suggestAlternatives(name, count=4) {
      // simple suggestions: append numbers or underscores
      const base = name.replace(/[^a-zA-Z0-9_.-]/g,'').slice(0,20);
      const arr = [];
      for (let i=1;i<=count;i++){
        arr.push(base + '_' + i);
        if (arr.length>=count) break;
      }
      return arr;
    }

    // wire events
    claimBtn.onclick = async () => {
      const v = usernameInput.value.trim();
      if (!v) return alert('enter username');
      if (!NAME_RE.test(v)) return alert('bad format (3-30 a-zA-Z0-9_.-)');
      if (RESERVED.has(v.toLowerCase())) return alert('reserved username');

      claimBtn.disabled = true;
      claimBtn.textContent = 'Claiming…';
      try {
        const user = auth.currentUser;
        if (!user) throw new Error('signin_required');
        const isAdminFlag = await isAdminUser(user);
        await ensureProfileExists(user.uid);
        await claimUsernameAtomic(user.uid, v, isAdminFlag);
        alert('Username claimed: ' + v);
        window.location.href = '/' + encodeURIComponent(v);
      } catch (err) {
        console.error(err);
        if (err.message === 'username_taken') {
          alert('That username is already taken. Suggestions shown below.');
          const sugg = await suggestAlternatives(v);
          suggestionsDiv.innerHTML = 'Suggestions: ' + sugg.map(s => `<span class="sugg" data-s="${s}">${s}</span>`).join(' ');
          document.querySelectorAll('.sugg').forEach(el => el.onclick = ()=> { usernameInput.value = el.dataset.s; suggestionsDiv.innerHTML=''; });
        } else if (err.message === 'cooldown') {
          alert(`You can only change username once every ${COOLDOWN_DAYS} days (unless admin).`);
        } else if (err.message === 'signin_required') {
          alert('Please sign in first.');
        } else {
          alert('Error: ' + (err.message || JSON.stringify(err)));
        }
      } finally {
        claimBtn.disabled = false;
        claimBtn.textContent = 'Claim / Change';
      }
    };

    copyBtn.onclick = () => {
      const url = originLink(requested || usernameInput.value || '');
      navigator.clipboard.writeText(url).then(()=> {
        copyBtn.textContent = 'Copied!';
        setTimeout(()=> copyBtn.textContent='Copy profile link', 1400);
      });
    };

    signinBtn.onclick = async () => {
      const provider = new GoogleAuthProvider();
      try {
        await signInWithPopup(auth, provider);
      } catch(e){ console.error(e); alert('Sign in failed: ' + (e.message||e)); }
    };

    lookupBtn.onclick = async () => {
      const q = lookupInput.value.trim();
      lookupResult.textContent = 'Searching…';
      try {
        if (!q) return lookupResult.textContent = '';
        // if q matches username pattern, try username mapping
        if (/^[a-zA-Z0-9_.-]{3,30}$/.test(q)) {
          const p = await fetchProfileByUsername(q);
          if (!p) return lookupResult.textContent = 'No profile for that username.';
          lookupResult.textContent = `Found: UID ${p.uid}, username ${p.username || '(none)'}`;
          return;
        }
        // else treat as uid
        const p = await lookupByUid(q);
        if (!p) return lookupResult.textContent = 'No profile for that UID.';
        lookupResult.textContent = `Found: UID ${p.uid}, username ${p.username || '(none)'}`;
      } catch (e) {
        console.error(e);
        lookupResult.textContent = 'Error: ' + (e.message || e);
      }
    };

    assignBadgeBtn.onclick = async () => {
      const target = adminUid.value.trim();
      const b = adminBadge.value.trim();
      if(!target||!b) return alert('need uid and badge id');
      try {
        await adminAssignBadge(target,b);
        alert('Assigned '+b);
      } catch(e){ console.error(e); alert('Error: ' + (e.message||e)); }
    };
    removeBadgeBtn.onclick = async () => {
      const target = adminUid.value.trim();
      const b = adminBadge.value.trim();
      if(!target||!b) return alert('need uid and badge id');
      try {
        await adminRemoveBadge(target,b);
        alert('Removed '+b);
      } catch(e){ console.error(e); alert('Error: ' + (e.message||e)); }
    };

    // Auth watcher and initial rendering
    let currentUser = auth.currentUser || null;
    async function renderForUser(user) {
      currentUser = user;
      const adminFlag = user ? await isAdminUser(user) : false;
      loggedInAs.textContent = user ? `Signed in as ${user.email || shortUid(user.uid)}${adminFlag ? ' (admin)' : ''}` : 'Not signed in';
      adminPanel.style.display = adminFlag ? 'block' : 'none';

      if (!user) {
        anonPrompt.style.display='block';
        ownerControls.style.display='none';
      } else {
        anonPrompt.style.display='none';
        ownerControls.style.display='block';
        usernameInput.value = requested || '';
      }
    }

    onAuthStateChanged(auth, user => {
      renderForUser(user).catch(console.error);
      // Re-init view on change
      initView().catch(console.error);
    });

    // initial view
    async function initView(){
      loading.style.display='block';
      profileCard.style.display='none';
      // if requested username in path, try load
      if (requested) {
        const p = await fetchProfileByUsername(requested);
        if (!p) {
          loading.textContent = `No profile found for /${requested}. You can claim it if available.`;
          profileCard.style.display = 'block';
          displayName.textContent = 'No profile';
          usernameLine.innerHTML = `<span class="username-url">/${requested}</span> — available?`;
          badgesEl.innerHTML = '';
          ownerNote.textContent = '';
          // show controls depending on auth
          if (auth.currentUser) {
            ownerControls.style.display='block';
            usernameInput.value = requested;
            ownerNote.textContent = `You are signed in as ${auth.currentUser.email || shortUid(auth.currentUser.uid)}. Claiming will map this username to your UID.`;
          } else {
            anonPrompt.style.display='block';
            ownerControls.style.display='none';
          }
          loading.style.display='none';
          profileCard.style.display='block';
          return;
        }
        // if profile exists
        await showProfile(p);
      } else {
        // no requested username: show current user's profile if signed in
        if (auth.currentUser) {
          const p = await lookupByUid(auth.currentUser.uid);
          if (p) {
            await showProfile(p);
          } else {
            // create UI for creating a profile
            loading.textContent = 'No profile data yet. You can claim a username and create a profile.';
            profileCard.style.display='block';
            displayName.textContent = 'No profile';
            usernameLine.innerHTML = `<em class="muted">no username</em>`;
            badgesEl.innerHTML = '';
            ownerControls.style.display='block';
            usernameInput.value = '';
            ownerNote.textContent = `You are signed in as ${auth.currentUser.email || shortUid(auth.currentUser.uid)}.`;
          }
        } else {
          // not signed in, show prompt
          loading.textContent = 'Enter a username in the URL (e.g. /iii_dev) or sign in to manage your profile.';
          profileCard.style.display='block';
          anonPrompt.style.display='block';
          ownerControls.style.display='none';
        }
      }
      loading.style.display='none';
    }

    // initial render
    await renderForUser(auth.currentUser);
    await initView();

    // expose some debug helpers to console for admin convenience
    window._gomega = {
      claimUsernameAtomic, fetchProfileByUsername, lookupByUid, suggestAlternatives
    };

  })();
  </script>
</body>
</html>
