<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gomega — Profile</title>
  <style>
    :root { --accent:#1e88e5; --bg:#071022; --card:#071827; color-scheme: dark; }
    body { margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial; background: linear-gradient(180deg,#071023 0%, #071020 60%); color:#ddd; display:flex; min-height:100vh; align-items:center; justify-content:center; padding:24px; }
    .card { background:rgba(255,255,255,0.03); border-radius:12px; padding:20px; width:100%; max-width:920px; box-shadow: 0 8px 30px rgba(2,6,23,0.6); }
    .profile { display:flex; gap:18px; align-items:center; }
    .avatar { width:110px; height:110px; border-radius:12px; background:linear-gradient(135deg,var(--accent),#8ab4ff); display:flex; align-items:center; justify-content:center; font-weight:700; font-size:36px; color:#021025; box-shadow:0 6px 20px rgba(0,0,0,0.6); }
    .meta { flex:1; }
    h1 { margin:0 0 6px 0; font-size:20px; }
    .username-url { color:var(--accent); font-weight:600; cursor:pointer; user-select:none; }
    .badges { margin-top:8px; display:flex; gap:8px; flex-wrap:wrap; }
    .badge { background:rgba(255,255,255,0.04); padding:6px 8px; border-radius:8px; font-size:13px; display:inline-flex; gap:8px; align-items:center; }
    .actions { margin-left:auto; display:flex; gap:8px; }
    .btn { background:var(--accent); color:white; border:none; padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:600; }
    .btn.secondary { background:transparent; border:1px solid rgba(255,255,255,0.06); color:inherit; }
    .small { font-size:13px; color:#aaa; margin-top:6px; }
    .center { text-align:center; padding:20px; }
    input[type="text"] { padding:8px 10px; border-radius:8px; border:1px solid rgba(255,255,255,0.06); background:transparent; color:inherit; width:260px; }
    .signin { display:flex; gap:8px; align-items:center; }
    .hint { margin-top:10px; color:#9aa7b2; font-size:13px; }
    .error { color:#ff7b7b; font-weight:700; }
    .muted { color:#98a6b3; font-size:13px; }
    @media (max-width:600px) {
      .profile { flex-direction:column; align-items:flex-start; }
      .actions { margin-left:0; width:100%; }
    }
  </style>
</head>
<body>
  <div class="card" id="root">
    <div id="loading" class="center">Loading profile…</div>

    <div id="profileTemplate" style="display:none">
      <div class="profile">
        <div class="avatar" id="avatar">GK</div>
        <div class="meta">
          <h1 id="displayName">User</h1>
          <div><span id="usernameLine"></span></div>
          <div class="badges" id="badges"></div>
          <div class="small" id="bio"></div>
        </div>

        <div class="actions" id="actions"></div>
      </div>

      <hr style="margin:16px 0; border:none; height:1px; background: rgba(255,255,255,0.03)">

      <div id="ownerControls" style="display:none">
        <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap">
          <input id="newUsername" placeholder="enter username (3-30 chars)" />
          <button class="btn" id="claimBtn">Claim / Change Username</button>
          <button class="btn secondary" id="copyLinkBtn">Copy profile link</button>
          <div class="small" id="ownerInfo"></div>
        </div>
        <div class="hint" id="claimHint">Claiming uses the server function to ensure uniqueness & cooldowns.</div>
      </div>

      <div id="signinArea" style="margin-top:12px"></div>
      <div id="errorArea" style="margin-top:12px"></div>
      <div id="debugArea" style="margin-top:8px" class="muted"></div>
    </div>
  </div>

  <script type="module">
  // =========
  // dev.html — single-file adapter for your existing ./js/firebase.js
  // Behavior:
  //  - Tries to import ./js/firebase.js and adapt to multiple export shapes
  //  - Locates auth, db, functions (via exports or SDK fallback)
  //  - Always calls the callable 'createOrChangeUsername' to claim usernames
  //  - Never writes /usernames/* directly from client
  // =========

  import { getAuth as sdkGetAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
  import { getFirestore as sdkGetFirestore, doc as sdkDoc, getDoc as sdkGetDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
  import { getFunctions as sdkGetFunctions, httpsCallable as sdkHttpsCallable } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-functions.js";

  // parse requested vanity from first path segment
  const pathParts = window.location.pathname.split('/').filter(Boolean);
  const requested = pathParts[0] || null;

  // UI elements
  const loading = document.getElementById('loading');
  const profileTemplate = document.getElementById('profileTemplate');
  const avatarEl = document.getElementById('avatar');
  const displayNameEl = document.getElementById('displayName');
  const usernameLine = document.getElementById('usernameLine');
  const badgesEl = document.getElementById('badges');
  const bioEl = document.getElementById('bio');
  const actionsEl = document.getElementById('actions');
  const ownerControls = document.getElementById('ownerControls');
  const claimBtn = document.getElementById('claimBtn');
  const newUsernameInput = document.getElementById('newUsername');
  const copyLinkBtn = document.getElementById('copyLinkBtn');
  const ownerInfo = document.getElementById('ownerInfo');
  const signinArea = document.getElementById('signinArea');
  const errorArea = document.getElementById('errorArea');
  const debugArea = document.getElementById('debugArea');
  const claimHint = document.getElementById('claimHint');

  // runtime references (populated by loader)
  let firebaseApp = null;
  let auth = null;
  let db = null;
  let functions = null;
  let createUsernameCallable = null;

  // helper UI functions
  function setDebug(txt) { debugArea.textContent = txt || ''; }
  function showError(msg) { errorArea.innerHTML = `<div class="error">${escapeHtml(msg)}</div>`; }
  function clearError() { errorArea.innerHTML = ''; }
  function escapeHtml(s) { return String(s).replace(/[&<>"']/g, (m)=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

  // robust loader: tries multiple patterns so you don't need to change your firebase.js
  async function loadFirebaseCompat() {
    try {
      // try dynamic import of user's firebase.js
      const mod = await import('./js/firebase.js');

      // 1) If file exports named auth/db/functions directly, use them
      if (mod.auth && mod.db && mod.functions) {
        auth = mod.auth;
        db = mod.db;
        functions = mod.functions;
        firebaseApp = mod.firebaseApp || mod.app || mod.default || null;
        setDebug('Loaded named exports from ./js/firebase.js');
      } else {
        // 2) try defaults and common variations
        firebaseApp = mod.firebaseApp || mod.app || mod.firebase || mod.default || null;

        // try common named exports
        auth = mod.auth || mod.getAuth || null;
        db = mod.db || mod.getFirestore || null;
        functions = mod.functions || mod.getFunctions || null;

        // If any of auth/db/functions are functions (getAuth/getFirestore/getFunctions), call them with app if possible
        if (typeof auth === 'function' && firebaseApp) {
          try { auth = auth(firebaseApp); } catch(e) { /* ignore */ }
        }
        if (typeof db === 'function' && firebaseApp) {
          try { db = db(firebaseApp); } catch(e) { /* ignore */ }
        }
        if (typeof functions === 'function' && firebaseApp) {
          try { functions = functions(firebaseApp); } catch(e) { /* ignore */ }
        }

        // 3) fallback: if firebase.js only initialized default app, get SDK singletons
        if (!auth) {
          try { auth = sdkGetAuth(); setDebug((debugArea.textContent || '') + ' fallback: sdkGetAuth();'); } catch(e) {}
        }
        if (!db) {
          try { db = sdkGetFirestore(); setDebug((debugArea.textContent || '') + ' fallback: sdkGetFirestore();'); } catch(e) {}
        }
        if (!functions) {
          try { functions = sdkGetFunctions(); setDebug((debugArea.textContent || '') + ' fallback: sdkGetFunctions();'); } catch(e) {}
        }

        // 4) final attempt: if mod.default looks like an initialized app object, try using its services
        if ((!auth || !db || !functions) && firebaseApp) {
          try {
            if (!auth && typeof sdkGetAuth === 'function') auth = sdkGetAuth(firebaseApp);
            if (!db && typeof sdkGetFirestore === 'function') db = sdkGetFirestore(firebaseApp);
            if (!functions && typeof sdkGetFunctions === 'function') functions = sdkGetFunctions(firebaseApp);
          } catch(e) {}
        }
      }

      // Ensure we have at least auth+db
      if (!auth || !db) {
        throw new Error('Could not obtain auth and/or db from ./js/firebase.js. The page expects that file to initialize Firebase (default app) or export auth and db.');
      }

      // create callable if possible (functions may still be undefined if not exported and not available via SDK)
      if (functions && typeof sdkHttpsCallable === 'function') {
        try {
          createUsernameCallable = sdkHttpsCallable(functions, 'createOrChangeUsername');
          setDebug((debugArea.textContent || '') + ' httpsCallable available');
        } catch(e) {
          // ignore - we'll show message later
        }
      }

      return { auth, db, functions, createUsernameCallable, firebaseApp };
    } catch (err) {
      console.error('Failed to import ./js/firebase.js or initialize Firebase:', err);
      throw err;
    }
  }

  // read mapping usernames -> profile
  async function fetchProfileByUsername(name) {
    if (!name) return null;
    clearError();
    try {
      const ref = sdkDoc(db, 'usernames', name);
      const snap = await sdkGetDoc(ref);
      if (!snap.exists()) return null;
      const mapping = snap.data();
      if (!mapping || !mapping.uid) return null;
      const profileRef = sdkDoc(db, 'profiles', mapping.uid);
      const profSnap = await sdkGetDoc(profileRef);
      if (!profSnap.exists()) return null;
      return { uid: mapping.uid, ...profSnap.data() };
    } catch (err) {
      console.error('fetchProfileByUsername error', err);
      showError('Error reading profile — check Firestore read rules or see console.');
      return null;
    }
  }

  // small wrappers for the SDK functions used (these are imported from SDK above)
  // we reference them here to avoid relying on named imports earlier
  // but ensure sdkDoc & sdkGetDoc are available
  const sdkDoc = (db && db.doc) ? ((db, path, id) => db.doc(`${path}/${id}`)) : (function(dbRef, collection, id) { return (typeof window !== 'undefined' && typeof window.firebase !== 'undefined') ? window.firebase.firestore().doc(`${collection}/${id}`) : null; });
  // However, the above is fallback; we'll also use the modular doc/getDoc import directly if available:
  // to ensure we have modular doc/getDoc, import them here
  // (we already imported them at top of file)
  // Use the modular sdkDoc/sdkGetDoc imported at top-level via names:
  // Note: the top-level const names sdkDoc and sdkGetDoc are available (see imports)

  // show profile in UI
  function showProfile(p) {
    loading.style.display = 'none';
    profileTemplate.style.display = 'block';
    avatarEl.textContent = (p.displayName || p.username || '').slice(0,2).toUpperCase();
    displayNameEl.textContent = p.displayName || ("Player " + (p.uid ? p.uid.slice(0,6) : 'unknown'));
    if (p.username) {
      usernameLine.innerHTML = `<span class="username-url" title="Open profile" onclick="window.location.href='/${encodeURIComponent(p.username)}'">/${escapeHtml(p.username)}</span>`;
    } else {
      usernameLine.innerHTML = `<em>no username set</em>`;
    }
    badgesEl.innerHTML = '';
    (p.badges || []).forEach(b => {
      const bEl = document.createElement('span'); bEl.className='badge'; bEl.textContent = b; badgesEl.appendChild(bEl);
    });
    bioEl.textContent = p.bio || '';
    actionsEl.innerHTML = '';
    const openBtn = document.createElement('button'); openBtn.className = 'btn secondary'; openBtn.textContent = 'Open in new tab'; openBtn.onclick = () => window.open(location.origin + '/' + (p.username || p.uid), '_blank');
    actionsEl.appendChild(openBtn);
    ownerControls.style.display = 'none';
  }

  // setup auth UI and onAuthChanged behavior
  async function setupAuthAndUI(runtime) {
    const { auth } = runtime;
    // create sign-in UI
    signinArea.innerHTML = `<div class="signin"><button class="btn" id="googleSignBtn">Sign in with Google</button><div class="small" id="signedAs"></div></div>`;
    const googleSignBtn = document.getElementById('googleSignBtn');
    const signedAs = document.getElementById('signedAs');

    googleSignBtn.onclick = async () => {
      try {
        const provider = new GoogleAuthProvider();
        await signInWithPopup(auth, provider);
      } catch (err) {
        console.error('Sign-in failed', err);
        showError('Sign-in failed: ' + (err.message || err.code || 'unknown'));
      }
    };

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        signedAs.textContent = `Signed in as ${user.email || user.uid}`;
        googleSignBtn.style.display = 'none';
        // fetch profile by requested username
        const profile = requested ? await fetchProfileByUsername(requested) : null;
        if (!requested) {
          ownerControls.style.display = 'none';
        } else if (!profile) {
          // available -> allow claim
          ownerControls.style.display = 'block';
          newUsernameInput.value = requested;
          ownerInfo.textContent = `You are logged in as ${user.email || user.uid}`;
        } else {
          // claimed -> if owner show change UI
          if (profile.uid === user.uid) {
            ownerControls.style.display = 'block';
            ownerInfo.textContent = `You can change username once every 15 days (unless admin). Current: ${profile.username || '(none)'}`;
            newUsernameInput.value = profile.username || requested;
          } else {
            ownerControls.style.display = 'none';
          }
        }
      } else {
        signedAs.textContent = '';
        googleSignBtn.style.display = 'inline-block';
        ownerControls.style.display = 'none';
      }
    }, (err) => {
      console.error('onAuthStateChanged error', err);
      showError('Auth state error: ' + (err.message || err.code || 'unknown'));
    });
  }

  // claim flow: uses callable ONLY
  async function claimUsername(runtime, username) {
    clearError();
    if (!runtime.createUsernameCallable) {
      showError('Server function unavailable. The page expects a callable function named createOrChangeUsername. Check functions deployment.');
      return;
    }
    try {
      claimBtn.disabled = true;
      claimBtn.textContent = 'Claiming…';
      const res = await runtime.createUsernameCallable({ username });
      if (res && res.data && res.data.success) {
        // success: redirect to vanity URL
        window.location.href = '/' + encodeURIComponent(res.data.username);
      } else {
        console.warn('Unexpected callable response', res);
        showError('Unexpected server response. See console for details.');
      }
    } catch (err) {
      console.error('Claim error', err);
      // firebase functions errors often contain details in err.code or err.message
      const code = err?.code || '';
      const msg = err?.message || JSON.stringify(err);
      if (code === 'already-exists') showError('That username is already taken.');
      else if (code === 'failed-precondition') showError(msg);
      else if (code === 'permission-denied') showError('Permission denied. Are you signed in?');
      else showError('Claim failed: ' + msg);
    } finally {
      claimBtn.disabled = false;
      claimBtn.textContent = 'Claim / Change Username';
    }
  }

  // wire buttons
  function wireButtons(runtime) {
    copyLinkBtn.onclick = () => {
      const u = location.origin + '/' + (requested || '');
      navigator.clipboard.writeText(u).then(()=> {
        copyLinkBtn.textContent = 'Copied!';
        setTimeout(()=> copyLinkBtn.textContent = 'Copy profile link', 1500);
      }).catch(err => showError('Copy failed: ' + (err.message || err)));
    };

    claimBtn.onclick = async () => {
      const v = newUsernameInput.value.trim();
      if (!v) { alert('Enter username'); return; }
      if (!/^[a-zA-Z0-9_.-]{3,30}$/.test(v)) { alert('Bad username format (3-30 chars letters/numbers/_/./-)'); return; }
      await claimUsername(runtime, v);
    };
  }

  // main boot
  (async function boot() {
    try {
      const runtime = await loadFirebaseCompat();
      // runtime contains auth/db/functions/createUsernameCallable (if available)
      // Note: we rely on the modular SDK doc/getDoc functions we imported at top (sdkDoc/sdkGetDoc)
      // but the modular imports are already bound to the default SDK functions.
      // Show the profile or available UI
      if (requested) {
        const profile = await fetchProfileByUsername(requested);
        if (profile) {
          showProfile(profile);
        } else {
          // username unclaimed
          loading.style.display = 'none';
          profileTemplate.style.display = 'block';
          displayNameEl.textContent = 'No profile';
          usernameLine.innerHTML = `<span class="username-url">/${escapeHtml(requested)}</span> — available`;
          badgesEl.innerHTML = '';
          bioEl.textContent = '';
          ownerControls.style.display = 'none';
        }
      } else {
        loading.style.display = 'none';
        profileTemplate.style.display = 'block';
        displayNameEl.textContent = 'Profile viewer';
        usernameLine.innerHTML = `<em>Enter a username in the URL (e.g. /iii_dev)</em>`;
        ownerControls.style.display = 'none';
      }

      // show hint if callable missing
      if (!runtime.createUsernameCallable) {
        claimHint.textContent = 'Server function createOrChangeUsername not found. If you have that function deployed, make sure Functions are on the same project and region or that firebase.js exposes functions().';
        setDebug('createOrChangeUsername callable not found — page will not be able to claim usernames until function is reachable.');
      } else {
        claimHint.textContent = 'Claiming uses the server callable createOrChangeUsername.';
        setDebug('createOrChangeUsername callable ready.');
      }

      // setup auth UI and watchers
      await setupAuthAndUI(runtime);

      // wire the buttons (needs runtime for claim)
      // attach runtime.createUsernameCallable to runtime object so claim uses it
      runtime.createUsernameCallable = runtime.createUsernameCallable || null;
      wireButtons(runtime);

    } catch (err) {
      console.error('Boot error', err);
      loading.textContent = 'Failed to initialize page. See error message below.';
      showError('Initialization failed — check console. ' + (err.message || err));
    }
  })();

  </script>
</body>
</html>
