<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gomega — Profile (frontend-only)</title>
  <style>
    :root { --accent:#1e88e5; --bg:#071022; color-scheme: dark; }
    body { margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial; background: linear-gradient(180deg,#071023 0%, #071020 60%); color:#ddd; display:flex; min-height:100vh; align-items:center; justify-content:center; padding:20px; }
    .card { background:rgba(255,255,255,0.03); border-radius:12px; padding:18px; width:100%; max-width:880px; box-shadow: 0 8px 30px rgba(2,6,23,0.6); }
    .profile { display:flex; gap:18px; align-items:center; }
    .avatar { width:92px; height:92px; border-radius:12px; background:linear-gradient(135deg,var(--accent),#8ab4ff); display:flex; align-items:center; justify-content:center; font-weight:700; font-size:32px; color:#021025; box-shadow:0 6px 20px rgba(0,0,0,0.5); }
    .meta { flex:1; }
    h1 { margin:0 0 6px 0; font-size:20px; }
    .username-url { color:var(--accent); font-weight:600; cursor:pointer; user-select:none; }
    .badges { margin-top:8px; display:flex; gap:8px; flex-wrap:wrap; }
    .badge { background:rgba(255,255,255,0.04); padding:6px 8px; border-radius:8px; font-size:13px; display:inline-flex; align-items:center; }
    .actions { margin-left:auto; display:flex; gap:8px; }
    .btn { background:var(--accent); color:white; border:none; padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:600; }
    .btn.secondary { background:transparent; border:1px solid rgba(255,255,255,0.06); color:inherit; }
    .small { font-size:13px; color:#aaa; margin-top:6px; }
    .center { text-align:center; padding:20px; }
    input[type="text"] { padding:8px 10px; border-radius:8px; border:1px solid rgba(255,255,255,0.06); background:transparent; color:inherit; width:260px; }
    .hint { margin-top:10px; color:#9aa7b2; font-size:13px; }
    .error { color:#ff7b7b; font-weight:700; }
    .muted { color:#98a6b3; font-size:13px; }
    @media (max-width:600px) { .profile{flex-direction:column;align-items:flex-start} .actions{margin-left:0;width:100%} }
  </style>
</head>
<body>
  <div class="card" id="root">
    <div id="loading" class="center">Loading profile…</div>

    <div id="profileTemplate" style="display:none">
      <div class="profile">
        <div class="avatar" id="avatar">GK</div>
        <div class="meta">
          <h1 id="displayName">User</h1>
          <div><span id="usernameLine"></span></div>
          <div class="badges" id="badges"></div>
          <div class="small" id="bio"></div>
        </div>

        <div class="actions" id="actions"></div>
      </div>

      <hr style="margin:14px 0;border:none;height:1px;background: rgba(255,255,255,0.03)">

      <div id="ownerControls" style="display:none">
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <input id="newUsername" placeholder="enter username (3-30 chars)" />
          <button class="btn" id="claimBtn">Claim / Change Username</button>
          <button class="btn secondary" id="copyLinkBtn">Copy profile link</button>
          <div class="small" id="ownerInfo"></div>
        </div>
        <div class="hint" id="claimHint">This frontend-only version writes directly to Firestore. Ensure your Firestore rules allow authenticated writes to /usernames/* and /profiles/{uid}.</div>
      </div>

      <div id="signinArea" style="margin-top:12px"></div>
      <div id="errorArea" style="margin-top:12px"></div>
      <div id="debugArea" style="margin-top:8px" class="muted"></div>
    </div>
  </div>

  <script type="module">
  // ================
  // Frontend-only dev.html
  // - Replace the firebaseConfig object below with your Firebase project's config
  // - This file will sign in users and directly write /usernames and /profiles from the client
  // ================

  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
  import {
    getFirestore,
    doc,
    getDoc,
    runTransaction,
    serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  // ---- PASTE YOUR FIREBASE CONFIG BELOW ----
  const firebaseConfig = {
    apiKey: "AIzaSyCosaEc1xMspmr9Z0ykfI3_6Ksrp-3r5WM",
    authDomain: "gomega-65e3f.firebaseapp.com",
    projectId: "gomega-65e3f",
    storageBucket: "gomega-65e3f.appspot.com",
    messagingSenderId: "212961835634",
    appId: "1:212961835634:web:12330a07ff79668ea060eb"
  };
  // ------------------------------------------

  // UI refs
  const loading = document.getElementById('loading');
  const profileTemplate = document.getElementById('profileTemplate');
  const avatarEl = document.getElementById('avatar');
  const displayNameEl = document.getElementById('displayName');
  const usernameLine = document.getElementById('usernameLine');
  const badgesEl = document.getElementById('badges');
  const bioEl = document.getElementById('bio');
  const actionsEl = document.getElementById('actions');
  const ownerControls = document.getElementById('ownerControls');
  const claimBtn = document.getElementById('claimBtn');
  const newUsernameInput = document.getElementById('newUsername');
  const copyLinkBtn = document.getElementById('copyLinkBtn');
  const ownerInfo = document.getElementById('ownerInfo');
  const signinArea = document.getElementById('signinArea');
  const errorArea = document.getElementById('errorArea');
  const debugArea = document.getElementById('debugArea');
  const claimHint = document.getElementById('claimHint');

  const pathParts = window.location.pathname.split('/').filter(Boolean);
  const requested = pathParts[0] || null; // e.g., /iii_dev

  // init firebase
  let app;
  try {
    app = initializeApp(firebaseConfig);
  } catch (e) {
    console.error('Firebase init error', e);
    showError('Failed to initialize Firebase. Did you paste your firebaseConfig? See console.');
    loading.textContent = 'Initialization error';
    throw e;
  }

  const auth = getAuth(app);
  const db = getFirestore(app);

  // helpers
  function showError(msg) { errorArea.innerHTML = `<div class="error">${escapeHtml(msg)}</div>`; debugArea.textContent = msg; }
  function clearError() { errorArea.innerHTML = ''; debugArea.textContent = ''; }
  function escapeHtml(s) { return String(s).replace(/[&<>"']/g, (m)=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
  function setDebug(msg){ debugArea.textContent = msg; }

  // Firestore helpers (modular)
  async function fetchProfileByUsername(name) {
    if (!name) return null;
    try {
      const usernameRef = doc(db, 'usernames', name);
      const mappingSnap = await getDoc(usernameRef);
      if (!mappingSnap.exists()) return null;
      const mapping = mappingSnap.data();
      if (!mapping || !mapping.uid) return null;
      const profileRef = doc(db, 'profiles', mapping.uid);
      const profSnap = await getDoc(profileRef);
      if (!profSnap.exists()) return null;
      return { uid: mapping.uid, ...profSnap.data() };
    } catch (err) {
      console.error('fetchProfileByUsername error', err);
      showError('Error reading profile. Check Firestore read rules and console.');
      return null;
    }
  }

  function showProfile(p) {
    loading.style.display = 'none';
    profileTemplate.style.display = 'block';
    avatarEl.textContent = (p.displayName || p.username || '').slice(0,2).toUpperCase();
    displayNameEl.textContent = p.displayName || ("Player " + (p.uid ? p.uid.slice(0,6) : 'unknown'));
    if (p.username) usernameLine.innerHTML = `<span class="username-url" onclick="window.location.href='/${encodeURIComponent(p.username)}'">/${escapeHtml(p.username)}</span>`;
    else usernameLine.innerHTML = `<em>no username set</em>`;
    badgesEl.innerHTML = '';
    (p.badges || []).forEach(b => {
      const bEl = document.createElement('span'); bEl.className = 'badge'; bEl.textContent = b; badgesEl.appendChild(bEl);
    });
    bioEl.textContent = p.bio || '';
    actionsEl.innerHTML = '';
    const openBtn = document.createElement('button');
    openBtn.className = 'btn secondary';
    openBtn.textContent = 'Open in new tab';
    openBtn.onclick = () => window.open(location.origin + '/' + (p.username || p.uid), '_blank');
    actionsEl.appendChild(openBtn);
    ownerControls.style.display = 'none';
  }

  // Auth UI
  function setupAuthUI() {
    signinArea.innerHTML = `<div style="display:flex;gap:8px;align-items:center"><button class="btn" id="googleSignBtn">Sign in with Google</button><div class="small" id="signedAs"></div></div>`;
    const googleSignBtn = document.getElementById('googleSignBtn');
    const signedAs = document.getElementById('signedAs');

    googleSignBtn.onclick = async () => {
      try {
        const provider = new GoogleAuthProvider();
        await signInWithPopup(auth, provider);
      } catch (err) {
        console.error('Sign-in error', err);
        showError('Sign-in failed: ' + (err.message || err.code || 'unknown'));
      }
    };

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        signedAs.textContent = `Signed in as ${user.email || user.uid}`;
        googleSignBtn.style.display = 'none';
        // show owner controls depending on whether requested username is free or owned by user
        const profile = requested ? await fetchProfileByUsername(requested) : null;
        if (!requested) {
          ownerControls.style.display = 'none';
        } else if (!profile) {
          ownerControls.style.display = 'block';
          newUsernameInput.value = requested;
          ownerInfo.textContent = `You are logged in as ${user.email || user.uid}.`;
        } else {
          if (profile.uid === user.uid) {
            ownerControls.style.display = 'block';
            ownerInfo.textContent = `You can change username once every 15 days (unless admin). Current: ${profile.username || '(none)'}`;
            newUsernameInput.value = profile.username || requested;
          } else {
            ownerControls.style.display = 'none';
          }
        }
      } else {
        signedAs.textContent = '';
        googleSignBtn.style.display = 'inline-block';
        ownerControls.style.display = 'none';
      }
    }, (err) => {
      console.error('onAuthStateChanged err', err);
      showError('Auth state error: ' + (err.message || err.code || 'unknown'));
    });
  }

  // Client-side transaction to claim/change username (frontend-only)
  async function claimOrChangeUsername(username) {
    clearError();
    if (!auth.currentUser) {
      showError('Sign in first.');
      return;
    }
    const uid = auth.currentUser.uid;

    // quick local validation
    if (!/^[a-zA-Z0-9_.-]{3,30}$/.test(username)) {
      showError('Bad username format. Use 3-30 letters, numbers, dot, dash, underscore.');
      return;
    }

    try {
      claimBtn.disabled = true;
      claimBtn.textContent = 'Claiming…';
      setDebug('Starting Firestore transaction…');

      await runTransaction(db, async (t) => {
        const usernameRef = doc(db, 'usernames', username);
        const usernameSnap = await t.get(usernameRef);
        if (usernameSnap.exists()) {
          throw { code: 'already-exists', message: 'username taken' };
        }

        const profileRef = doc(db, 'profiles', uid);
        const profileSnap = await t.get(profileRef);
        const profileData = profileSnap.exists() ? profileSnap.data() : {};

        // cooldown check (15 days) enforced client-side here
        if (profileData.lastUsernameChange) {
          const last = profileData.lastUsernameChange.toDate ? profileData.lastUsernameChange.toDate() : new Date(profileData.lastUsernameChange);
          const diffDays = (Date.now() - last.getTime()) / (1000*60*60*24);
          if (diffDays < 15) {
            throw { code: 'failed-precondition', message: `You can change username only once every 15 days (wait ${(15 - Math.floor(diffDays))} more day(s))` };
          }
        }

        // delete old mapping if present
        if (profileData.username) {
          const oldRef = doc(db, 'usernames', profileData.username);
          t.delete(oldRef);
        }

        // create new mapping
        t.set(usernameRef, { uid: uid, createdAt: serverTimestamp() });

        // update profile
        t.set(profileRef, { username: username, lastUsernameChange: serverTimestamp() }, { merge: true });
      });

      setDebug('Transaction successful');
      alert('Username claimed: ' + username);
      // redirect to the vanity url
      window.location.href = '/' + encodeURIComponent(username);

    } catch (err) {
      console.error('Transaction error', err);
      const code = err?.code || (err && err.message && err.message.toLowerCase().includes('permission') ? 'permission-denied' : null);
      if (code === 'already-exists') showError('That username is already taken.');
      else if (code === 'failed-precondition') showError(err.message || 'Cooldown active.');
      else if (code === 'permission-denied' || (err && err.message && err.message.toLowerCase().includes('permission'))) {
        showError('Permission denied. Your Firestore security rules currently block client-side username claims. To use this frontend-only flow, allow authenticated users to write /usernames and update /profiles. See console for details.');
      } else showError('Claim failed: ' + (err.message || JSON.stringify(err)));
    } finally {
      claimBtn.disabled = false;
      claimBtn.textContent = 'Claim / Change Username';
    }
  }

  // wire UI buttons
  copyLinkBtn.onclick = () => {
    const u = location.origin + '/' + (requested || '');
    navigator.clipboard.writeText(u).then(()=> {
      copyLinkBtn.textContent = 'Copied!';
      setTimeout(()=> copyLinkBtn.textContent = 'Copy profile link', 1500);
    }).catch(err => showError('Copy failed: ' + (err.message || err)));
  };

  claimBtn.onclick = async () => {
    const v = newUsernameInput.value.trim();
    if (!v) { alert('Enter a username'); return; }
    await claimOrChangeUsername(v);
  };

  // boot
  (async function init() {
    try {
      setupAuthUI();

      // initial profile load
      if (requested) {
        const profile = await fetchProfileByUsername(requested);
        if (profile) showProfile(profile);
        else {
          loading.style.display = 'none';
          profileTemplate.style.display = 'block';
          displayNameEl.textContent = 'No profile';
          usernameLine.innerHTML = `<span class="username-url">/${escapeHtml(requested)}</span> — available`;
          badgesEl.innerHTML = '';
          bioEl.textContent = '';
          ownerControls.style.display = 'none';
        }
      } else {
        loading.style.display = 'none';
        profileTemplate.style.display = 'block';
        displayNameEl.textContent = 'Profile viewer';
        usernameLine.innerHTML = `<em>Enter a username in the URL (e.g. /iii_dev)</em>`;
        ownerControls.style.display = 'none';
      }

      setDebug('Ready — frontend-only mode');
    } catch (e) {
      console.error('init error', e);
      showError('Initialization failed: ' + (e?.message || e));
      loading.textContent = 'Init error';
    }
  })();

  </script>
</body>
</html>
