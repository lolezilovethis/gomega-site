<!-- chat.html -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gomega Chat (debug)</title>
  <style>
    :root { --blue:#0b57cc; --bg:#f6f7fb; --card:#fff; --muted:#666; }
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; margin:0; background:var(--bg); color:#111; }
    header { display:flex; align-items:center; justify-content:space-between; padding:12px 18px; background:var(--blue); color:white; }
    .container { display:flex; gap:18px; padding:18px; }
    .left { flex:1 1 640px; display:flex; flex-direction:column; height:75vh; background:var(--card); border-radius:12px; padding:12px; box-shadow:0 6px 18px rgba(12,20,40,0.06); }
    .public-messages { flex:1; overflow:auto; padding:8px; border-radius:8px; background:#fbfdff; }
    .controls { display:flex; gap:8px; margin-top:8px; }
    input[type="text"] { width:100%; padding:8px; border-radius:8px; border:1px solid #e3e7ef; font-size:14px; }
    button { padding:8px 12px; border-radius:8px; border:0; cursor:pointer; background:var(--blue); color:white; }
    .right { width:320px; display:flex; flex-direction:column; gap:12px; height:75vh; background:var(--card); border-radius:12px; padding:12px; box-shadow:0 6px 18px rgba(12,20,40,0.06); }
    .users-list { overflow:auto; flex:1; }
    .muted { color:var(--muted); font-size:12px; }
    .log { font-family: monospace; font-size:12px; white-space:pre-wrap; background:#fafafa; border:1px solid #eee; padding:8px; border-radius:8px; max-height:120px; overflow:auto; }
  </style>
</head>
<body>

<header>
  <div style="font-weight:700">Gomega Chat (debug)</div>
  <div>
    <span id="userDisplay" class="muted"></span>
    <button id="signInBtn">Sign in</button>
    <button id="signOutBtn" style="display:none">Sign out</button>
  </div>
</header>

<div class="container">
  <div class="left">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
      <strong>Public Chat</strong>
      <div><button id="openDmsBtn">My DMS</button></div>
    </div>

    <div id="publicMessages" class="public-messages" aria-live="polite"></div>

    <div class="controls">
      <input id="messageInput" type="text" placeholder="Say something to everyone..." autocomplete="off" />
      <button id="sendBtn">Send</button>
    </div>

    <div style="margin-top:12px;">
      <div style="font-weight:600">Client debug log</div>
      <div id="clientLog" class="log"></div>
    </div>
  </div>

  <div class="right">
    <div style="font-weight:600">Active Users</div>
    <div id="usersList" class="users-list"></div>
    <div class="muted">Click a user → "Private Chat". Private messages expire after 12 days.</div>
  </div>
</div>

<!-- Minimal modals omitted for brevity in this debug file (keeps core functionality) -->

<script type="module">
import { auth, db, provider } from './js/firebase.js';
import { signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import {
  collection, addDoc, serverTimestamp, query, orderBy, onSnapshot,
  where, Timestamp, doc, setDoc, getDocs, limit
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const signInBtn = document.getElementById('signInBtn');
const signOutBtn = document.getElementById('signOutBtn');
const userDisplay = document.getElementById('userDisplay');
const publicMessagesDiv = document.getElementById('publicMessages');
const messageInput = document.getElementById('messageInput');
const sendBtn = document.getElementById('sendBtn');
const usersList = document.getElementById('usersList');
const clientLog = document.getElementById('clientLog');

let currentUser = null;
let publicUnsub = null;

function log(msg) {
  console.log(msg);
  clientLog.textContent += (new Date().toLocaleTimeString()) + " — " + String(msg) + "\n";
  clientLog.scrollTop = clientLog.scrollHeight;
}

signInBtn.onclick = async () => {
  try {
    await signInWithPopup(auth, provider);
  } catch (e) {
    log('Sign-in failed: ' + (e.message || e));
  }
};
signOutBtn.onclick = async () => {
  try {
    await signOut(auth);
  } catch (e) { log('Sign-out failed: ' + e.message); }
};

onAuthStateChanged(auth, async (user) => {
  if (user) {
    currentUser = user;
    userDisplay.textContent = `${user.displayName || user.email || user.uid}`;
    signInBtn.style.display = 'none';
    signOutBtn.style.display = '';
    log('Signed in: uid=' + user.uid + ', email=' + user.email);
    // ensure users doc exists
    try {
      await setDoc(doc(collection(db,'users'), user.uid), {
        uid: user.uid,
        displayName: user.displayName || '',
        email: user.email || '',
        lastSeen: serverTimestamp()
      }, { merge: true });
      log('Wrote/merged /users/' + user.uid);
    } catch (err) {
      log('Failed writing /users doc: ' + (err.code || '') + ' ' + (err.message || err));
      console.error(err);
    }
    startPublicListener();
    startUsersListener();
  } else {
    currentUser = null;
    userDisplay.textContent = '';
    signInBtn.style.display = '';
    signOutBtn.style.display = 'none';
    if (publicUnsub) publicUnsub();
    publicMessagesDiv.innerHTML = '';
    usersList.innerHTML = '';
    log('Signed out');
  }
});

function startPublicListener() {
  if (publicUnsub) publicUnsub();
  const sevenDaysAgo = Timestamp.fromDate(new Date(Date.now() - 7 * 24 * 60 * 60 * 1000));
  const q = query(collection(db,'publicMessages'), where('createdAt', '>=', sevenDaysAgo), orderBy('createdAt','asc'), limit(1000));
  publicUnsub = onSnapshot(q, snap => {
    publicMessagesDiv.innerHTML = '';
    snap.forEach(docSnap => {
      const m = docSnap.data();
      const el = document.createElement('div');
      el.style.padding = '8px';
      el.style.borderBottom = '1px solid #eee';
      el.innerHTML = `<div style="font-size:12px;color:#666">${m.displayName || m.email || 'Unknown'} • ${m.createdAt ? new Date(m.createdAt.seconds*1000).toLocaleString() : '...'} </div>
                      <div>${escapeHtml(m.text || '')}</div>`;
      publicMessagesDiv.appendChild(el);
    });
    publicMessagesDiv.scrollTop = publicMessagesDiv.scrollHeight;
  }, err => {
    log('Public listener error: ' + (err.code || '') + ' ' + (err.message || err));
    console.error(err);
  });
}

function startUsersListener() {
  const q = query(collection(db,'users'), orderBy('lastSeen','desc'), limit(200));
  onSnapshot(q, snap => {
    usersList.innerHTML = '';
    snap.forEach(s => {
      const u = s.data();
      const div = document.createElement('div');
      div.style.padding = '8px';
      div.style.borderBottom = '1px solid #eee';
      div.innerHTML = `<div style="font-weight:600">${escapeHtml(u.displayName || u.email || 'Unknown')}</div><div class="muted">${escapeHtml(u.email || '')}</div>`;
      usersList.appendChild(div);
    });
  }, err => {
    log('Users listener error: ' + (err.code || '') + ' ' + (err.message || err));
  });
}

sendBtn.onclick = async () => {
  if (!currentUser) { alert('Sign in first'); return; }
  const text = messageInput.value.trim();
  if (!text) return;
  const payload = {
    uid: currentUser.uid,
    displayName: currentUser.displayName || '',
    email: currentUser.email || '',
    text,
    parentId: null,
    createdAt: Timestamp.now(),
    expireAt: Timestamp.fromDate(new Date(Date.now() + 12*24*60*60*1000))
  };
  // LOG the exact payload to the debug box (and console)
  log('Attempting to write /publicMessages with payload: ' + JSON.stringify(normalizeForLog(payload)));
  try {
    const ref = await addDoc(collection(db,'publicMessages'), payload);
    log('Write successful: /publicMessages/' + ref.id);
    messageInput.value = '';
  } catch (err) {
    // print full error details
    log('Failed to send public message: ' + (err.code || '') + ' ' + (err.message || err));
    console.error('Firestore write error', err);
    alert('Failed to send message (see client debug log and console).');
  }
};

// small helper to show timestamp types in log as strings
function normalizeForLog(obj) {
  const out = {};
  for (const k in obj) {
    const v = obj[k];
    if (v && typeof v.toDate === 'function') out[k] = v.toDate().toISOString();
    else out[k] = v;
  }
  return out;
}

function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[c]); }

</script>
</body>
</html>
