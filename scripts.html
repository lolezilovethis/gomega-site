<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Scripts â€“ Gomega Watch</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <!-- âœ… Popunder Script -->
  <script type='text/javascript' src='//hidcolouredclink.com/b7/f1/42/b7f142495e4b7efd7498741c57f56c1d.js'></script>
</head>
<body>
  <div class="container">
    <div style="display: flex; justify-content: space-between; align-items: center;">
      <button onclick="logout()">ðŸšª Logout</button>
      <a href="settings.html"><i class="fas fa-gear fa-2x"></i></a>
    </div>

    <h1>ðŸ§¾ Roblox Scripts</h1>
    <input type="text" id="searchBox" placeholder="Search scripts..." oninput="filterScripts()" class="search-box" />
    <p id="scriptCount"></p>

    <div id="addScriptForm">
      <h3>âž• Add New Script</h3>
      <input id="scriptTitle" placeholder="Script Title">
      <textarea id="scriptDesc" placeholder="Short Description"></textarea>
      <textarea id="scriptCode" placeholder="Script Code URL"></textarea>
      <label><input type="checkbox" id="scriptAds"> Enable Ads (ðŸ’°)</label>
      <button onclick="addScript()">Upload Script</button>
    </div>

    <div id="scriptList"></div>

    <footer>
      <a href="index.html">â¬… Back to Home</a> |
      <a href="https://hidcolouredclink.com/en9fnp1f?key=38ae975ca6aee7f0655f6d6a736017f2" target="_blank">
        Visit Gomega Watch Sponsored Link
      </a>
    </footer>
  </div>

  <script type="module">
    if (localStorage.getItem("theme") === "dark") {
      document.documentElement.classList.add("dark");
    }

    import { auth, db } from './js/firebase.js';
    import {
      signOut,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import {
      collection,
      addDoc,
      getDocs,
      query,
      where,
      orderBy,
      serverTimestamp,
      Timestamp
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const scriptList = document.getElementById("scriptList");
    const scriptCount = document.getElementById("scriptCount");
    let allScripts = [];
    let currentUserEmail = "";

    onAuthStateChanged(auth, async user => {
      if (!user) return location.href = "signin.html";

      currentUserEmail = user.email;
      localStorage.setItem("currentUser", user.email);
      await refreshScriptList();
    });

    async function refreshScriptList() {
      const scriptsRef = collection(db, "scripts");
      const q = query(scriptsRef, orderBy("timestamp", "desc"));
      const snapshot = await getDocs(q);

      allScripts = [];
      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        allScripts.push(data);
      });

      renderScripts(allScripts);
    }

    function renderScripts(scripts) {
      scriptList.innerHTML = "";
      scripts.forEach(s => {
        const card = document.createElement("div");
        card.className = "script-card";
        const adNotice = s.ads ? '<span class="small gray">Ad Protected ðŸ’°</span>' : '';
        card.innerHTML = `
          <div>
            <h2>${s.title || s.name}</h2>
            <p class="small gray">${s.description || ''} ${adNotice}</p>
            <p class="small">by ${s.author || 'Anonymous'}</p>
            <button onclick="copyScript('${s.code}', ${s.ads})">ðŸ“‹ Copy</button>
          </div>
        `;
        scriptList.appendChild(card);
      });
      scriptCount.textContent = `Total Scripts: ${scripts.length}`;
    }

    window.copyScript = function (code, adsEnabled) {
      if (adsEnabled) {
        alert("To unlock this script, you'll be redirected to an ad. Return after a few seconds.");
        const adWindow = window.open("https://www.profitableratecpm.com/en9fnp1f?key=38ae975ca6aee7f0655f6d6a736017f2", "_blank");
        setTimeout(() => {
          navigator.clipboard.writeText(code);
          alert("Script copied after ad link was opened!");
        }, 3000);
      } else {
        navigator.clipboard.writeText(code);
        alert("Copied to clipboard!");
      }
    }

    window.filterScripts = function () {
      const search = document.getElementById("searchBox").value.toLowerCase();
      const filtered = allScripts.filter(s => s.title?.toLowerCase().includes(search));
      renderScripts(filtered);
    }

    window.addScript = async function () {
      const title = document.getElementById("scriptTitle").value.trim();
      const desc = document.getElementById("scriptDesc").value.trim();
      const code = document.getElementById("scriptCode").value.trim();
      const ads = document.getElementById("scriptAds").checked;

      if (!title || !code) return alert("Title and Script URL are required.");

      const cooldown = 2 * 60 * 60 * 1000; // 2 hours in milliseconds
      const scriptsRef = collection(db, "scripts");

      const userScriptsQuery = query(
        scriptsRef,
        where("author", "==", currentUserEmail),
        orderBy("timestamp", "desc")
      );

      const snapshot = await getDocs(userScriptsQuery);
      const lastDoc = snapshot.docs[0];

      if (lastDoc) {
        const lastTimestamp = lastDoc.data().timestamp?.toDate?.();
        if (lastTimestamp) {
          const now = new Date();
          const diff = now - lastTimestamp;
          if (diff < cooldown) {
            const remaining = Math.ceil((cooldown - diff) / (60 * 1000));
            return alert(`â³ Please wait ${remaining} minutes before uploading another script.`);
          }
        }
      }

      try {
        await addDoc(scriptsRef, {
          title,
          description: desc,
          code,
          author: currentUserEmail,
          ads,
          timestamp: serverTimestamp()
        });

        alert("âœ… Script added!");
        await refreshScriptList();
      } catch (error) {
        console.error("Error adding script:", error);
        alert("Failed to upload script. Please try again.");
      }
    }

    window.logout = function () {
      signOut(auth).then(() => location.href = "index.html");
    }
  </script>
</body>
</html>
