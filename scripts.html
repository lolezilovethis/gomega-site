<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Scripts â€“ Gomega Watch</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container">
    <div style="text-align:right;">
      <button onclick="logout()">ðŸšª Logout</button>
    </div>

    <h1>ðŸ§¾ Roblox Scripts</h1>
    <input type="text" id="searchBox" placeholder="Search scripts..." oninput="filterScripts()" class="search-box" />
    <p id="scriptCount"></p>

    <div id="addScriptForm" style="display:none;">
      <h3>Add New Script</h3>
      <input id="scriptName" placeholder="Script Name">
      <textarea id="scriptCode" placeholder="Script Code URL"></textarea>
      <button onclick="addScript()">âž• Add Script</button>
    </div>

    <div id="scriptList"></div>

    <footer><a href="index.html">â¬… Back to Home</a></footer>

  </div>

  <!-- Firebase SDK -->
  <script type="module">
    import { auth, db } from './firebase.js';
    import {
      signOut,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import {
      collection,
      addDoc,
      getDocs,
      query,
      orderBy,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const scriptList = document.getElementById("scriptList");
    const scriptCount = document.getElementById("scriptCount");
    const adminEmails = ['admin1@example.com', 'admin2@example.com'];

    let allScripts = [];

    onAuthStateChanged(auth, async user => {
      if (!user) return location.href = "signin.html";

      const isAdmin = adminEmails.includes(user.email);
      if (isAdmin) document.getElementById("addScriptForm").style.display = "block";

      const scriptsRef = collection(db, "scripts");
      const q = query(scriptsRef, orderBy("timestamp", "desc"));
      const snapshot = await getDocs(q);

      allScripts = [];
      snapshot.forEach(doc => {
        allScripts.push(doc.data());
      });

      renderScripts(allScripts);
    });

    function renderScripts(scripts) {
      scriptList.innerHTML = "";
      scripts.forEach(s => {
        const card = document.createElement("div");
        card.className = "script-card";
        card.innerHTML = `
          <div>
            <h2>${s.name} <span class="small gray">by ${s.author || 'Anonymous'}</span></h2>
            <p>${s.code}</p>
          </div>
          <button onclick="copyScript(\`${s.code}\`)">ðŸ“‹ Copy</button>
        `;
        scriptList.appendChild(card);
      });
      scriptCount.textContent = `Total Scripts: ${scripts.length}`;
    }

    function copyScript(code) {
      navigator.clipboard.writeText(code);
      alert("Copied to clipboard!");
    }

    function filterScripts() {
      const search = document.getElementById("searchBox").value.toLowerCase();
      const filtered = allScripts.filter(s => s.name.toLowerCase().includes(search));
      renderScripts(filtered);
    }

    async function addScript() {
      const name = document.getElementById("scriptName").value.trim();
      const code = document.getElementById("scriptCode").value.trim();

      if (!name || !code) return alert("Both fields are required.");

      await addDoc(collection(db, "scripts"), {
        name,
        code,
        author: auth.currentUser.email,
        timestamp: serverTimestamp()
      });

      alert("Script added!");
      location.reload();
    }

    function logout() {
      signOut(auth).then(() => location.href = "index.html");
    }
  </script>
</body>
</html>
