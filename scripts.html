<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Scripts ‚Äì Gomega Watch</title>

  <!-- AdSense Auto Ads -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2566003301154558" crossorigin="anonymous"></script>

  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <style>
    body { font-family: sans-serif; padding: 20px; max-width: 1000px; margin: auto; background: white; color: black; transition: background 0.3s, color 0.3s; }
    .dark-mode { background: #121212; color: #e7e7e7; }
    .script-card { border: 1px solid #ccc; padding: 15px; margin-bottom: 20px; border-radius: 10px; background: #f9f9f9; }
    .dark-mode .script-card { background: #1f1f1f; border-color: #333; }
    .search-box { width: 100%; padding: 10px; margin-bottom: 15px; border-radius: 8px; border: 1px solid #ccc; }
    button { background-color: #3b82f6; color: white; padding: 10px; border: none; border-radius: 8px; cursor: pointer; margin-top: 10px; }
    button:hover { opacity: 0.9; }
    pre { background: #f2f2f2; padding: 10px; border-radius: 8px; white-space: pre-wrap; font-family: monospace; }
    .dark-mode pre { background: #2a2a2a; }
    .logo { display: flex; align-items: center; gap: 10px; margin-bottom: 20px; }
    .logo img { height: 40px; }
    footer { margin-top: 40px; text-align: center; font-size: 14px; }
    .top-bar { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; }
    .info { font-size: 0.9rem; margin-top: 4px; }
    @media (max-width: 600px) { .script-card { padding: 10px; } button { width: 100%; } }
    #hoverParticles { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: -1; }

    /* New UI bits */
    .controls-row { display:flex; gap:8px; align-items:center; margin-bottom:12px; flex-wrap:wrap; }
    .controls-row select, .controls-row label { font-size:0.95rem; }
    .badge-admin { display:inline-block; background:#ffd54f; color:#000; padding:2px 6px; border-radius:6px; margin-left:8px; font-weight:700; font-size:0.8rem; }
    .popularity { font-size:0.9rem; color:#555; margin-left:8px; }
    .script-meta { display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-top:8px; }
    .perpage { width:110px; }
    .load-more { margin-top: 8px; }

    /* dark toggle visual */
    #darkToggle { display:flex; gap:8px; align-items:center; }
  </style>
</head>
<body>

  <!-- Auth Redirect -->
  <script type="module">
    import { auth } from './js/firebase.js';
    import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js';
    onAuthStateChanged(auth, user => { if (!user) location.href = '/'; });
  </script>

  <!-- Third-Party Ad Provider -->
  <script async src="https://a.magsrv.com/ad-provider.js"></script>
  <ins class="eas6a97888e2" data-zoneid="5672278"></ins>
  <script> (AdProvider = window.AdProvider||[]).push({serve:{}}); </script>

  <div class="top-bar">
    <div class="logo">
      <img src="assets/logo.png" alt="Gomega Watch Logo">
      <h1>Gomega Scripts</h1>
    </div>
    <div style="display:flex; gap:10px;">
      <button id="darkToggle">üåì Dark Mode</button>
      <button id="settingsBtn">‚öôÔ∏è Settings</button>
      <button id="makeScriptBtn">‚úèÔ∏è Make a Script</button>
    </div>
  </div>

  <!-- CONTROLS ‚Äî kept everything but removed "Admins only" filter per request -->
  <div class="controls-row" style="margin-bottom:8px;">
    <label for="sortSelect">Sort:</label>
    <select id="sortSelect" title="Sort scripts">
      <option value="newest">Newest</option>
      <option value="oldest">Oldest</option>
      <option value="popular">Most popular</option>
    </select>

    <label style="display:flex;align-items:center;gap:6px;">
      <span>Per page</span>
      <select id="perPageSelect" class="perpage">
        <option value="10">10</option>
        <option value="20" selected>20</option>
        <option value="50">50</option>
      </select>
    </label>

    <button id="refreshBtn" style="margin-left:auto;">Refresh</button>
  </div>

  <input class="search-box" id="searchBox" placeholder="Search scripts‚Ä¶">
  <p id="scriptCount"></p>
  <div id="scriptList"><p>üîÑ Loading scripts...</p></div>
  <div style="text-align:center;"><button id="loadMoreBtn" class="load-more">Load more</button></div>

  <footer>
    <a href="https://discord.gg/kZtW4y2Q7u" target="_blank">üí¨ Join our Discord</a>
  </footer>

  <canvas id="hoverParticles"></canvas>

  <script type="module">
    import { db } from './js/firebase.js';
    import { collection, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    // ---- NOTE: ADMINS filter removed by user request. Admin badge still shown when brandName === 'Admin' (unchanged UI).

    let allLocal = [];
    let allRemote = []; // will contain objects { id, ...data }
    let visibleCount = parseInt(document.getElementById('perPageSelect').value, 10) || 20;
    let currentSort = document.getElementById('sortSelect').value;
    let searchTerm = '';

    // local popularity storage key prefix
    const LOCAL_PREFIX = 'gomega_script_clicks_';

    // helper: safely read timestamp in ms
    function scriptTimestampMs(s) {
      const t = s.timestamp;
      if (!t) return 0;
      if (typeof t === 'number') return t;
      if (t.seconds) return t.seconds * 1000 + (t.nanoseconds ? Math.floor(t.nanoseconds/1000000) : 0);
      if (typeof t.toMillis === 'function') return t.toMillis();
      return 0;
    }

    // get local clicks for a script id
    function getLocalClicks(id) {
      try {
        const v = localStorage.getItem(LOCAL_PREFIX + id);
        return v ? parseInt(v, 10) : 0;
      } catch { return 0; }
    }
    function incLocalClicks(id) {
      const cur = getLocalClicks(id) || 0;
      const next = cur + 1;
      try { localStorage.setItem(LOCAL_PREFIX + id, String(next)); } catch {}
      return next;
    }

    // get remote clicks field if present as number
    function getRemoteClicks(script) {
      if (!script) return 0;
      const c = script.clicks || script.clickCount || 0;
      return typeof c === 'number' ? c : (parseInt(c,10) || 0);
    }

    // compute popularity score (remote + local)
    function popularityScore(script) {
      return getRemoteClicks(script) + getLocalClicks(script.id || '');
    }

    // Attach remote loader
    function loadRemote() {
      try {
        const col = collection(db, 'approved_scripts');
        // keep onSnapshot to get live updates
        onSnapshot(col, snap => {
          allRemote = snap.docs.map(d => {
            return { id: d.id, ...d.data() };
          });
          applyFiltersAndRender();
        }, err => {
          console.error('Remote load error', err);
          // still render local if remote fails
          applyFiltersAndRender();
        });
      } catch (e) {
        console.warn('Firestore not available in this environment', e);
        applyFiltersAndRender();
      }
    }

    // local scripts loader (improved: attach stable ids based on filename or title)
    async function loadLocal() {
      try {
        const res = await fetch('scripts/index.json');
        const files = await res.json();
        const items = await Promise.all(files.map(async name => {
          try {
            const r = await fetch(`scripts/${name}`);
            const data = await r.json();
            // create an id from filename (without extension) OR from title if provided
            const fileId = name.replace(/\.[^.]+$/, '');
            const id = (data.id && String(data.id)) || (data.title ? data.title.toString().toLowerCase().replace(/\s+/g,'-').replace(/[^a-z0-9\-]/g,'') : fileId);
            return { id, ...data };
          } catch (e) {
            console.error('Failed to load', name, e);
            return null;
          }
        }));
        allLocal = items.filter(Boolean);
        applyFiltersAndRender();
      } catch (e) {
        console.error('Local load error', e);
        allLocal = [];
        applyFiltersAndRender();
      }
    }

    // Combined filter, sort, paginate, render
    function applyFiltersAndRender() {
      // merge with consistent ids: prefer remote id for remote items, local id for local
      const merged = [...(allRemote || []), ...(allLocal || [])];

      // search filter
      const term = (searchTerm || '').trim().toLowerCase();
      let filtered = merged.filter(s => {
        if (!term) return true;
        if ((s.title || '').toString().toLowerCase().includes(term)) return true;
        if ((s.description || '').toString().toLowerCase().includes(term)) return true;
        if ((s.brandName || '').toString().toLowerCase().includes(term)) return true;
        return false;
      });

      // sorting
      if (currentSort === 'newest') {
        filtered.sort((a,b) => scriptTimestampMs(b) - scriptTimestampMs(a));
      } else if (currentSort === 'oldest') {
        filtered.sort((a,b) => scriptTimestampMs(a) - scriptTimestampMs(b));
      } else if (currentSort === 'popular') {
        filtered.sort((a,b) => popularityScore(b) - popularityScore(a));
      }

      // store fullFiltered for load more
      window.__gomega_fullFiltered = filtered;

      renderScripts(filtered.slice(0, visibleCount));

      // update script count summary
      document.getElementById('scriptCount').textContent = `Showing ${Math.min(visibleCount, filtered.length)} of ${filtered.length} scripts`;
    }

    function renderScripts(scripts) {
      const list = document.getElementById('scriptList');
      list.innerHTML = '';
      if (!scripts || scripts.length === 0) {
        list.innerHTML = '<p>No scripts found.</p>';
        return;
      }

      scripts.forEach(script => {
        const id = script.id || (script.title ? script.title.toLowerCase().replace(/\s+/g, '-') : Math.random().toString(36).slice(2));
        const adsInfo = script.includeAds ? `${script.numAds || 1} ad${(script.numAds || 1) > 1 ? 's' : ''}` : 'No ads';
        const publisher = script.brandName || 'Unknown';
        const remoteClicks = getRemoteClicks(script);
        const localClicks = getLocalClicks(id);
        const totalClicks = remoteClicks + localClicks;

        // admin badge (kept for visual, does not affect filtering)
        const adminBadge = (publisher === 'Admin' || publisher === 'admin') ? `<span class="badge-admin">ADMIN</span>` : '';

        list.insertAdjacentHTML('beforeend', `
          <div class="script-card" data-script-id="${id}">
            <h2>${escapeHtml(script.title || 'Untitled')}</h2>
            <p>${escapeHtml(script.description || 'No description.')}</p>
            <div class="script-meta">
              <p class="info"><strong>Publisher:</strong> ${escapeHtml(publisher)} ${adminBadge}</p>
              <p class="info"><strong>Ads:</strong> ${escapeHtml(adsInfo)}</p>
              <p class="popularity"><strong>Popularity:</strong> ${totalClicks} clicks</p>
            </div>
            ${script.getPaid ? `<p class="info">üí∞ Publisher will earn revenue</p>` : ''}
            <button class="get-btn" data-id="${id}">üì• Get Script</button>
            <button class="copy-btn" data-id="${id}" style="display:none;">üìã Copy Script</button>
            <pre id="code-${id}" style="display:none;">${escapeHtml(script.code || '')}</pre>
          </div>
        `);
      });
      attachUnlockHandlers(); // reattach handlers to new DOM
    }

    // attach handlers ‚Äî increment local clicks and show code like before
    function attachUnlockHandlers() {
      document.querySelectorAll('.get-btn').forEach(btn => {
        btn.onclick = async () => {
          const id = btn.dataset.id;
          // find script in merged arrays
          const merged = [...allRemote, ...allLocal];
          const script = merged.find(s => (s.id || (s.title||'').toLowerCase().replace(/\s+/g,'-')) === id);
          const box = document.getElementById(`code-${id}`);
          const copyBtn = document.querySelector(`.copy-btn[data-id="${id}"]`);

          if (!script) {
            alert('Script not found.');
            return;
          }

          if (script.includeAds && script.numAds > 0) {
            if (!confirm(`You must view ${script.numAds} ad${script.numAds > 1 ? 's' : ''}.`)) return;
            let openedAds = 0;
            while (openedAds < script.numAds) {
              window.open('https://www.profitableratecpm.com/en9fnp1f?key=38ae975ca6aee7f0655f6d6a736017f2', '_blank');
              openedAds++;
              await new Promise(r => setTimeout(r, 1500));
            }
          }

          // show code
          if (box) {
            box.style.display = 'block';
            box.textContent = script.code || '';
          }

          // copy to clipboard attempt (like original)
          try {
            await navigator.clipboard.writeText(script.code || '');
            alert('‚úÖ Copied to clipboard!');
          } catch {
            alert('‚ö†Ô∏è Copy failed. Use the "Copy Script" button.');
          }

          // increment local popularity
          const newLocal = incLocalClicks(id);
          // update shown popularity count in the card
          const card = document.querySelector(`.script-card[data-script-id="${id}"]`);
          if (card) {
            const popEl = card.querySelector('.popularity');
            const remote = getRemoteClicks(script);
            if (popEl) popEl.innerHTML = `<strong>Popularity:</strong> ${remote + newLocal} clicks`;
          }

          // Show copy button after revealing code (like original logic)
          if (copyBtn) copyBtn.style.display = 'inline-block';
        };
      });

      document.querySelectorAll('.copy-btn').forEach(btn => {
        btn.onclick = () => {
          const id = btn.dataset.id;
          const codeEl = document.getElementById(`code-${id}`);
          const code = codeEl ? codeEl.textContent : '';
          navigator.clipboard.writeText(code).then(() => {
            alert('‚úÖ Script copied!');
          }).catch(() => {
            alert('‚ö†Ô∏è Could not copy script.');
          });
        };
      });
    }

    // search input
    document.getElementById('searchBox').addEventListener('input', e => {
      searchTerm = e.target.value;
      visibleCount = parseInt(document.getElementById('perPageSelect').value, 10) || visibleCount;
      applyFiltersAndRender();
    });

    // sort select
    document.getElementById('sortSelect').addEventListener('change', e => {
      currentSort = e.target.value;
      applyFiltersAndRender();
    });

    // per page
    document.getElementById('perPageSelect').addEventListener('change', e => {
      visibleCount = parseInt(e.target.value, 10) || visibleCount;
      applyFiltersAndRender();
    });

    // refresh
    document.getElementById('refreshBtn').addEventListener('click', () => {
      // re-run loaders
      loadLocal();
      loadRemote();
    });

    // load more button
    document.getElementById('loadMoreBtn').addEventListener('click', () => {
      const add = parseInt(document.getElementById('perPageSelect').value, 10) || 10;
      visibleCount += add;
      // if we have a cached filtered list, just show more
      if (window.__gomega_fullFiltered) {
        renderScripts(window.__gomega_fullFiltered.slice(0, visibleCount));
        document.getElementById('scriptCount').textContent = `Showing ${Math.min(visibleCount, window.__gomega_fullFiltered.length)} of ${window.__gomega_fullFiltered.length}`;
      } else {
        applyFiltersAndRender();
      }
    });

    // util: escape html to prevent accidental injection when rendering code elements
    function escapeHtml(unsafe) {
      if (unsafe === undefined || unsafe === null) return '';
      return String(unsafe)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/\"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    // init loaders
    loadLocal();
    loadRemote();

    // ------------------ Dark mode handling (fixed + persisted)
    const darkToggle = document.getElementById('darkToggle');
    function applyDarkModeState(on) {
      if (on) {
        document.body.classList.add('dark-mode');
        darkToggle.textContent = 'üåô Dark';
      } else {
        document.body.classList.remove('dark-mode');
        darkToggle.textContent = '‚òÄÔ∏è Light';
      }
    }
    // initialize from localStorage
    const saved = localStorage.getItem('gomega_dark');
    const initialDark = saved === '1' || (saved === null && window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches);
    applyDarkModeState(initialDark);

    darkToggle.addEventListener('click', () => {
      const isDark = document.body.classList.toggle('dark-mode');
      localStorage.setItem('gomega_dark', isDark ? '1' : '0');
      applyDarkModeState(isDark);
    });

    // settings & make script buttons
    document.getElementById('settingsBtn').addEventListener('click', () => {
      // simple placeholder: open settings page or modal
      if (location.pathname.endsWith('/scripts.html')) {
        // try to open "settings.html" if it exists, otherwise alert
        window.location.href = '/settings.html';
      } else {
        alert('Open settings (not implemented)');
      }
    });
    document.getElementById('makeScriptBtn').addEventListener('click', () => {
      window.location.href = '/add-script.html';
    });

  </script>

  <script>
    // particle background (unchanged)
    const canvas = document.getElementById('hoverParticles'), ctx = canvas.getContext('2d'); let particles = [];
    function resize() { canvas.width = innerWidth; canvas.height = innerHeight; }
    window.addEventListener('resize', resize); resize();
    document.addEventListener('mousemove', e => { for (let i = 0; i < 3; i++) particles.push({ x: e.clientX, y: e.clientY, r: Math.random() * 2 + 1, vx: Math.random() * 2 - 1, vy: Math.random() * 2 - 1, life: 60 }); });
    (function draw() { ctx.clearRect(0, 0, canvas.width, canvas.height); particles = particles.filter(p => p.life > 0); particles.forEach(p => { p.x += p.vx; p.y += p.vy; p.life--; ctx.beginPath(); ctx.arc(p.x, p.y, p.r, 0, 2 * Math.PI); ctx.fillStyle = `rgba(0,217,255,${p.life/60})`; ctx.fill(); }); requestAnimationFrame(draw); })();
  </script>

</body>
</html>
