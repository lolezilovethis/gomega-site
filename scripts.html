<script type="module">
  import { auth, db } from './js/firebase.js';
  import {
    signOut,
    onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
  import {
    collection,
    addDoc,
    getDocs,
    query,
    orderBy,
    serverTimestamp,
    deleteDoc,
    doc
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  const scriptList = document.getElementById("scriptList");
  const scriptCount = document.getElementById("scriptCount");
  const adminEmails = ['admin1@example.com', 'admin2@example.com'];
  let allScripts = [];
  let scriptDocs = [];
  let currentUserEmail = "";

  const bannedUsers = JSON.parse(localStorage.getItem("bannedUsers") || "[]");

  onAuthStateChanged(auth, async user => {
    if (!user) return location.href = "signin.html";

    currentUserEmail = user.email;
    localStorage.setItem("currentUser", user.email);

    if (bannedUsers.includes(user.email)) {
      alert("You are banned from using this site.");
      await signOut(auth);
      location.href = "index.html";
      return;
    }

    const isAdmin = adminEmails.includes(user.email);
    if (isAdmin) document.getElementById("adminPanel").style.display = "block";

    await refreshScriptList();
  });

  window.addScript = async function () {
    const title = document.getElementById("scriptTitle").value.trim();
    const desc = document.getElementById("scriptDesc").value.trim();
    const code = document.getElementById("scriptCode").value.trim();
    const ads = document.getElementById("scriptAds").checked;

    if (!title || !code) return alert("Title and Script URL are required.");

    try {
      await addDoc(collection(db, "scripts"), {
        title,
        description: desc,
        code,
        author: currentUserEmail,
        ads,
        verified: true,
        timestamp: serverTimestamp()
      });
      alert("Script added!");
      await refreshScriptList();
    } catch (err) {
      alert("Failed to upload script. Check console.");
      console.error("Add script error:", err);
    }
  };

  async function refreshScriptList() {
    const scriptsRef = collection(db, "scripts");
    const q = query(scriptsRef, orderBy("timestamp", "desc"));
    const snapshot = await getDocs(q);

    allScripts = [];
    scriptDocs = [];
    snapshot.forEach(docSnap => {
      const data = docSnap.data();
      scriptDocs.push({ id: docSnap.id, ...data });
      allScripts.push(data);
    });

    renderScripts(allScripts);
  }

  function renderScripts(scripts) {
    scriptList.innerHTML = "";
    scripts.forEach(s => {
      const card = document.createElement("div");
      card.className = "script-card";
      const verifiedBadge = s.verified ? 'âœ…' : '';
      const adNotice = s.ads ? '<span class="small gray">Ad Protected ðŸ’°</span>' : '';
      card.innerHTML = `
        <div>
          <h2>${s.title || s.name} ${verifiedBadge}</h2>
          <p class="small gray">${s.description || ''} ${adNotice}</p>
          <p class="small">by ${s.author || 'Anonymous'}</p>
          <button onclick="copyScript('${s.code}', ${s.ads})">ðŸ“‹ Copy</button>
        </div>
      `;
      scriptList.appendChild(card);
    });
    scriptCount.textContent = `Total Scripts: ${scripts.length}`;
  }

  window.copyScript = function (code, adsEnabled) {
    if (adsEnabled) {
      alert("To unlock this script, you'll be redirected to an ad. Return after a few seconds.");
      const adWindow = window.open("https://www.profitableratecpm.com/en9fnp1f?key=38ae975ca6aee7f0655f6d6a736017f2", "_blank");

      setTimeout(() => {
        navigator.clipboard.writeText(code);
        alert("Script copied after ad link was opened!");
      }, 3000); // 3-second wait
    } else {
      navigator.clipboard.writeText(code);
      alert("Copied to clipboard!");
    }
  };

  window.filterScripts = function () {
    const search = document.getElementById("searchBox").value.toLowerCase();
    const filtered = allScripts.filter(s => s.title?.toLowerCase().includes(search));
    renderScripts(filtered);
  };

  window.removeScript = async function () {
    const name = document.getElementById("removeScriptName").value.trim().toLowerCase();
    const scriptToDelete = scriptDocs.find(s => s.title?.toLowerCase() === name);
    if (!scriptToDelete) return alert("Script not found.");

    await deleteDoc(doc(db, "scripts", scriptToDelete.id));
    alert("Script removed!");
    await refreshScriptList();
  };

  window.banUser = function () {
    const email = document.getElementById("banEmail").value.trim();
    if (!email) return alert("Enter a valid email.");
    const bans = JSON.parse(localStorage.getItem("bannedUsers") || "[]");
    if (!bans.includes(email)) {
      bans.push(email);
      localStorage.setItem("bannedUsers", JSON.stringify(bans));
    }
    alert(`${email} has been banned.`);
  };

  window.unbanUser = function () {
    const email = document.getElementById("unbanEmail").value.trim();
    const bans = JSON.parse(localStorage.getItem("bannedUsers") || "[]");
    const newList = bans.filter(e => e !== email);
    localStorage.setItem("bannedUsers", JSON.stringify(newList));
    alert(`${email} has been unbanned.`);
  };

  window.logout = function () {
    signOut(auth).then(() => location.href = "index.html");
  };
</script>
