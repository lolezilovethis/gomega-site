<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Scripts ‚Äì Gomega Watch</title>

  <!-- AdSense Auto Ads -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2566003301154558" crossorigin="anonymous"></script>

  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <style>
    body { font-family: sans-serif; padding: 20px; max-width: 1000px; margin: auto; background: white; color: black; transition: background 0.3s, color 0.3s; }
    .dark-mode { background: #121212; color: #e7e7e7; }
    .script-card { border: 1px solid #ccc; padding: 15px; margin-bottom: 20px; border-radius: 10px; background: #f9f9f9; }
    .dark-mode .script-card { background: #1f1f1f; border-color: #333; }
    .search-box { width: 100%; padding: 10px; margin-bottom: 15px; border-radius: 8px; border: 1px solid #ccc; }
    button { background-color: #3b82f6; color: white; padding: 10px; border: none; border-radius: 8px; cursor: pointer; margin-top: 10px; }
    button:hover { opacity: 0.9; }
    pre { background: #f2f2f2; padding: 10px; border-radius: 8px; white-space: pre-wrap; font-family: monospace; }
    .dark-mode pre { background: #2a2a2a; }
    .logo { display: flex; align-items: center; gap: 10px; margin-bottom: 20px; }
    .logo img { height: 40px; }
    footer { margin-top: 40px; text-align: center; font-size: 14px; }
    .top-bar { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; }
    .info { font-size: 0.9rem; margin-top: 4px; }
    @media (max-width: 600px) { .script-card { padding: 10px; } button { width: 100%; } }
    #hoverParticles { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: -1; }

    /* New UI bits */
    .controls-row { display:flex; gap:8px; align-items:center; margin-bottom:12px; flex-wrap:wrap; }
    .controls-row select, .controls-row label { font-size:0.95rem; }
    .badge-admin { display:inline-block; background:#ffd54f; color:#000; padding:2px 6px; border-radius:6px; margin-left:8px; font-weight:700; font-size:0.8rem; }
    .popularity { font-size:0.9rem; color:#555; margin-left:8px; }
    .script-meta { display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-top:8px; }
    .perpage { width:110px; }
    .load-more { margin-top: 8px; }

    /* pending UI */
    #pendingIndicator { margin-left: 12px; font-size: 0.9rem; display:flex; gap:8px; align-items:center; }
    #pendingIndicator button { background:#f59e0b; color:#000; padding:6px 8px; border-radius:6px; font-size:0.9rem; }

    /* dark toggle visual */
    #darkToggle { display:flex; gap:8px; align-items:center; }
  </style>
</head>
<body>

  <!-- Auth Redirect -->
  <script type="module">
    import { auth } from './js/firebase.js';
    import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js';
    onAuthStateChanged(auth, user => { if (!user) location.href = '/'; });
  </script>

  <!-- Third-Party Ad Provider -->
  <script async src="https://a.magsrv.com/ad-provider.js"></script>
  <ins class="eas6a97888e2" data-zoneid="5672278"></ins>
  <script> (AdProvider = window.AdProvider||[]).push({serve:{}}); </script>

  <div class="top-bar">
    <div class="logo">
      <img src="assets/logo.png" alt="Gomega Watch Logo">
      <h1>Gomega Scripts</h1>
    </div>
    <div style="display:flex; gap:10px; align-items:center;">
      <button id="darkToggle">üåì Dark Mode</button>
      <button id="settingsBtn">‚öôÔ∏è Settings</button>
      <button id="makeScriptBtn">‚úèÔ∏è Make a Script</button>

      <!-- ADDED: pending indicator -->
      <div id="pendingIndicator" title="Pending increments that couldn't write to Firestore">
        <span id="pendingCount">Pending: 0</span>
        <button id="syncPendingBtn">Sync pending</button>
      </div>
    </div>
  </div>

  <!-- CONTROLS ‚Äî kept everything but removed "Admins only" filter per request -->
  <div class="controls-row" style="margin-bottom:8px;">
    <label for="sortSelect">Sort:</label>
    <select id="sortSelect" title="Sort scripts">
      <option value="newest">Newest</option>
      <option value="oldest">Oldest</option>
      <option value="popular">Most popular</option>
    </select>

    <label style="display:flex;align-items:center;gap:6px;">
      <span>Per page</span>
      <select id="perPageSelect" class="perpage">
        <option value="10">10</option>
        <option value="20" selected>20</option>
        <option value="50">50</option>
      </select>
    </label>

    <button id="refreshBtn" style="margin-left:auto;">Refresh</button>
  </div>

  <input class="search-box" id="searchBox" placeholder="Search scripts‚Ä¶">
  <p id="scriptCount"></p>
  <div id="scriptList"><p>üîÑ Loading scripts...</p></div>
  <div style="text-align:center;"><button id="loadMoreBtn" class="load-more">Load more</button></div>

  <footer>
    <a href="https://discord.gg/kZtW4y2Q7u" target="_blank">üí¨ Join our Discord</a>
  </footer>

  <canvas id="hoverParticles"></canvas>

  <script type="module">
    /* ===========================
       MAIN MODULE SCRIPT (with debug helpers)
       =========================== */

    // core firebase imports
    import { db } from './js/firebase.js';

    // Firestore helpers
    import {
      collection,
      onSnapshot,
      doc,
      updateDoc,
      setDoc,
      increment
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    // debug / auth helpers
    import { getApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
    import { getAuth, onAuthStateChanged, getIdTokenResult } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js';

    // ---- NOTE: ADMINS filter removed by user request. Admin badge still shown when brandName === 'Admin' (unchanged UI).

    let allLocal = [];
    let allRemote = []; // will contain objects { id, ...data }
    let visibleCount = parseInt(document.getElementById('perPageSelect').value, 10) || 20;
    let currentSort = document.getElementById('sortSelect').value;
    let searchTerm = '';

    // local popularity storage key prefix
    const LOCAL_PREFIX = 'gomega_script_clicks_';

    // QUEUE: pending firebase increments when permission denied
    const PENDING_KEY = 'gomega_pending_clicks';
    function readPending() {
      try {
        const raw = localStorage.getItem(PENDING_KEY);
        return raw ? JSON.parse(raw) : [];
      } catch { return []; }
    }
    function writePending(arr) {
      try { localStorage.setItem(PENDING_KEY, JSON.stringify(arr)); } catch {}
      updatePendingUI();
    }
    function enqueuePending(docId) {
      const q = readPending();
      q.push({ id: docId, ts: Date.now() });
      writePending(q);
    }
    function popPending() {
      const q = readPending();
      q.shift();
      writePending(q);
    }
    function updatePendingUI() {
      const count = readPending().length;
      const el = document.getElementById('pendingCount');
      if (el) el.textContent = `Pending: ${count}`;
    }

    // ========== DEBUG HELPERS (Option 1) ==========
    const dbg = (...args) => console.log('[DBG]', ...args);

    try {
      const app = getApp();
      dbg('Firebase app name:', app.name);
      dbg('Firebase projectId:', app.options && app.options.projectId);
    } catch (e) {
      dbg('No firebase app found (getApp() failed):', e);
    }

    // Log auth state & token claims
    try {
      const ga = getAuth();
      ga.onAuthStateChanged && ga.onAuthStateChanged(async user => {
        dbg('onAuthStateChanged -> user:', user ? { uid: user.uid, email: user.email } : null);
        if (user) {
          try {
            const token = await user.getIdTokenResult();
            dbg('ID token claims:', token && token.claims);
          } catch (err) {
            dbg('Failed to getIdTokenResult:', err);
          }
        }
      });
    } catch (e) {
      dbg('getAuth() failed:', e);
    }

    // Wrapper to log update attempts and results
    async function safeUpdateDocWithLog(docRef, payload) {
      try {
        dbg('Attempting updateDoc:', docRef && (docRef.path || docRef), 'payload:', payload);
      } catch (e) { console.log('dbg failed', e); }

      try {
        await updateDoc(docRef, payload);
        dbg('updateDoc succeeded for', docRef && (docRef.path || docRef));
      } catch (err) {
        dbg('updateDoc failed:', err && err.code, err && err.message, err);
        throw err;
      }
    }
    // ========== end DEBUG HELPERS ==========

    // helper: safely read timestamp in ms
    function scriptTimestampMs(s) {
      const t = s && s.timestamp;
      if (!t) return 0;
      if (typeof t === 'number') return t;
      if (t.seconds) return t.seconds * 1000 + (t.nanoseconds ? Math.floor(t.nanoseconds/1000000) : 0);
      if (typeof t.toMillis === 'function') return t.toMillis();
      return 0;
    }

    // normalize id helper: ensures we compare the same id format everywhere
    function normalizeId(item) {
      if (!item) return '';
      if (typeof item === 'string' && item.trim() !== '') return item;
      if (typeof item.id === 'string' && item.id.trim() !== '') return item.id;
      if (typeof item.id === 'number') return String(item.id);
      if (item.title) return item.title.toString().toLowerCase().replace(/\s+/g,'-').replace(/[^a-z0-9\-]/g,'');
      return '';
    }

    // get local clicks for a script id
    function getLocalClicks(id) {
      try {
        const v = localStorage.getItem(LOCAL_PREFIX + id);
        return v ? parseInt(v, 10) : 0;
      } catch { return 0; }
    }
    function incLocalClicks(id) {
      const cur = getLocalClicks(id) || 0;
      const next = cur + 1;
      try { localStorage.setItem(LOCAL_PREFIX + id, String(next)); } catch {}
      return next;
    }

    // get remote clicks field if present as number
    function getRemoteClicks(script) {
      if (!script) return 0;
      const c = script.clicks || script.clickCount || 0;
      return typeof c === 'number' ? c : (parseInt(c,10) || 0);
    }

    // compute popularity score (remote + local)
    function popularityScore(script) {
      return getRemoteClicks(script) + getLocalClicks(normalizeId(script) || '');
    }

    // Attach remote loader
    function loadRemote() {
      try {
        const col = collection(db, 'approved_scripts');
        // keep onSnapshot to get live updates
        onSnapshot(col, snap => {
          allRemote = snap.docs.map(d => {
            // prefer Firestore doc id as canonical id
            const data = d.data() || {};
            const built = { id: d.id, ...data };
            return built;
          });
          applyFiltersAndRender();
        }, err => {
          console.error('Remote load error', err);
          // still render local if remote fails
          applyFiltersAndRender();
        });
      } catch (e) {
        console.warn('Firestore not available in this environment', e);
        applyFiltersAndRender();
      }
    }

    // local scripts loader
    async function loadLocal() {
      try {
        const res = await fetch('scripts/index.json');
        const files = await res.json();
        const items = await Promise.all(files.map(async name => {
          try {
            const r = await fetch(`scripts/${name}`);
            const data = await r.json();
            // create an id from filename (without extension) OR from title if provided
            const fileId = name.replace(/\.[^.]+$/, '');
            const id = (data.id && String(data.id)) || (data.title ? data.title.toString().toLowerCase().replace(/\s+/g,'-').replace(/[^a-z0-9\-]/g,'') : fileId);
            return { id, ...data };
          } catch (e) {
            console.error('Failed to load', name, e);
            return null;
          }
        }));
        allLocal = items.filter(Boolean);
        applyFiltersAndRender();
      } catch (e) {
        console.error('Local load error', e);
        allLocal = [];
        applyFiltersAndRender();
      }
    }

    // Combined filter, sort, paginate, render
    function applyFiltersAndRender() {
      const merged = [...(allRemote || []), ...(allLocal || [])];

      const term = (searchTerm || '').trim().toLowerCase();
      let filtered = merged.filter(s => {
        if (!term) return true;
        if ((s.title || '').toString().toLowerCase().includes(term)) return true;
        if ((s.description || '').toString().toLowerCase().includes(term)) return true;
        if ((s.brandName || '').toString().toLowerCase().includes(term)) return true;
        return false;
      });

      if (currentSort === 'newest') {
        filtered.sort((a,b) => scriptTimestampMs(b) - scriptTimestampMs(a));
      } else if (currentSort === 'oldest') {
        filtered.sort((a,b) => scriptTimestampMs(a) - scriptTimestampMs(b));
      } else if (currentSort === 'popular') {
        filtered.sort((a,b) => popularityScore(b) - popularityScore(a));
      }

      window.__gomega_fullFiltered = filtered;

      renderScripts(filtered.slice(0, visibleCount));

      document.getElementById('scriptCount').textContent = `Showing ${Math.min(visibleCount, filtered.length)} of ${filtered.length} scripts`;
    }

    function renderScripts(scripts) {
      const list = document.getElementById('scriptList');
      list.innerHTML = '';
      if (!scripts || scripts.length === 0) {
        list.innerHTML = '<p>No scripts found.</p>';
        return;
      }

      scripts.forEach(script => {
        const id = normalizeId(script) || (script.title ? script.title.toLowerCase().replace(/\s+/g, '-') : Math.random().toString(36).slice(2));
        const adsInfo = script.includeAds ? `${script.numAds || 1} ad${(script.numAds || 1) > 1 ? 's' : ''}` : 'No ads';
        const publisher = script.brandName || 'Admin';
        const remoteClicks = getRemoteClicks(script);
        const localClicks = getLocalClicks(id);
        const totalClicks = remoteClicks + localClicks;

        const adminBadge = (publisher === 'Admin' || publisher === 'admin') ? `<span class="badge-admin">ADMIN</span>` : '';

        list.insertAdjacentHTML('beforeend',
          `<div class="script-card" data-script-id="${id}">
            <h2>${escapeHtml(script.title || 'Untitled')}</h2>
            <p>${escapeHtml(script.description || 'No description.')}</p>
            <div class="script-meta">
              <p class="info"><strong>Publisher:</strong> ${escapeHtml(publisher)} ${adminBadge}</p>
              <p class="info"><strong>Ads:</strong> ${escapeHtml(adsInfo)}</p>
              <p class="popularity"><strong>Popularity:</strong> ${totalClicks} clicks</p>
            </div>
            ${script.getPaid ? `<p class="info">üí∞ Publisher will earn revenue</p>` : ''}
            <button class="get-btn" data-id="${id}">üì• Get Script</button>
            <button class="copy-btn" data-id="${id}" style="display:none;">üìã Copy Script</button>
            <pre id="code-${id}" style="display:none;">${escapeHtml(script.code || '')}</pre>
          </div>`
        );
      });
      attachUnlockHandlers();
    }

    // Try flushing pending increments to Firestore (uses debug wrapper)
    async function tryFlushPending() {
      const q = readPending();
      if (!q || q.length === 0) {
        updatePendingUI();
        return;
      }
      // attempt sequentially (so we can stop on permission errors)
      for (let i = 0; i < q.length; i++) {
        const item = q[i];
        try {
          const fsId = item.id;
          const scriptRef = doc(db, 'approved_scripts', fsId);
          // replaced updateDoc with safe wrapper for logging
          try {
            await safeUpdateDocWithLog(scriptRef, { clicks: increment(1) });
            // if success, remove first item and continue
            popPending();
            i--; // adjust index because we popped front
          } catch (err) {
            // If permission denied, stop trying further: rules need change
            if (err && err.code === 'permission-denied') {
              console.warn('Unable to flush pending clicks: permission-denied. Update Firestore rules or use server-side function.');
              break;
            } else {
              console.warn('Flush attempt failed for', item.id, err);
              break;
            }
          }
        } catch (err) {
          console.warn('tryFlushPending internal error', err);
          break;
        }
      }
      updatePendingUI();
    }

    // attach handlers ‚Äî increment local clicks and show code like before
    function attachUnlockHandlers() {
      document.querySelectorAll('.get-btn').forEach(btn => {
        btn.onclick = null;
        btn.addEventListener('click', async (evt) => {
          try {
            const id = btn.dataset.id;
            const merged = [...allRemote, ...allLocal];
            const script = merged.find(s => normalizeId(s) === id);
            const box = document.getElementById(`code-${id}`);
            const copyBtn = document.querySelector(`.copy-btn[data-id="${id}"]`);

            if (!script) {
              alert('Script not found.');
              return;
            }

            if (script.includeAds && script.numAds > 0) {
              if (!confirm(`You must view ${script.numAds} ad${script.numAds > 1 ? 's' : ''}.`)) return;
              let openedAds = 0;
              while (openedAds < script.numAds) {
                window.open('https://www.profitableratecpm.com/en9fnp1f?key=38ae975ca6aee7f0655f6d6a736017f2', '_blank');
                openedAds++;
                await new Promise(r => setTimeout(r, 1500));
              }
            }

            if (box) {
              box.style.display = 'block';
              box.textContent = script.code || '';
            }

            try {
              await navigator.clipboard.writeText(script.code || '');
            } catch {
              console.warn('Clipboard write failed (possibly insecure context).');
            }

            // increment local popularity
            const newLocal = incLocalClicks(id);

            // Determine firestore id to use (prefer remote doc id)
            const fsCandidate = (allRemote.find(r => normalizeId(r) === id) || {}).id || id;

            if (fsCandidate) {
              try {
                const scriptRef = doc(db, 'approved_scripts', fsCandidate);
                // replaced updateDoc with safe wrapper for logging
                try {
                  await safeUpdateDocWithLog(scriptRef, { clicks: increment(1) });
                } catch (uErr) {
                  console.warn('updateDoc failed:', uErr);
                  if (uErr && uErr.code === 'permission-denied') {
                    enqueuePending(fsCandidate);
                  } else {
                    try {
                      await setDoc(doc(db,'approved_scripts',fsCandidate), { clicks: 1, title: script.title || null }, { merge: true });
                    } catch (sErr) {
                      console.warn('setDoc fallback failed:', sErr);
                      enqueuePending(fsCandidate);
                    }
                  }
                }
              } catch (err) {
                console.error('Failed to attempt firestore update:', err);
                enqueuePending(fsCandidate);
              }
            } else {
              enqueuePending(id);
            }

            // update shown popularity count in the card immediately
            const card = document.querySelector(`.script-card[data-script-id="${id}"]`);
            if (card) {
              const popEl = card.querySelector('.popularity');
              const remote = getRemoteClicks(script);
              if (popEl) popEl.innerHTML = `<strong>Popularity:</strong> ${remote + newLocal} clicks`;
            }

            if (copyBtn) copyBtn.style.display = 'inline-block';

          } catch (err) {
            console.error('Get button handler failed:', err);
            alert('An error occurred. Check console for details.');
          }
        });
      });

      document.querySelectorAll('.copy