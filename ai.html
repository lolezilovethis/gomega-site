<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gomega AI</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <link rel="icon" href="/favicon.ico" />
  <style>
    html, body { height: 100%; }
    .msg p { margin: 0.25rem 0; }
    .msg pre { overflow:auto; padding:0.75rem; border-radius:0.5rem; background:#0f172a; color:#e2e8f0; }
    .msg code:not(pre code) { background:#0f172a; color:#e2e8f0; padding:0.2rem 0.3rem; border-radius:0.3rem; }
    .blinker { animation: blink 1s step-start 0s infinite; }
    @keyframes blink { 50% { opacity: 0; } }
  </style>
</head>
<body class="bg-slate-900 text-slate-100">
  <div class="min-h-full flex flex-col">
    <!-- Header -->
    <header class="sticky top-0 z-20 backdrop-blur bg-slate-900/75 border-b border-slate-800">
      <div class="max-w-5xl mx-auto px-4 py-3 flex items-center gap-3">
        <div class="w-8 h-8 rounded-xl bg-gradient-to-br from-indigo-500 to-fuchsia-500"></div>
        <h1 class="text-xl font-semibold tracking-tight">Gomega AI</h1>
        <span class="ml-auto text-xs text-slate-400">/ai</span>
      </div>
    </header>

    <!-- Main -->
    <main class="flex-1">
      <div class="max-w-5xl mx-auto px-4 py-4 grid gap-4 md:grid-cols-[1fr,20rem]">
        <!-- Chat -->
        <section class="rounded-2xl border border-slate-800 bg-slate-950/50 p-3 md:p-4 flex flex-col min-h-[70vh]">
          <div id="chat" class="flex-1 overflow-y-auto space-y-4 pr-1"></div>

          <form id="composer" class="mt-3">
            <div class="flex items-end gap-2">
              <textarea id="prompt" rows="1" placeholder="Ask anything…" class="flex-1 resize-none bg-slate-800/70 rounded-2xl p-3 outline-none focus:ring-2 focus:ring-indigo-500/60"></textarea>
              <button id="send" type="submit" class="px-4 py-3 rounded-2xl bg-indigo-600 hover:bg-indigo-500 font-medium">Send</button>
            </div>

            <div class="mt-2 flex flex-wrap items-center gap-3 text-xs text-slate-400">
              <label class="flex items-center gap-1">Model
                <select id="model" class="bg-slate-800/70 rounded-lg p-1"></select>
              </label>

              <label class="flex items-center gap-2">Temp
                <input id="temp" type="range" min="0" max="2" step="0.1" value="0.7" />
                <span id="tempv">0.7</span>
              </label>

              <button id="clear" type="button" class="ml-auto underline">Clear chat</button>
            </div>

            <details class="mt-2 text-xs text-slate-300">
              <summary class="cursor-pointer select-none">System prompt</summary>
              <textarea id="system" rows="3" class="w-full mt-2 bg-slate-800/70 rounded-lg p-2" placeholder="You are Gomega AI, a helpful assistant…"></textarea>
            </details>
          </form>
        </section>

        <!-- Sidebar -->
        <aside class="space-y-3">
          <div id="sessionCard" class="rounded-2xl border border-slate-800 p-4 bg-slate-950/50">
            <h2 class="font-semibold mb-2">Session</h2>
            <div class="text-sm text-slate-300">Responses are generated by your configured backend. Keys are never stored in the browser.</div>
          </div>

          <div class="rounded-2xl border border-slate-800 p-4 bg-slate-950/50">
            <h2 class="font-semibold mb-2">Shortcuts</h2>
            <ul class="list-disc list-inside text-sm text-slate-300">
              <li><kbd>Shift+Enter</kbd> for newline</li>
              <li><kbd>/reset</kbd> to start over</li>
            </ul>
          </div>

          <div class="rounded-2xl border border-slate-800 p-4 bg-slate-950/50">
            <h2 class="font-semibold mb-2">About</h2>
            <p class="text-sm text-slate-300">Built for <span class="font-medium">gomega.watch</span>. Streamed Markdown, code blocks, history, and model controls.</p>
          </div>
        </aside>
      </div>
    </main>

    <footer class="border-t border-slate-800 text-center text-xs text-slate-500 py-4">© <span id="yr"></span> Gomega</footer>
  </div>

<script>
  const BASE_URL = "/api"; // change if your backend is elsewhere
  const $ = (s, p=document) => p.querySelector(s);

  const chatEl = $('#chat');
  const promptEl = $('#prompt');
  const form = $('#composer');
  const sendBtn = $('#send');
  const modelEl = $('#model');
  const tempEl = $('#temp');
  const tempvEl = $('#tempv');
  const systemEl = $('#system');
  const clearBtn = $('#clear');
  $('#yr').textContent = new Date().getFullYear();
  tempEl.addEventListener('input', () => tempvEl.textContent = tempEl.value);

  function fit() {
    promptEl.style.height = 'auto';
    promptEl.style.height = Math.min(promptEl.scrollHeight, 220) + 'px';
  }
  promptEl.addEventListener('input', fit); fit();

  // History
  let history = JSON.parse(localStorage.getItem('gomega_ai_history')||'[]');
  systemEl.value = localStorage.getItem('gomega_ai_system') || '';
  function save() {
    localStorage.setItem('gomega_ai_history', JSON.stringify(history.slice(-50)));
    localStorage.setItem('gomega_ai_system', systemEl.value || '');
  }

  function addMsg(role, html) {
    const wrap = document.createElement('div');
    wrap.className = 'msg flex items-start gap-3';
    wrap.innerHTML = `
      <div class="w-8 h-8 rounded-xl ${role==='user'?'bg-indigo-600':'bg-fuchsia-600'} flex items-center justify-center text-xs font-bold">
        ${role==='user'?'U':'G'}
      </div>
      <div class="flex-1 prose prose-invert max-w-none text-sm">${html}</div>
    `;
    chatEl.appendChild(wrap);
    chatEl.scrollTop = chatEl.scrollHeight;
  }

  function renderMarkdown(md) {
    return marked.parse(md, { breaks: true, gfm: true });
  }

  function renderHistory() {
    chatEl.innerHTML = '';
    for (const m of history) addMsg(m.role, renderMarkdown(m.content));
  }
  renderHistory();

  // Load backend config (models + premium availability)
  let serverConfig = { models: [], premiumAvailable: false };
  async function loadConfig() {
    try {
      const r = await fetch(BASE_URL + '/config');
      if (!r.ok) throw new Error('Failed to load config');
      serverConfig = await r.json();
    } catch (e) {
      console.warn('config load failed', e);
      // fallback to safe defaults
      serverConfig = {
        premiumAvailable: false,
        models: [
          { id: 'gomega-4o', label: 'gomega-4o', premium: false },
          { id: 'gomega-4o-mini', label: 'gomega-4o-mini', premium: false },
          { id: 'gomega3.1', label: 'gomega3.1', premium: false },
          { id: 'gomega5o', label: 'gomega5o (premium)', premium: true }
        ]
      };
    }

    modelEl.innerHTML = '';
    for (const m of serverConfig.models) {
      const opt = document.createElement('option');
      opt.value = m.id;
      opt.textContent = m.label + (m.premium ? ' ✦' : '');
      if (m.premium && !serverConfig.premiumAvailable) opt.disabled = true;
      modelEl.appendChild(opt);
    }
  }
  await loadConfig();

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const content = promptEl.value.trim();
    if (!content) return;
    if (content === '/reset') { history = []; save(); renderHistory(); promptEl.value=''; return; }

    history.push({ role: 'user', content });
    addMsg('user', renderMarkdown(content));
    promptEl.value = ''; fit();

    const wrap = document.createElement('div');
    wrap.className = 'msg flex items-start gap-3';
    wrap.innerHTML = `
      <div class="w-8 h-8 rounded-xl bg-fuchsia-600 flex items-center justify-center text-xs font-bold">G</div>
      <div class="flex-1 prose prose-invert max-w-none text-sm"><span class="blinker">▍</span></div>
    `;
    const bodyEl = wrap.children[1];
    chatEl.appendChild(wrap);
    chatEl.scrollTop = chatEl.scrollHeight;

    sendBtn.disabled = true;

    try {
      const resp = await fetch(BASE_URL + '/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          modelId: modelEl.value,
          temperature: Number(tempEl.value),
          system: systemEl.value || undefined,
          messages: history.slice(-20),
          stream: true
        })
      });

      if (resp.status === 402 || resp.status === 403) {
        const json = await resp.json().catch(()=>({ error: 'premium required' }));
        bodyEl.innerHTML = renderMarkdown('**Error:** ' + (json.error || 'Payment/Premium required for that model.'));
        return;
      }

      if (!resp.ok) throw new Error('Request failed');

      const reader = resp.body.getReader();
      const decoder = new TextDecoder();
      let acc = '';
      while (true) {
        const { value, done } = await reader.read();
        if (done) break;
        const chunk = decoder.decode(value, { stream: true });
        acc += chunk;
        bodyEl.innerHTML = renderMarkdown(acc);
        chatEl.scrollTop = chatEl.scrollHeight;
      }

      history.push({ role: 'assistant', content: acc });
      save();

    } catch (err) {
      bodyEl.innerHTML = renderMarkdown('**Error:** ' + (err.message || err));
    } finally {
      sendBtn.disabled = false;
    }
  });

  clearBtn.addEventListener('click', () => { history = []; save(); renderHistory(); });

  // Shift+Enter newline, Enter sends
  promptEl.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      form.requestSubmit();
    }
  });
</script>
</body>
</html>
