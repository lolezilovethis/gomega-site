<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gomega AI — ai.html</title>
  <!-- Use Firebase 10.x modular SDK (CDN). Adjust versions if you prefer. -->
  <script type="module">
    // This file uses ES modules (modern browsers). If hosting on older targets, you can switch to compat SDK.
  </script>

  <style>
    :root{
      --bg:#071026; --card:#071226; --accent1:#f59e0b; --accent2:#ef4444; --muted:#9fb0c6; --glass: rgba(255,255,255,0.03);
      --success:#10b981; --danger:#ef4444;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue"; background: linear-gradient(180deg,#021124,#071026); color:#e6eef6}
    .wrap{max-width:1024px;margin:28px auto;padding:18px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00)); box-shadow:0 12px 40px rgba(2,6,23,0.7); display:grid; grid-template-columns:320px 1fr; gap:18px; min-height:640px;}
    .left{padding:18px;border-right:1px solid rgba(255,255,255,0.03)}
    .right{display:flex;flex-direction:column; background:transparent}
    .glogo{width:140px;height:72px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:20px;background:linear-gradient(90deg,#0ea5a9,#7c3aed); box-shadow:0 8px 30px rgba(12,34,56,0.35); animation:logoBounce 1.6s infinite}
    @keyframes logoBounce{0%{transform:translateY(0)}50%{transform:translateY(-8px) scale(1.02)}100%{transform:translateY(0)}}
    .subtitle{margin-top:10px;color:var(--muted);font-size:13px;max-width:260px}
    .controls{margin-top:18px;display:flex;flex-direction:column;gap:10px}
    .select,.input,.btn{background:var(--glass);border:1px solid rgba(255,255,255,0.03);padding:10px 12px;border-radius:10px;color:inherit;font-size:14px}
    .btn{cursor:pointer}
    .btn.primary{background:linear-gradient(90deg,var(--accent1),var(--accent2)); border:none; color:#071226; font-weight:700}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.03)}
    .status{display:flex;gap:8px;align-items:center;margin-top:8px}
    .dot{width:10px;height:10px;border-radius:50%}
    .dot.ok{background:var(--success)}
    .dot.bad{background:var(--danger)}
    .messages{flex:1;padding:18px;overflow:auto; display:flex;flex-direction:column; gap:14px; background: repeating-linear-gradient(180deg, rgba(255,255,255,0.003) 0 1px, transparent 1px 48px)}
    .msg{max-width:72%;padding:12px 14px;border-radius:12px;line-height:1.35}
    .msg.user{margin-left:auto;background:linear-gradient(180deg,#071226,#05121a);border:1px solid rgba(255,255,255,0.02)}
    .msg.ai{background:linear-gradient(180deg,#072033,#03122b);border:1px solid rgba(255,255,255,0.03)}
    .meta{font-size:12px;color:var(--muted);margin-bottom:6px}
    .composer{display:flex;gap:10px;padding:12px;border-top:1px solid rgba(255,255,255,0.02);align-items:center}
    .text-in{flex:1;border-radius:10px;padding:10px;border:1px solid rgba(255,255,255,0.03);min-height:44px;background:transparent;color:inherit;font-size:14px;resize:none}
    .send{min-width:120px;padding:10px 14px;border-radius:10px;font-weight:700}
    .small{font-size:13px;color:var(--muted)}
    .typing-dot{display:inline-block;width:8px;height:8px;border-radius:50%;background:rgba(255,255,255,0.6);margin-right:6px;animation:blink 1s infinite}
    @keyframes blink{50%{opacity:0.15}}
    .modal-backdrop{position:fixed;inset:0;background:rgba(2,6,23,0.6);display:flex;align-items:center;justify-content:center;z-index:60}
    .modal{width:460px;background:#071226;border-radius:12px;padding:16px;box-shadow:0 18px 60px rgba(2,6,23,0.7)}
    footer.small{padding:10px;text-align:center;border-top:1px dashed rgba(255,255,255,0.02);color:var(--muted)}
    .hidden{display:none}
    @media(max-width:920px){.wrap{grid-template-columns:1fr;padding:12px}.left{order:2}}
  </style>
</head>
<body>
  <div class="wrap" role="application" aria-label="Gomega AI chat">
    <div class="left" aria-hidden="false">
      <div style="display:flex;flex-direction:column;align-items:center">
        <div class="glogo" id="glogo">GOMEGA</div>
        <div class="subtitle">Gomega AI — chat with different model tiers. Upgrade for premium models & unlimited access.</div>
      </div>

      <div class="controls" role="navigation" aria-label="controls">
        <label class="small">AI Model</label>
        <select id="modelSelect" class="select" aria-label="model select">
          <option value="gomega-v1">gomega v1 — free</option>
          <option value="gomega-v2">gomega v2 — free</option>
          <option value="gomega-v3">gomega v3 — free</option>
          <option value="gomega-v4" data-premium="true">gomega v4.0 mini — premium</option>
          <option value="gomega-v5" data-premium="true">gomega v5.o mini — premium</option>
        </select>

        <div style="display:flex;gap:8px">
          <button id="activateBtn" class="btn ghost">⚜️ Activate</button>
          <button id="signinBtn" class="btn ghost" title="Sign in">Sign in</button>
        </div>

        <div class="status">
          <span id="licenseDot" class="dot bad"></span>
          <div>
            <div id="licenseText">Not premium — limited</div>
            <div id="licenseExpire" class="small"></div>
          </div>
        </div>

        <div style="margin-top:12px">
          <div class="small">Chat limit</div>
          <div id="chatInfo" class="small">Free: 50 messages/day • Premium: Unlimited</div>
        </div>
      </div>

      <footer class="small">Press <strong>Ctrl+Shift+A</strong> to open Admin panel (admin account only)</footer>
    </div>

    <div class="right" role="main" aria-live="polite">
      <div id="messages" class="messages" tabindex="0" aria-label="messages area"></div>

      <div class="composer" role="form" aria-label="composer">
        <textarea id="inputBox" class="text-in" placeholder="Say something..." rows="1" aria-label="message input"></textarea>
        <button id="sendBtn" class="btn primary send">Send</button>
      </div>
      <footer class="small" style="padding:10px 18px;color:var(--muted)">
        <span id="usedCount">0</span> used • <span id="remainingCount">50</span> remaining
      </footer>
    </div>
  </div>

  <!-- Activate modal -->
  <div id="activateModal" class="modal-backdrop hidden" role="dialog" aria-modal="true">
    <div class="modal">
      <h3>Activate Premium</h3>
      <p class="small">Enter your premium key to unlock unlimited messages and premium models.</p>
      <div style="margin-top:8px">
        <label class="small">Premium Key</label>
        <input id="keyInput" class="input" placeholder="GOMEGA-LIFETIME-XXXXXXXX" />
      </div>

      <div style="margin-top:12px;display:flex;gap:8px">
        <button id="activateConfirm" class="btn primary">Activate Premium</button>
        <button id="activateCancel" class="btn ghost">Cancel</button>
      </div>
      <p class="small" style="margin-top:10px">Key formats: <code>GOMEGA-LIFETIME-XXXX</code>, <code>GOMEGA-7DAYS-XXXX</code>, <code>GOMEGA-1DAY-XXXX</code>.</p>
    </div>
  </div>

  <!-- Sign-in modal -->
  <div id="signinModal" class="modal-backdrop hidden" role="dialog" aria-modal="true">
    <div class="modal">
      <h3>Sign in to Gomega</h3>
      <p class="small">Sign in to save your chat, use keys, and unlock premium features.</p>

      <div style="margin-top:8px">
        <label class="small">Email</label>
        <input id="authEmail" class="input" placeholder="you@example.com" />
      </div>
      <div style="margin-top:8px">
        <label class="small">Password</label>
        <input id="authPass" type="password" class="input" placeholder="password" />
      </div>

      <div style="margin-top:10px;display:flex;gap:8px">
        <button id="signInBtn" class="btn primary">Sign in</button>
        <button id="createBtn" class="btn ghost">Create account</button>
        <button id="anonBtn" class="btn ghost">Continue anonymously</button>
      </div>

      <div style="margin-top:12px" class="small muted">
        <em>Admins set in the site config can add license keys to Firestore.</em>
      </div>
    </div>
  </div>

  <!-- Admin Modal (firestore-based) -->
  <div id="adminModal" class="modal-backdrop hidden" role="dialog" aria-modal="true">
    <div class="modal">
      <h3>Admin — Manage Keys</h3>
      <p class="small">Add or remove license keys (requires admin account).</p>

      <div style="margin-top:8px">
        <label class="small">Key</label>
        <input id="adminKeyInput" class="input" placeholder="GOMEGA-LIFETIME-XXXX" />
      </div>

      <div style="margin-top:8px;display:flex;gap:8px">
        <select id="adminKeyType" class="select">
          <option value="lifetime">Lifetime</option>
          <option value="7days">7 days</option>
          <option value="1day">1 day</option>
        </select>
        <button id="adminAddBtn" class="btn primary">Add</button>
        <button id="adminGenBtn" class="btn ghost">Generate</button>
      </div>

      <div style="margin-top:12px">
        <div class="small">Registered keys</div>
        <ul id="registeredKeys" style="margin-top:8px;max-height:200px;overflow:auto;padding-left:16px"></ul>
      </div>

      <div style="margin-top:12px;display:flex;gap:8px">
        <button id="adminClose" class="btn ghost">Close</button>
      </div>
    </div>
  </div>

  <!-- Toast container -->
  <div id="toastRoot" style="position:fixed;right:20px;bottom:20px;z-index:100"></div>

  <!-- Firebase + app script -->
  <script type="module">
    // ---------- CONFIG (CHANGE BEFORE DEPLOY) ----------
    // Replace with your Firebase Web config
    const FIREBASE_CONFIG = {
      apiKey: "AIzaSyCosaEc1xMspmr9Z0ykfI3_6Ksrp-3r5WM",
      authDomain: "gomega-65e3f.firebaseapp.com",
      projectId: "gomega-65e3f",
      appId: "1:212961835634:web:12330a07ff79668ea060eb",
      // ...other values
    };

    // Cloud Function endpoint (your deployed function). Example:
    // const CLOUD_FUNCTION_URL = 'https://us-central1-YOUR_PROJECT.cloudfunctions.net/api/generate'
    const CLOUD_FUNCTION_URL = ""; // <-- set this to your cloud function URL

    // Admin UIDs that can add keys to Firestore (set to the UID(s) you want)
    const ADMIN_UIDS = ["PUT_ADMIN_UID_HERE"]; // e.g. ["abc123Uid"]
    // Free daily limit
    const FREE_DAILY_LIMIT = 50;

    // ----------------- END CONFIG ---------------------

    // Firebase modular imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, query, where, getDocs, deleteDoc, doc, setDoc, serverTimestamp, orderBy } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const app = initializeApp(FIREBASE_CONFIG);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // DOM helpers
    const $ = id => document.getElementById(id);
    const messagesEl = $('messages');
    const inputBox = $('inputBox');
    const sendBtn = $('sendBtn');
    const modelSelect = $('modelSelect');
    const activateBtn = $('activateBtn');
    const activateModal = $('activateModal');
    const activateConfirm = $('activateConfirm');
    const activateCancel = $('activateCancel');
    const keyInput = $('keyInput');
    const licenseDot = $('licenseDot');
    const licenseText = $('licenseText');
    const licenseExpire = $('licenseExpire');
    const usedCountEl = $('usedCount');
    const remainingCountEl = $('remainingCount');
    const chatInfo = $('chatInfo');
    const signinBtn = $('signinBtn');
    const signinModal = $('signinModal');
    const authEmail = $('authEmail');
    const authPass = $('authPass');
    const signInBtn = $('signInBtn');
    const createBtn = $('createBtn');
    const anonBtn = $('anonBtn');

    // Admin
    const adminModal = $('adminModal');
    const adminKeyInput = $('adminKeyInput');
    const adminKeyType = $('adminKeyType');
    const adminAddBtn = $('adminAddBtn');
    const adminGenBtn = $('adminGenBtn');
    const registeredKeysUL = $('registeredKeys');
    const adminClose = $('adminClose');

    // localStorage keys
    const CHAT_COUNT_KEY = 'gomega_chat_count';
    const MSG_STORAGE_KEY = 'gomega_messages';

    // state
    let isTyping = false;
    let currentUser = null;
    let userLicense = null; // license details assigned to this user (retrieved from Firestore)

    // Utility: ISO date
    const nowISODate = () => new Date().toISOString().slice(0,10);

    // init
    attachEvents();
    loadMessages();
    updateChatCountsUI();
    showInitialGreeting();

    // ---------------- Firebase Auth flow ----------------
    // set up auth state listener
    onAuthStateChanged(auth, async (user) => {
      currentUser = user;
      if(user){
        // check for license assigned to this user
        await fetchUserLicense();
        updateLicenseUI();
        signinModal.classList.add('hidden');
        signinBtn.textContent = 'Account';
      } else {
        currentUser = null;
        userLicense = null;
        updateLicenseUI();
        signinBtn.textContent = 'Sign in';
      }
    });

    // Sign-in button opens modal
    signinBtn.addEventListener('click', () => {
      signinModal.classList.toggle('hidden');
    });

    signInBtn.addEventListener('click', async () => {
      const email = authEmail.value.trim();
      const pass = authPass.value;
      if(!email || !pass) return toast('Enter email & password');
      try {
        await signInWithEmailAndPassword(auth, email, pass);
        toast('Signed in');
        signinModal.classList.add('hidden');
      } catch(e){
        console.error(e);
        toast('Sign-in failed: ' + (e.message || e.code));
      }
    });

    createBtn.addEventListener('click', async () => {
      const email = authEmail.value.trim();
      const pass = authPass.value;
      if(!email || !pass) return toast('Enter email & password');
      try {
        await createUserWithEmailAndPassword(auth, email, pass);
        toast('Account created & signed in');
        signinModal.classList.add('hidden');
      } catch(e){
        console.error(e);
        toast('Create failed: ' + (e.message || e.code));
      }
    });

    anonBtn.addEventListener('click', async () => {
      try {
        await signInAnonymously(auth);
        toast('Signed in anonymously');
        signinModal.classList.add('hidden');
      } catch(e){
        console.error(e);
        toast('Anonymous sign-in failed');
      }
    });

    // ---------------- License handling (Firestore) ----------------
    // We store licenses in Firestore collection 'licenses'.
    // Admin accounts (UIDs in ADMIN_UIDS) can add keys via admin modal which writes into Firestore.

    async function fetchUserLicense(){
      userLicense = null;
      if(!currentUser) return;
      // query licenses where assignedTo == current uid
      try {
        const q = query(collection(db, 'licenses'), where('assignedTo', '==', currentUser.uid));
        const snap = await getDocs(q);
        if(!snap.empty){
          const docData = snap.docs[0].data();
          docData._id = snap.docs[0].id;
          userLicense = docData;
        } else {
          // Optionally auto-assign unclaimed keys (if you want) — we keep manual assignment for security.
          userLicense = null;
        }
      } catch(e){
        console.error('fetchUserLicense error', e);
      }
    }

    function licenseActive(){
      if(!userLicense) return false;
      if(userLicense.expiresAt === 'lifetime') return true;
      const expires = new Date(userLicense.expiresAt);
      return expires > new Date();
    }

    function updateLicenseUI(){
      if(licenseActive()){
        licenseDot.className = 'dot ok';
        licenseText.textContent = `Premium active — ${userLicense.type.toUpperCase()}`;
        licenseExpire.textContent = userLicense.expiresAt === 'lifetime' ? 'Never expires' : `Expires ${new Date(userLicense.expiresAt).toLocaleString()}`;
        chatInfo.textContent = 'Premium: Unlimited messages';
      } else {
        licenseDot.className = 'dot bad';
        licenseText.textContent = 'Not premium — limited';
        licenseExpire.textContent = '';
        chatInfo.textContent = `Free: ${FREE_DAILY_LIMIT} messages/day`;
      }
      updateChatCountsUI();
    }

    // Activate modal events
    activateBtn.addEventListener('click', () => {
      activateModal.classList.remove('hidden');
      keyInput.value = '';
      setTimeout(()=> keyInput.focus(), 100);
    });
    activateCancel.addEventListener('click', ()=> activateModal.classList.add('hidden'));

    // When user clicks Activate — we look up the key in Firestore and mark it assignedTo = currentUser.uid (server-side rules recommended).
    activateConfirm.addEventListener('click', async () => {
      const rawKey = keyInput.value.trim();
      if(!rawKey) return toast('Enter a key');
      if(!currentUser) return toast('Sign in first to activate a key');

      try {
        // find license matching key & not consumed
        const q = query(collection(db, 'licenses'), where('key', '==', rawKey));
        const snap = await getDocs(q);
        if(snap.empty){ toast('Key not found'); return; }
        const docRef = snap.docs[0];
        const data = docRef.data();
        // If license already assigned to someone else and consumed, reject (alternatively allow reassign)
        if(data.assignedTo && data.assignedTo !== currentUser.uid){
          toast('Key already used by another account');
          return;
        }
        // assign to current user (client-side write). For production, require server-side admin operation or rules.
        const licenseDocRef = doc(db, 'licenses', docRef.id);
        // We set fields: assignedTo, activatedAt
        await setDoc(licenseDocRef, { ...data, assignedTo: currentUser.uid, activatedAt: new Date().toISOString() }, { merge: true });
        toast('Activated — premium unlocked');
        // refresh
        await fetchUserLicense();
        updateLicenseUI();
        activateModal.classList.add('hidden');
      } catch(e){
        console.error(e);
        toast('Activation failed');
      }
    });

    // ---------------- Admin UI (client writes to Firestore) ----------------
    // Admins are the users with UID in ADMIN_UIDS. In production only use server admin flows or strict Firestore rules.
    window.addEventListener('keydown', (e) => {
      if(e.ctrlKey && e.shiftKey && e.key.toLowerCase() === 'a'){
        // open admin modal only if signed in as admin
        if(!currentUser || !ADMIN_UIDS.includes(currentUser.uid)){
          toast('Admins only');
          return;
        }
        adminModal.classList.remove('hidden');
        renderRegisteredKeys();
      }
    });

    adminClose.addEventListener('click', ()=> adminModal.classList.add('hidden'));

    adminAddBtn.addEventListener('click', async () => {
      if(!currentUser || !ADMIN_UIDS.includes(currentUser.uid)){ toast('Admin only'); return; }
      const key = adminKeyInput.value.trim();
      if(!key) return toast('Enter a key');
      const type = adminKeyType.value;
      try {
        const expiresAt = (type === 'lifetime') ? 'lifetime' : new Date(Date.now() + (type === '7days' ? 7 : 1) * 24*60*60*1000).toISOString();
        await addDoc(collection(db, 'licenses'), {
          key, type, expiresAt, assignedTo: null, createdAt: serverTimestamp()
        });
        adminKeyInput.value = '';
        renderRegisteredKeys();
        toast('Key added to Firestore');
      } catch(e){
        console.error(e);
        toast('Add failed');
      }
    });

    adminGenBtn.addEventListener('click', async () => {
      if(!currentUser || !ADMIN_UIDS.includes(currentUser.uid)){ toast('Admin only'); return; }
      const type = adminKeyType.value;
      const k = randomKey(type);
      adminKeyInput.value = k;
    });

    async function renderRegisteredKeys(){
      registeredKeysUL.innerHTML = '<li class="small muted">Loading…</li>';
      try {
        const q = query(collection(db, 'licenses'), orderBy('createdAt','desc'));
        const snap = await getDocs(q);
        registeredKeysUL.innerHTML = '';
        if(snap.empty){ registeredKeysUL.innerHTML = '<li class="small muted">No keys</li>'; return; }
        snap.forEach(docSnap => {
          const d = docSnap.data();
          const li = document.createElement('li');
          li.style.display='flex'; li.style.justifyContent='space-between'; li.style.alignItems='center';
          li.innerHTML = `<div style="font-family:monospace">${d.key}</div><div style="color:var(--muted)">${d.type} ${d.assignedTo ? '(used)': ''}</div>`;
          // remove button
          const del = document.createElement('button'); del.textContent = 'Remove'; del.className='btn ghost';
          del.onclick = async () => {
            if(!confirm('Remove this key?')) return;
            try {
              await deleteDoc(doc(db, 'licenses', docSnap.id));
              renderRegisteredKeys();
              toast('Removed');
            } catch(e){
              console.error(e);
              toast('Remove failed');
            }
          };
          li.appendChild(del);
          registeredKeysUL.appendChild(li);
        });
      } catch(e){
        console.error(e);
        registeredKeysUL.innerHTML = '<li class="small muted">Error loading keys</li>';
      }
    }

    function randomKey(type){
      const rnd = Math.random().toString(36).slice(2,10).toUpperCase();
      const prefix = type === 'lifetime' ? 'GOMEGA-LIFETIME-' : (type === '7days' ? 'GOMEGA-7DAYS-' : 'GOMEGA-1DAY-');
      return prefix + rnd;
    }

    // ---------------- Chat message storage & UI helpers ----------------
    function loadMessages(){
      try {
        const arr = JSON.parse(localStorage.getItem(MSG_STORAGE_KEY) || '[]');
        messagesEl.innerHTML = '';
        arr.forEach(m => appendMessageToDOM(m));
        messagesEl.scrollTop = messagesEl.scrollHeight;
      } catch(e){}
    }

    function saveMessages(arr){
      localStorage.setItem(MSG_STORAGE_KEY, JSON.stringify(arr));
    }
    function pushMessage(obj){
      const arr = JSON.parse(localStorage.getItem(MSG_STORAGE_KEY) || '[]');
      arr.push(obj);
      saveMessages(arr);
    }

    function appendMessageToDOM(m){
      const div = document.createElement('div');
      div.className = 'msg ' + (m.role === 'user' ? 'user' : 'ai');
      const meta = document.createElement('div'); meta.className = 'meta';
      meta.textContent = `${m.role === 'user' ? 'You' : 'Gomega AI'} • ${new Date(m.ts).toLocaleTimeString()}`;
      const content = document.createElement('div'); content.innerHTML = sanitize(m.text).replace(/\n/g,'<br>');
      div.appendChild(meta);
      div.appendChild(content);
      messagesEl.appendChild(div);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function sanitize(s){
      const t = document.createElement('div');
      t.textContent = s;
      return t.innerHTML;
    }

    function toast(msg){
      const root = $('toastRoot');
      const el = document.createElement('div');
      el.style.background='linear-gradient(90deg,#0b1222,#071226)';
      el.style.padding='10px 14px';
      el.style.borderRadius='10px';
      el.style.boxShadow='0 8px 30px rgba(2,6,23,0.6)';
      el.style.color='white';
      el.style.fontSize='13px';
      el.style.marginTop='8px';
      el.textContent = msg;
      root.appendChild(el);
      setTimeout(()=> { el.style.transition='opacity 400ms'; el.style.opacity='0'; setTimeout(()=> el.remove(),420); }, 2200);
    }

    // ---------------- Chat counts (daily) ----------------
    function getChatCountObj(){
      try {
        const raw = localStorage.getItem(CHAT_COUNT_KEY);
        if(!raw) return { date: nowISODate(), count: 0 };
        const obj = JSON.parse(raw);
        if(obj.date !== nowISODate()) return { date: nowISODate(), count: 0 };
        return obj;
      } catch(e){ return { date: nowISODate(), count: 0 }; }
    }
    function setChatCountObj(obj){ localStorage.setItem(CHAT_COUNT_KEY, JSON.stringify(obj)); }
    function incrementChatCount(){
      const obj = getChatCountObj();
      obj.count = (obj.count || 0) + 1;
      setChatCountObj(obj);
      updateChatCountsUI();
    }
    function updateChatCountsUI(){
      const obj = getChatCountObj();
      const isPrem = licenseActive();
      usedCountEl.textContent = obj.count || 0;
      remainingCountEl.textContent = isPrem ? '∞' : Math.max(0, FREE_DAILY_LIMIT - (obj.count||0));
      chatInfo.textContent = isPrem ? 'Premium: Unlimited messages' : `Free: ${FREE_DAILY_LIMIT} messages/day`;
    }

    // ---------------- Send / typing logic ----------------
    sendBtn.addEventListener('click', trySend);
    inputBox.addEventListener('keydown', (e) => {
      if(e.key === 'Enter' && !e.shiftKey){ e.preventDefault(); trySend(); }
    });

    function trySend(){
      if(isTyping){ toast('Please wait — AI is typing'); return; }
      const text = inputBox.value.trim();
      if(!text) return;
      const selected = modelSelect.options[modelSelect.selectedIndex];
      if(selected.dataset && selected.dataset.premium && !licenseActive()){
        activateModal.classList.remove('hidden');
        toast('This model requires Premium');
        return;
      }
      if(!licenseActive()){
        const obj = getChatCountObj();
        if((obj.count||0) >= FREE_DAILY_LIMIT){
          activateModal.classList.remove('hidden');
          toast('You reached your daily free limit — upgrade to Gomega Plus');
          return;
        }
      }
      const userMsg = { role:'user', text, ts: new Date().toISOString() };
      appendMessageToDOM(userMsg);
      pushMessage(userMsg);
      inputBox.value = '';
      incrementChatCount();
      runAI(text, modelSelect.value);
    }

    function setTyping(v){
      isTyping = v;
      sendBtn.disabled = v;
      inputBox.disabled = v;
      if(v){
        const bubble = document.createElement('div');
        bubble.className = 'msg ai';
        bubble.id = 'typingBubble';
        bubble.innerHTML = `<div class="meta">Gomega AI • typing...</div><div><span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span></div>`;
        messagesEl.appendChild(bubble);
        messagesEl.scrollTop = messagesEl.scrollHeight;
      } else {
        const tb = $('typingBubble');
        if(tb) tb.remove();
      }
    }

    // ---------------- AI integration (calls cloud function; fallback) ----------------
    async function runAI(userText, model){
      setTyping(true);

      // Build context: last 8 messages (server should also append a system prompt)
      const msgs = JSON.parse(localStorage.getItem(MSG_STORAGE_KEY) || '[]');
      const last = msgs.slice(-8).map(m => ({ role: m.role, text: m.text, ts: m.ts }));

      // If no backend configured, use local fallback
      if(!CLOUD_FUNCTION_URL){
        const simulatedReply = await simulatedAIResponse(userText, model);
        appendAIReply(simulatedReply);
        setTyping(false);
        return;
      }

      try {
        let idToken = null;
        if(currentUser) {
          idToken = await currentUser.getIdToken();
        }

        const resp = await fetch(CLOUD_FUNCTION_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            ...(idToken ? { 'Authorization': 'Bearer ' + idToken } : {})
          },
          body: JSON.stringify({ messages: last, model })
        });

        if(!resp.ok){
          // backend returned error — fallback
          const err = await resp.json().catch(()=>({error:'unknown'}));
          console.error('Backend error', err);
          const simulatedReply = await simulatedAIResponse(userText, model);
          appendAIReply(simulatedReply + '\n\n(Note: backend error: ' + (err.error || resp.status) + ')');
          setTyping(false);
          return;
        }
        const j = await resp.json();
        appendAIReply(j.reply || 'No reply');
      } catch(e){
        console.error(e);
        const simulatedReply = await simulatedAIResponse(userText, model);
        appendAIReply(simulatedReply + '\n\n(Note: network error)');
      } finally {
        setTyping(false);
      }
    }

    function appendAIReply(text){
      const aiMsg = { role:'ai', text, ts: new Date().toISOString() };
      appendMessageToDOM(aiMsg);
      pushMessage(aiMsg);
    }

    // ---------------- Local fallback AI (improved, no "(Free model response.)") ----------------
    function simulatedAIResponse(userText, model){
      return new Promise((resolve) => {
        const t = Math.max(600, Math.min(2200, userText.length * 22));
        setTimeout(()=>{
          const txt = userText.toLowerCase();
          let reply = "I didn't quite catch that. Can you rephrase?";
          if(/^\s*(hi|hello|hey|howdy|sup)\b/.test(txt)) reply = "Hey — I'm Gomega AI. How can I help you today?";
          else if(/\b(help|how do i|how to|what is|explain)\b/.test(txt)) reply = "I can help with step-by-step instructions, code snippets, or concept explanations. What do you want to do?";
          else if(/\b(openai|api|key|backend)\b/.test(txt)) reply = "To use a more powerful model, connect your backend and pick a premium model. I can show you how to wire it up.";
          else if(/\b(buy|premium|upgrade|plus)\b/.test(txt)) reply = "Upgrade by entering the key you received after purchase (Activate → paste your key).";
          else if(txt.length < 30) reply = "Give me a bit more detail — what's your goal or what should I help with?";
          else {
            reply = "Got it. Quick summary: " + (userText.length > 120 ? userText.slice(0,120) + '...' : userText) + "\n\nWhat would you like me to do next?";
          }

          // Add model note without 'free' suffix — server responses will be authoritative
          if(model.includes('v5')) reply += "\n\n(Using gomega v5.o mini — premium behavior simulated.)";
          else if(model.includes('v4')) reply += "\n\n(Using gomega v4.0 mini — premium behavior simulated.)";
          else reply += "\n\n(Using free model.)";
          resolve(reply);
        }, t);
      });
    }

    // ---------------- Misc helpers ----------------
    function attachEvents(){
      // click help (quick message)
      $('glogo').addEventListener('click', ()=> {
        appendAIReply("Quick help:\n- Activate to redeem a key\n- Sign in to save chats\n- Admins can add keys to Firestore\n- Use a backend function to enable premium models");
      });

      modelSelect.addEventListener('change', ()=>{
        const sel = modelSelect.options[modelSelect.selectedIndex];
        if(sel.dataset && sel.dataset.premium && !licenseActive()){
          toast('That model requires Premium — click Activate!');
        }
      });

      messagesEl.addEventListener('click', ()=> inputBox.focus());
    }

    function showInitialGreeting(){
      const obj = getChatCountObj();
      if(!licenseActive() && (obj.count||0) >= FREE_DAILY_LIMIT){
        appendMessageToDOM({role:'ai', text:'You reached your free daily limit. Activate a premium key to continue chatting.', ts: new Date().toISOString()});
      } else {
        appendMessageToDOM({role:'ai', text:'Welcome! Ask me anything — or activate Premium for more models/features.', ts: new Date().toISOString()});
      }
    }

    // Expose a few utility functions for debugging
    window.Gomega = {
      randomKey,
      getChatCountObj,
      setChatCountObj: (x) => setChatCountObj(x),
      cloudFunctionUrl: () => CLOUD_FUNCTION_URL
    };

    // keep messages scrolled
    const obs = new MutationObserver(() => messagesEl.scrollTop = messagesEl.scrollHeight);
    obs.observe(messagesEl, { childList: true });
  </script>
</body>
</html>
