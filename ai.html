<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gomega AI — ai.html</title>
  <style>
    /* styling — unchanged look & feel */
    :root{ --bg:#0f1724; --card:#0b1220; --accent:#f6b93b; --muted:#94a3b8; --glass: rgba(255,255,255,0.04); --danger:#ef4444; --success:#10b981; }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue"; background:linear-gradient(180deg,#071026 0%, #081223 100%); color:#e6eef6; min-height:100vh; display:flex; align-items:center; justify-content:center; padding:20px;}
    .container{width:100%; max-width:1100px; background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-radius:12px; box-shadow:0 10px 30px rgba(2,6,23,0.7); overflow:hidden; display:grid; grid-template-columns:340px 1fr; gap:0; min-height:720px;}
    .left{padding:20px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00)); border-right:1px solid rgba(255,255,255,0.03)}
    .logo-wrap{display:flex;flex-direction:column;align-items:center;gap:10px;padding-bottom:12px;border-bottom:1px dashed rgba(255,255,255,0.03)}
    .glogo{width:160px;height:72px;border-radius:14px;background:linear-gradient(90deg,#0ea5a9,#7c3aed);display:flex;align-items:center;justify-content:center;font-weight:800;font-size:22px;color:white;animation:logoBounce 1.6s infinite}
    @keyframes logoBounce{0%{transform:translateY(0)}50%{transform:translateY(-6px) scale(1.01)}100%{transform:translateY(0)}}
    .subtitle{color:var(--muted);font-size:13px;text-align:center;max-width:260px}
    .controls{margin-top:14px;display:flex;flex-direction:column;gap:10px}
    .select,.btn,.input{background:var(--glass);border:1px solid rgba(255,255,255,0.04);padding:10px 12px;border-radius:10px;color:inherit;font-size:14px}
    .btn{cursor:pointer;display:inline-flex;align-items:center;justify-content:center;gap:8px}
    .btn.primary{background:linear-gradient(90deg,#f59e0b,#ef4444);color:#081221;font-weight:600;border:none;box-shadow:0 6px 18px rgba(239,68,68,0.12)}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.03)}
    .status{display:flex;gap:8px;align-items:center;font-size:13px;color:var(--muted);margin-top:6px}
    .dot{width:10px;height:10px;border-radius:50%}
    .dot.ok{background:var(--success)}
    .dot.warn{background:#f59e0b}
    .dot.bad{background:var(--danger)}
    .right{display:flex;flex-direction:column}
    .messages{flex:1;padding:18px;overflow:auto;display:flex;flex-direction:column;gap:12px;background:repeating-linear-gradient(180deg, rgba(255,255,255,0.005) 0 1px, transparent 1px 48px)}
    .msg{max-width:78%;padding:12px 14px;border-radius:12px;line-height:1.4;opacity:0;transform:translateY(8px);animation:msgIn 280ms ease forwards;position:relative}
    @keyframes msgIn{to{opacity:1;transform:translateY(0)}}
    .msg.user{margin-left:auto;background:linear-gradient(180deg,#0b1222,#08101a);border:1px solid rgba(255,255,255,0.02)}
    .msg.ai{background:linear-gradient(180deg,#0b1b2a,#072232);border:1px solid rgba(255,255,255,0.03)}
    .msg .copyBtn{position:absolute;right:8px;top:8px;background:transparent;border:none;color:var(--muted);cursor:pointer;display:none}
    .msg.ai:hover .copyBtn{display:block}
    .meta{font-size:12px;color:var(--muted);margin-bottom:6px}
    .composer{padding:12px;border-top:1px solid rgba(255,255,255,0.02);display:flex;gap:10px;align-items:center;background:linear-gradient(180deg, rgba(0,0,0,0.02), transparent)}
    .text-in{flex:1;border-radius:12px;padding:10px 12px;background:transparent;color:inherit;border:1px solid rgba(255,255,255,0.03);min-height:48px;font-size:14px;resize:none}
    .send{min-width:120px;padding:10px 14px;border-radius:10px;font-weight:600}
    .small{font-size:12px;color:var(--muted)}
    .typing-dot{display:inline-block;width:8px;height:8px;border-radius:50%;background:rgba(255,255,255,0.55);margin-right:6px;animation:typingBounce 0.9s infinite}
    @keyframes typingBounce{0%{transform:translateY(0)}50%{transform:translateY(-4px)}100%{transform:translateY(0)}}
    .modal-backdrop{position:fixed;inset:0;background:rgba(2,6,23,0.6);display:flex;align-items:center;justify-content:center;z-index:50}
    .modal{width:520px;background:#071226;border-radius:12px;padding:16px;box-shadow:0 10px 60px rgba(2,6,23,0.8)}
    .muted{color:var(--muted)}
    footer.small{padding:10px 18px;text-align:center;border-top:1px dashed rgba(255,255,255,0.02);font-size:12px;color:var(--muted)}
    .featureRow{display:flex;align-items:center;justify-content:space-between;gap:8px}
    .toggle{display:inline-flex;align-items:center;gap:8px}
    .hidden{display:none}
    .uploader { margin-top:12px; display:flex; gap:8px; align-items:center; }
    .uploader img { max-width:100%; border-radius:8px; max-height:120px; }
    @media(max-width:980px){.container{grid-template-columns:1fr;max-width:720px}.left{order:2}}
  </style>
</head>
<body>
  <div class="container" role="application" aria-label="Gomega AI">
    <div class="left">
      <div class="logo-wrap">
        <div class="glogo" id="glogo">GOMEGA</div>
        <div class="subtitle">Gomega AI — chat, math steps, premium features & global keys (Firebase support).</div>
      </div>

      <div class="controls" id="controls">
        <label class="small muted">AI Model</label>
        <select id="modelSelect" class="select" aria-label="AI model">
          <option value="gomega-v1">gomega v1 — free</option>
          <option value="gomega-v2">gomega v2 — free</option>
          <option value="gomega-v3">gomega v3 — free</option>
          <option value="gomega-v4" data-premium="true">gomega v4.0 mini — premium</option>
          <option value="gomega-v5" data-premium="true">gomega v5.o mini — premium</option>
        </select>

        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="activateBtn" class="btn ghost">⚜️ Activate</button>
          <button id="helpBtn" class="btn ghost">?</button>
        </div>

        <div class="status" id="licenseStatus" style="margin-top:10px">
          <span class="dot bad" id="licenseDot"></span>
          <div>
            <div id="licenseText">Not premium — limited</div>
            <div class="small muted" id="licenseExpire"></div>
          </div>
        </div>

        <div style="margin-top:12px">
          <div class="small muted">Chat limit</div>
          <div id="chatInfo" class="small">Free: 25 messages/day • Premium: 1,300 messages / 2 days</div>
        </div>

        <div style="margin-top:12px" id="premiumFeatures" class="hidden">
          <div class="small muted">Premium features</div>
          <div style="margin-top:8px;display:flex;flex-direction:column;gap:8px">
            <label class="featureRow"><span>Priority Mode (faster replies)</span><input id="priorityMode" type="checkbox" /></label>
            <label class="featureRow"><span>Conversation Memory</span><input id="convMemoryToggle" type="checkbox" /></label>
            <label class="featureRow"><span>Enable Beta Models</span><input id="betaModelsToggle" type="checkbox" /></label>
            <div style="display:flex;gap:8px">
              <button id="exportChatBtn" class="btn ghost">Export Chat</button>
              <button id="clearMemoryBtn" class="btn ghost">Clear Memory</button>
            </div>

            <div class="uploader">
              <label class="small muted">Upload Photo (Premium)</label>
              <input type="file" id="photoInput" accept="image/*" />
              <button id="photoUploadBtn" class="btn ghost">Upload</button>
            </div>
            <div id="photoPreviewArea"></div>
          </div>
        </div>
      </div>

      <footer class="small" style="margin-top:14px">Press <strong>Ctrl+Shift+1</strong> for Admin keys panel</footer>
    </div>

    <div class="right">
      <div class="messages" id="messages" tabindex="0" aria-label="Chat messages"></div>

      <div class="composer">
        <textarea id="inputBox" class="text-in" placeholder="Send a message..." rows="1" aria-label="Message input"></textarea>
        <button id="sendBtn" class="btn primary send">Send</button>
      </div>

      <footer class="small" style="padding:10px 18px;color:var(--muted)">
        <span id="usedCount">0</span> messages used today • <span id="remainingCount">25</span> remaining
      </footer>
    </div>
  </div>

  <!-- Activate Modal -->
  <div id="activateModal" class="modal-backdrop hidden" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <h3>Activate Premium</h3>
      <p class="muted">Enter your premium key. Keys can be consumable (usesLeft) or reusable.</p>
      <div style="margin-top:8px">
        <label class="small muted">Premium Key</label>
        <input id="keyInput" class="input" placeholder="GOMEGA-LIFETIME-XXXXXXXX" />
      </div>

      <div class="row" style="margin-top:10px;display:flex;gap:8px">
        <button id="activateConfirm" class="btn primary">Activate</button>
        <button id="activateCancel" class="btn ghost">Cancel</button>
      </div>

      <p class="small muted" style="margin-top:10px">Examples: <code>GOMEGA-LIFETIME-XXXX</code>, <code>GOMEGA-7DAYS-XXXX</code>. Admins set consumable & usesLeft.</p>
    </div>
  </div>

  <!-- Admin Modal -->
  <div id="adminModal" class="modal-backdrop hidden" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <h3>Admin — Manage Keys</h3>
      <p class="muted">Add keys for anyone to activate. Set consumable (usesLeft) or reusable.</p>

      <div style="margin-top:8px">
        <label class="small muted">Admin password</label>
        <input id="adminPass" class="input" placeholder="password" />
      </div>

      <div style="margin:8px 0">
        <label class="small muted">Key to add</label>
        <input id="adminKeyInput" class="input" placeholder="GOMEGA-LIFETIME-XXXX" />
      </div>

      <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
        <select id="adminKeyType" class="select">
          <option value="lifetime">lifetime</option>
          <option value="7days">7 days</option>
          <option value="1day">1 day</option>
          <option value="2days1300">2 days (1,300 messages)</option>
        </select>

        <label class="toggle small muted"><input id="adminConsumable" type="checkbox" /> consumable</label>
        <input id="adminUsesLeft" type="number" class="input" placeholder="usesLeft (if consumable)" style="width:140px" />

        <button id="adminAddBtn" class="btn primary">Add Key</button>
        <button id="adminGenBtn" class="btn ghost">Generate</button>
      </div>

      <div style="margin-top:12px">
        <div class="small muted">Registered keys (global if Firebase configured)</div>
        <ul id="registeredKeys" style="margin-top:8px;max-height:200px;overflow:auto;padding-left:12px"></ul>
      </div>

      <div style="margin-top:12px;display:flex;gap:8px">
        <button id="adminClose" class="btn ghost">Close</button>
      </div>
    </div>
  </div>

  <!-- Module script (no template literals anywhere) -->
  <script type="module">
    // import your firebase.js (unchanged from your side)
    import { db as importedDb } from './js/firebase.js';
    import { collection, query, where, limit, getDocs, onSnapshot, addDoc, deleteDoc, doc, runTransaction } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';
    import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js';

    // CONFIG
    var FREE_DAILY_LIMIT = 25;
    var PREMIUM_QUOTA = 1300;
    var PREMIUM_QUOTA_DAYS = 2;
    // very strong admin password as requested
    var ADMIN_PASSWORD = 'X9$@!3zLp#7^qT!rM8&*VbK0~F4+gWxZs?YjNhRu';
    var LICENSE_STORAGE_KEY = 'gomega_license_v3';
    var KEYS_STORAGE_KEY = 'gomega_valid_keys_v3';
    var CHAT_COUNT_KEY = 'gomega_chat_count_v3';
    var MSG_STORAGE_KEY = 'gomega_messages_v3';
    var MEMORY_KEY = 'gomega_memory_v3';

    // DOM helpers
    function $(id) { return document.getElementById(id); }

    // Elements
    var messagesEl = $('messages');
    var inputBox = $('inputBox');
    var sendBtn = $('sendBtn');
    var modelSelect = $('modelSelect');
    var activateBtn = $('activateBtn');
    var activateModal = $('activateModal');
    var activateConfirm = $('activateConfirm');
    var activateCancel = $('activateCancel');
    var keyInput = $('keyInput');
    var licenseDot = $('licenseDot');
    var licenseText = $('licenseText');
    var licenseExpire = $('licenseExpire');
    var usedCountEl = $('usedCount');
    var remainingCountEl = $('remainingCount');
    var chatInfo = $('chatInfo');

    var premiumFeaturesEl = $('premiumFeatures');
    var priorityModeCheckbox = $('priorityMode');
    var convMemoryToggle = $('convMemoryToggle');
    var betaModelsToggle = $('betaModelsToggle');
    var exportChatBtn = $('exportChatBtn');
    var clearMemoryBtn = $('clearMemoryBtn');
    var photoInput = $('photoInput');
    var photoUploadBtn = $('photoUploadBtn');
    var photoPreviewArea = $('photoPreviewArea');

    var adminModal = $('adminModal');
    var adminPass = $('adminPass');
    var adminKeyInput = $('adminKeyInput');
    var adminKeyType = $('adminKeyType');
    var adminConsumable = $('adminConsumable');
    var adminUsesLeft = $('adminUsesLeft');
    var adminAddBtn = $('adminAddBtn');
    var adminGenBtn = $('adminGenBtn');
    var registeredKeysUL = $('registeredKeys');
    var adminClose = $('adminClose');

    // state
    var isTyping = false;
    var db = null;
    var useFirebase = false;
    var storage = null;

    if (typeof importedDb !== 'undefined' && importedDb) {
      db = importedDb;
      useFirebase = true;
      try { storage = getStorage(); } catch (e) { storage = null; console.warn('storage init error', e); }
      console.log('Firestore: using imported db');
    } else {
      console.warn('Firestore not available — using local fallback');
      useFirebase = false;
    }

    // ------- init -------
    init();
    function init() {
      loadLicenseUI();
      updateChatCountsUI();
      loadMessages();
      renderRegisteredKeys();
      attachEvents();
      if (useFirebase) fetchKeysFromFirestore();
      inputBox.focus();
      startupGreeting();
    }

    // ---------- local keys fallback ----------
    function getLocalKeys() {
      try { return JSON.parse(localStorage.getItem(KEYS_STORAGE_KEY) || '[]'); } catch (e) { return []; }
    }
    function saveLocalKeys(arr) {
      localStorage.setItem(KEYS_STORAGE_KEY, JSON.stringify(arr));
    }

    // ---------- firestore helpers ----------
    async function fetchKeysFromFirestore() {
      if (!useFirebase) return;
      try {
        var colRef = collection(db, 'gomega_keys');
        onSnapshot(colRef, function(snapshot) {
          var arr = [];
          snapshot.forEach(function(docSnap) {
            var d = docSnap.data();
            arr.push({ key: d.key, type: d.type, consumable: !!d.consumable, usesLeft: typeof d.usesLeft === 'number' ? d.usesLeft : null, createdAt: d.createdAt || null, docId: docSnap.id });
          });
          saveLocalKeys(arr);
          renderRegisteredKeys();
        });
      } catch (e) { console.warn('firestore listener error', e); }
    }

    async function addKeyToFirestore(obj) {
      if (!useFirebase) return false;
      try { await addDoc(collection(db, 'gomega_keys'), obj); return true; } catch (e) { console.warn('add key fail', e); return false; }
    }

    async function consumeKeyInFirestore(key) {
      if (!useFirebase) return { ok:false, reason:'firebase-not-enabled' };
      try {
        var q = query(collection(db, 'gomega_keys'), where('key','==',key), limit(1));
        var qSnap = await getDocs(q);
        if (qSnap.empty) return { ok:false, reason:'not-found' };
        var docSnap = qSnap.docs[0];
        var docRef = doc(db, 'gomega_keys', docSnap.id);
        await runTransaction(db, async function(tx) {
          var docCurrent = await tx.get(docRef);
          var data = docCurrent.data();
          if (!data) throw new Error('not-found');
          if (!data.consumable) return;
          var uses = typeof data.usesLeft === 'number' ? data.usesLeft : 0;
          if (uses <= 0) throw new Error('no-uses-left');
          tx.update(docRef, { usesLeft: uses - 1 });
        });
        return { ok:true };
      } catch (e) {
        return { ok:false, reason: e.message || 'error' };
      }
    }

    // ---------- license ----------
    function getLicense() {
      try { return JSON.parse(localStorage.getItem(LICENSE_STORAGE_KEY) || 'null'); } catch (e) { return null; }
    }
    function saveLicense(lic) { localStorage.setItem(LICENSE_STORAGE_KEY, JSON.stringify(lic)); }
    function clearLicense() { localStorage.removeItem(LICENSE_STORAGE_KEY); }

    function licenseActive() {
      var lic = getLicense();
      if (!lic) return false;
      if (lic.expiresAt === 'lifetime') return true;
      var expires = new Date(lic.expiresAt);
      if (!(expires > new Date())) return false;
      if (!lic.quota) return true;
      if (typeof lic.quota.remaining !== 'number') return true;
      return lic.quota.remaining > 0;
    }

    function loadLicenseUI() {
      var lic = getLicense();
      if (licenseActive()) {
        licenseDot.className = 'dot ok';
        licenseText.textContent = 'Premium active — ' + (lic.keyType ? lic.keyType.toUpperCase() : 'PREMIUM');
        licenseExpire.textContent = (lic.expiresAt === 'lifetime') ? 'Never expires' : ('Expires ' + (new Date(lic.expiresAt)).toLocaleString());
        premiumFeaturesEl.classList.remove('hidden');
        if (lic.quota && typeof lic.quota.remaining === 'number') remainingCountEl.textContent = lic.quota.remaining;
        else remainingCountEl.textContent = '∞';
      } else {
        licenseDot.className = 'dot bad';
        licenseText.textContent = 'Not premium — limited';
        licenseExpire.textContent = '';
        premiumFeaturesEl.classList.add('hidden');
        remainingCountEl.textContent = FREE_DAILY_LIMIT;
      }
      updateChatCountsUI();
    }

    // ---------- activation ----------
    async function validateKeyGlobal(key) {
      if (useFirebase) {
        try {
          var q = query(collection(db, 'gomega_keys'), where('key','==',key), limit(1));
          var qSnap = await getDocs(q);
          if (qSnap.empty) return null;
          var d = qSnap.docs[0].data();
          return { key: d.key, type: d.type || 'lifetime', consumable: !!d.consumable, usesLeft: typeof d.usesLeft === 'number' ? d.usesLeft : null };
        } catch (e) { console.warn('validateKeyGlobal error', e); }
      }
      var arr = getLocalKeys();
      for (var i = 0; i < arr.length; i++) { if (arr[i].key === key) return arr[i]; }
      return null;
    }

    function showActivateModal() {
      activateModal.classList.remove('hidden');
      keyInput.value = '';
      setTimeout(function(){ keyInput.focus(); }, 100);
    }
    activateBtn.addEventListener('click', showActivateModal);
    activateCancel.addEventListener('click', function(){ activateModal.classList.add('hidden'); });

    activateConfirm.addEventListener('click', async function() {
      var val = keyInput.value.trim();
      if (!val) { alert('Enter a key'); return; }
      var found = await validateKeyGlobal(val);
      if (!found) { alert('Key not found — admin must register the key first.'); return; }

      if (found.consumable) {
        if (useFirebase) {
          var res = await consumeKeyInFirestore(found.key);
          if (!res.ok) { alert('Key cannot be used: ' + (res.reason || 'unknown')); return; }
        } else {
          var keys = getLocalKeys();
          var idx = -1;
          for (var i = 0; i < keys.length; i++) { if (keys[i].key === found.key) { idx = i; break; } }
          if (idx < 0) { alert('Key not found locally'); return; }
          if (typeof keys[idx].usesLeft !== 'number' || keys[idx].usesLeft <= 0) { alert('This key has no uses left'); return; }
          keys[idx].usesLeft = keys[idx].usesLeft - 1;
          if (keys[idx].usesLeft <= 0) keys.splice(idx,1);
          saveLocalKeys(keys);
        }
      }

      // compute expiry & quota
      var expires;
      var quota = null;
      if (found.type === 'lifetime') {
        expires = 'lifetime';
        quota = null;
      } else if (found.type === '2days1300') {
        var now2 = new Date();
        now2.setDate(now2.getDate() + 2);
        expires = now2.toISOString();
        quota = { remaining: PREMIUM_QUOTA, windowStart: Date.now(), windowDays: PREMIUM_QUOTA_DAYS };
      } else {
        var days = (found.type === '7days') ? 7 : 1;
        var now3 = new Date();
        now3.setDate(now3.getDate() + days);
        expires = now3.toISOString();
        quota = { remaining: PREMIUM_QUOTA, windowStart: Date.now(), windowDays: PREMIUM_QUOTA_DAYS };
      }

      saveLicense({ keyType: found.type, key: found.key, activatedAt: new Date().toISOString(), expiresAt: expires, quota: quota });
      loadLicenseUI();
      activateModal.classList.add('hidden');
      toast('Activated! Premium unlocked on this browser.');
    });

    // ---------- admin flow (Ctrl+Shift+1) ----------
    window.addEventListener('keydown', function(e) {
      if (e.ctrlKey && e.shiftKey && (e.key === '1' || e.code === 'Digit1')) {
        var pwd = prompt('Enter admin password:');
        if (pwd === ADMIN_PASSWORD) {
          adminPass.value = ADMIN_PASSWORD;
          adminModal.classList.remove('hidden');
          renderRegisteredKeys();
          toast('Admin unlocked');
        } else {
          alert('Wrong admin password!');
        }
      }
    });

    adminClose.addEventListener('click', function(){ adminModal.classList.add('hidden'); });

    adminAddBtn.addEventListener('click', async function() {
      var pass = adminPass.value;
      if (pass !== ADMIN_PASSWORD) { alert('Wrong admin password'); return; }
      var key = adminKeyInput.value.trim();
      if (!key) { alert('Enter a key'); return; }
      var type = adminKeyType.value;
      var consumable = adminConsumable.checked;
      var uses = parseInt(adminUsesLeft.value, 10);
      if (consumable && (!uses || uses <= 0)) { alert('Enter >0 usesLeft for consumable keys'); return; }
      var obj = { key: key, type: type, consumable: consumable, usesLeft: consumable ? uses : null, createdAt: new Date().toISOString() };
      if (useFirebase) {
        var ok = await addKeyToFirestore(obj);
        if (!ok) { alert('Failed to add key to Firestore'); return; }
      } else {
        var arr = getLocalKeys();
        arr.push(obj);
        saveLocalKeys(arr);
      }
      adminKeyInput.value = '';
      adminUsesLeft.value = '';
      renderRegisteredKeys();
      toast('Key added to registry');
    });

    adminGenBtn.addEventListener('click', async function() {
      var pass = adminPass.value;
      if (pass !== ADMIN_PASSWORD) { alert('Wrong admin password'); return; }
      var type = adminKeyType.value;
      var consumable = adminConsumable.checked;
      var uses = consumable ? Math.max(1, parseInt(adminUsesLeft.value || '1', 10)) : null;
      var k = randomKey(type);
      var obj = { key: k, type: type, consumable: consumable, usesLeft: uses, createdAt: new Date().toISOString() };
      if (useFirebase) {
        var ok2 = await addKeyToFirestore(obj);
        if (!ok2) { alert('Failed to add to Firestore'); return; }
      } else {
        var arr2 = getLocalKeys(); arr2.push(obj); saveLocalKeys(arr2);
      }
      renderRegisteredKeys();
      toast('Sample key generated: ' + k);
    });

    async function renderRegisteredKeys() {
      var arr = getLocalKeys();
      registeredKeysUL.innerHTML = '';
      if (!arr || arr.length === 0) {
        var li0 = document.createElement('li');
        li0.className = 'small muted';
        li0.textContent = 'No keys registered';
        registeredKeysUL.appendChild(li0);
        return;
      }
      for (var i = 0; i < arr.length; i++) {
        (function(item, idx){
          var li = document.createElement('li');
          li.style.display = 'flex';
          li.style.justifyContent = 'space-between';
          li.style.alignItems = 'center';
          li.style.marginBottom = '8px';
          var left = document.createElement('div');
          var title = document.createElement('div');
          title.style.fontFamily = 'monospace';
          title.textContent = item.key || '';
          var meta = document.createElement('div');
          meta.className = 'small muted';
          meta.textContent = (item.type || '') + ' ' + (item.consumable ? '(consumable)' : '(reusable)') + (item.consumable ? ' • usesLeft: ' + (item.usesLeft || 0) : '');
          left.appendChild(title);
          left.appendChild(meta);
          var right = document.createElement('div');
          var del = document.createElement('button');
          del.className = 'btn ghost';
          del.textContent = 'Remove';
          del.onclick = async function() {
            if (!confirm('Remove key?')) return;
            if (useFirebase) {
              try {
                var q = query(collection(db, 'gomega_keys'), where('key','==',item.key));
                var qSnap = await getDocs(q);
                var deletes = [];
                qSnap.forEach(function(docSnap){ deletes.push(deleteDoc(doc(db, 'gomega_keys', docSnap.id))); });
                await Promise.all(deletes);
              } catch (e) { console.warn('failed delete', e); alert('Failed to remove key in Firestore'); return; }
            } else {
              var keys = getLocalKeys();
              keys.splice(idx,1);
              saveLocalKeys(keys);
            }
            renderRegisteredKeys();
          };
          right.appendChild(del);
          li.appendChild(left);
          li.appendChild(right);
          registeredKeysUL.appendChild(li);
        })(arr[i], i);
      }
    }

    function randomKey(type) {
      var rnd = Math.random().toString(36).slice(2,12).toUpperCase();
      var prefix = 'GOMEGA-1DAY-';
      if (type === 'lifetime') prefix = 'GOMEGA-LIFETIME-';
      else if (type === '7days') prefix = 'GOMEGA-7DAYS-';
      else if (type === '2days1300') prefix = 'GOMEGA-2DAYS-1300-';
      return prefix + rnd;
    }

    // ---------- chat counting & quota ----------
    function nowISODate() { return new Date().toISOString().slice(0,10); }
    function getChatCountObj() {
      try {
        var raw = localStorage.getItem(CHAT_COUNT_KEY);
        if (!raw) return { date: nowISODate(), count: 0 };
        var obj = JSON.parse(raw);
        if (obj.date !== nowISODate()) return { date: nowISODate(), count: 0 };
        return obj;
      } catch (e) { return { date: nowISODate(), count: 0 }; }
    }
    function setChatCountObj(obj) { localStorage.setItem(CHAT_COUNT_KEY, JSON.stringify(obj)); }
    function incrementChatCount() {
      var obj = getChatCountObj();
      obj.count = (obj.count || 0) + 1;
      setChatCountObj(obj);
      updateChatCountsUI();
    }
    function updateChatCountsUI() {
      var obj = getChatCountObj();
      var isPrem = licenseActive();
      usedCountEl.textContent = obj.count || 0;
      var lic = getLicense();
      if (lic && lic.quota && typeof lic.quota.remaining === 'number') {
        remainingCountEl.textContent = lic.quota.remaining;
      } else if (isPrem && lic && lic.expiresAt === 'lifetime') {
        remainingCountEl.textContent = '∞';
      } else {
        remainingCountEl.textContent = Math.max(0, FREE_DAILY_LIMIT - (obj.count||0));
      }
      chatInfo.textContent = licenseActive() ? ('Premium: ' + ((getLicense().expiresAt === 'lifetime') ? 'Lifetime' : ('quota ' + (getLicense().quota ? getLicense().quota.remaining : '?') + ' left'))) : ('Free: ' + FREE_DAILY_LIMIT + ' messages/day');
    }

    function consumePremiumQuotaIfAny() {
      var lic = getLicense();
      if (!lic) return;
      if (lic.expiresAt === 'lifetime') return;
      if (!lic.quota) return;
      var now = Date.now();
      var windowStart = lic.quota.windowStart || now;
      var windowDays = lic.quota.windowDays || PREMIUM_QUOTA_DAYS;
      if (now - windowStart > windowDays * 24 * 3600 * 1000) {
        lic.quota.windowStart = now;
        lic.quota.remaining = PREMIUM_QUOTA;
      }
      lic.quota.remaining = Math.max(0, (lic.quota.remaining || 0) - 1);
      saveLicense(lic);
      loadLicenseUI();
    }

    // ---------- messages persistence ----------
    function loadMessages() {
      try {
        var arr = JSON.parse(localStorage.getItem(MSG_STORAGE_KEY) || '[]');
        messagesEl.innerHTML = '';
        for (var i = 0; i < arr.length; i++) appendMessageToDOM(arr[i]);
        messagesEl.scrollTop = messagesEl.scrollHeight;
      } catch (e) {}
    }
    function saveMessages(arr) { localStorage.setItem(MSG_STORAGE_KEY, JSON.stringify(arr)); }
    function pushMessage(obj) { var arr = JSON.parse(localStorage.getItem(MSG_STORAGE_KEY) || '[]'); arr.push(obj); saveMessages(arr); }

    // ---------- memory ----------
    function getMemory() { try { return JSON.parse(localStorage.getItem(MEMORY_KEY) || '[]'); } catch (e) { return []; } }
    function saveMemory(arr) { localStorage.setItem(MEMORY_KEY, JSON.stringify(arr)); }
    function addMemory(fact) { var arr = getMemory(); arr.push({ fact: fact, addedAt: new Date().toISOString() }); saveMemory(arr); toast('Memory saved'); }
    function clearMemory() { localStorage.removeItem(MEMORY_KEY); toast('Memory cleared'); }

    clearMemoryBtn.addEventListener('click', function() {
      if (!licenseActive()) { toast('Premium only'); return; }
      if (!confirm('Clear stored memory?')) return;
      clearMemory();
    });

    exportChatBtn.addEventListener('click', function() {
      var chat = JSON.parse(localStorage.getItem(MSG_STORAGE_KEY) || '[]');
      var mem = getMemory();
      var blob = new Blob([JSON.stringify({ chat: chat, memory: mem }, null, 2)], { type: 'application/json' });
      var url = URL.createObjectURL(blob);
      var a = document.createElement('a');
      a.href = url;
      a.download = 'gomega-chat-' + (new Date().toISOString().slice(0,19).replace(/[:T]/g, '-')) + '.json';
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      toast('Export started');
    });

    // ---------- UI helpers ----------
    function appendMessageToDOM(m) {
      var div = document.createElement('div');
      div.className = 'msg ' + (m.role === 'user' ? 'user' : 'ai');
      var meta = document.createElement('div'); meta.className = 'meta';
      meta.textContent = (m.role === 'user' ? 'You' : 'Gomega AI') + ' • ' + (new Date(m.ts)).toLocaleTimeString();
      var content = document.createElement('div');
      // safe insert
      content.innerHTML = sanitize(m.text).replace(/\n/g, '<br>');
      div.appendChild(meta);
      div.appendChild(content);
      if (m.role === 'ai') {
        var copyBtn = document.createElement('button');
        copyBtn.textContent = 'Copy';
        copyBtn.className = 'copyBtn';
        copyBtn.title = 'Copy reply';
        copyBtn.onclick = function(ev) { ev.stopPropagation(); navigator.clipboard && navigator.clipboard.writeText(m.text); toast('Copied reply'); };
        div.appendChild(copyBtn);
      }
      messagesEl.appendChild(div);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function sanitize(s) { var t = document.createElement('div'); t.textContent = s; return t.innerHTML; }
    function toast(msg) { var t = document.createElement('div'); t.style.position='fixed'; t.style.right='20px'; t.style.bottom='20px'; t.style.background='linear-gradient(90deg,#111827,#0b1222)'; t.style.padding='10px 12px'; t.style.borderRadius='10px'; t.style.boxShadow='0 8px 30px rgba(2,6,23,0.6)'; t.style.color='white'; t.style.fontSize='13px'; t.textContent = msg; document.body.appendChild(t); setTimeout(function(){ t.style.transition='opacity 400ms'; t.style.opacity='0'; setTimeout(function(){ t.remove(); },420); },2200); }

    // ---------- send / typing ----------
    sendBtn.addEventListener('click', trySend);
    inputBox.addEventListener('keydown', function(e) { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); trySend(); } });

    function trySend() {
      if (isTyping) { toast('Please wait — AI is typing'); return; }
      var text = inputBox.value.trim();
      if (!text) return;
      var sel = modelSelect.options[modelSelect.selectedIndex];
      if (sel.dataset && sel.dataset.premium && !licenseActive()) { activateModal.classList.remove('hidden'); toast('This model requires Premium'); return; }

      if (!licenseActive()) {
        var obj = getChatCountObj();
        if ((obj.count || 0) >= FREE_DAILY_LIMIT) { activateModal.classList.remove('hidden'); toast('You reached your daily free limit — upgrade to Premium'); return; }
      } else {
        var lic = getLicense();
        if (lic && lic.expiresAt !== 'lifetime' && lic.quota && typeof lic.quota.remaining === 'number') {
          var now = Date.now();
          var windowStart = lic.quota.windowStart || now;
          if (now - windowStart > (lic.quota.windowDays || PREMIUM_QUOTA_DAYS) * 24 * 3600 * 1000) {
            lic.quota.windowStart = now;
            lic.quota.remaining = PREMIUM_QUOTA;
          }
          if (lic.quota.remaining <= 0) { toast('Premium quota exhausted for this window.'); return; }
        }
      }

      var userMsg = { role: 'user', text: text, ts: new Date().toISOString() };
      appendMessageToDOM(userMsg);
      pushMessage(userMsg);
      inputBox.value = '';
      incrementChatCount();

      if (/^remember:\s*(.+)/i.test(text)) {
        var m = text.match(/^remember:\s*(.+)/i);
        if (m && m[1]) {
          if (licenseActive() && convMemoryToggle.checked) {
            addMemory(m[1].trim());
            appendMessageToDOM({ role:'ai', text: 'Got it — I will remember that.', ts: new Date().toISOString() });
            pushMessage({ role:'ai', text: 'Got it — I will remember that.', ts: new Date().toISOString() });
            return;
          } else {
            appendMessageToDOM({ role:'ai', text: 'Memory is a Premium feature — activate to use it.', ts: new Date().toISOString() });
            pushMessage({ role:'ai', text: 'Memory is a Premium feature — activate to use it.', ts: new Date().toISOString() });
            return;
          }
        }
      }

      if (licenseActive()) consumePremiumQuotaIfAny();
      runAI(text, modelSelect.value);
    }

    function setTyping(v) {
      isTyping = v;
      sendBtn.disabled = v;
      inputBox.disabled = v;
      if (v) {
        var bubble = document.createElement('div');
        bubble.className = 'msg ai';
        bubble.id = 'typingBubble';
        var meta = document.createElement('div'); meta.className = 'meta'; meta.textContent = 'Gomega AI • typing...';
        var inner = document.createElement('div');
        inner.style.padding = '8px 12px';
        inner.style.borderRadius = '10px';
        inner.style.background = 'linear-gradient(180deg,#071a2a,#062036)';
        inner.style.display = 'inline-block';
        var dot1 = document.createElement('span'); dot1.className = 'typing-dot';
        var dot2 = document.createElement('span'); dot2.className = 'typing-dot';
        var dot3 = document.createElement('span'); dot3.className = 'typing-dot';
        inner.appendChild(dot1); inner.appendChild(dot2); inner.appendChild(dot3);
        bubble.appendChild(meta); bubble.appendChild(inner);
        messagesEl.appendChild(bubble);
        messagesEl.scrollTop = messagesEl.scrollHeight;
      } else {
        var tb = document.getElementById('typingBubble');
        if (tb) tb.remove();
      }
    }

    // ---------- math & code helpers ----------
    function tokenizeMath(expr) {
      var allowed = /^[0-9+\-*/^().%\s]*$/;
      if (!allowed.test(expr)) return null;
      var tokens = [];
      var i = 0;
      while (i < expr.length) {
        var ch = expr[i];
        if (ch === ' ') { i++; continue; }
        if (/\d|\./.test(ch)) {
          var num = ch; i++;
          while (i < expr.length && /[\d.]/.test(expr[i])) { num += expr[i]; i++; }
          tokens.push(num);
          continue;
        }
        if (ch === '+' || ch === '-' || ch === '*' || ch === '/' || ch === '^' || ch === '%' || ch === '(' || ch === ')') {
          if (ch === '-') {
            var prev = tokens.length ? tokens[tokens.length-1] : null;
            if (prev === null || prev === '(' || ['+','-','*','/','^','%'].indexOf(prev) !== -1) tokens.push('0');
          }
          tokens.push(ch);
          i++; continue;
        }
        return null;
      }
      return tokens;
    }

    function shuntingYard(tokens) {
      var out = [];
      var ops = [];
      var prec = {'+':1,'-':1,'*':2,'/':2,'%':2,'^':3};
      var rightAssoc = {'^':true};
      tokens.forEach(function(t){
        if (/^(\d+(\.\d+)?)$/.test(t)) out.push(t);
        else if (['+','-','*','/','^','%'].indexOf(t) !== -1) {
          while (ops.length) {
            var top = ops[ops.length-1];
            if (top === '(') break;
            var p1 = prec[t] || 0;
            var p2 = prec[top] || 0;
            if ((!rightAssoc[t] && p1 <= p2) || (rightAssoc[t] && p1 < p2)) out.push(ops.pop());
            else break;
          }
          ops.push(t);
        } else if (t === '(') ops.push(t);
        else if (t === ')') {
          while (ops.length && ops[ops.length-1] !== '(') out.push(ops.pop());
          if (ops.length && ops[ops.length-1] === '(') ops.pop(); else throw new Error('Mismatched parentheses');
        } else throw new Error('Unknown token ' + t);
      });
      while (ops.length) {
        var o = ops.pop();
        if (o === '(' || o === ')') throw new Error('Mismatched parentheses');
        out.push(o);
      }
      return out;
    }

    function evalRPNWithSteps(rpn) {
      var stack = [];
      var steps = [];
      rpn.forEach(function(token){
        if (/^(\d+(\.\d+)?)$/.test(token)) stack.push(Number(token));
        else {
          var b = stack.pop();
          var a = stack.pop();
          if (a === undefined || b === undefined) throw new Error('Invalid expression');
          var res;
          if (token === '+') res = a + b;
          else if (token === '-') res = a - b;
          else if (token === '*') res = a * b;
          else if (token === '/') { if (b === 0) throw new Error('Division by zero'); res = a / b; }
          else if (token === '%') res = a % b;
          else if (token === '^') res = Math.pow(a,b);
          else throw new Error('Unknown operator');
          steps.push(String(a) + ' ' + token + ' ' + String(b) + ' = ' + String(res));
          stack.push(res);
        }
      });
      if (stack.length !== 1) throw new Error('Invalid expression result');
      return { result: stack[0], steps: steps };
    }

    function parseLinearSide(side) {
      side = side.replace(/\s+/g,'');
      if (side[0] === '-') side = '0' + side;
      var terms = side.replace(/-/g, '+-').split('+').filter(Boolean);
      var coeff = 0;
      var constant = 0;
      terms.forEach(function(term){
        if (term.indexOf('x^2') !== -1) { return; }
        else if (term.indexOf('x') !== -1) {
          var t = term.replace('x','');
          if (t === '' || t === '+') t = '1'; else if (t === '-') t = '-1';
          coeff += Number(t);
        } else {
          constant += Number(term);
        }
      });
      return { coeff: coeff, constant: constant };
    }

    function trySolveLinear(eq) {
      try {
        if (!/^[^=]+=[^=]+$/.test(eq)) return null;
        var parts = eq.split('=');
        var L = parts[0], R = parts[1];
        if (!/[xX]/.test(L+R)) return null;
        if (/x\^2/i.test(L+R)) return null;
        var left = parseLinearSide(L);
        var right = parseLinearSide(R);
        var a = left.coeff, b = left.constant, c = right.coeff, d = right.constant;
        var A = a - c;
        var B = d - b;
        if (A === 0) {
          if (Math.abs(B) < 1e-12) return { steps: ['Infinite solutions (both sides identical)'], result: 'Infinite solutions' };
          return { steps: ['No solution (variable cancels out)'], result: 'No solution' };
        }
        var x = B / A;
        var steps = [];
        steps.push('Start: ' + L + ' = ' + R);
        steps.push('Collect variable terms: (' + a + ')x + (' + b + ') = (' + c + ')x + (' + d + ')');
        steps.push('Move x terms left: (' + (a - c) + ')x = ' + (d - b));
        steps.push('Divide: x = (' + (d - b) + ') / (' + (a - c) + ') = ' + x);
        return { steps: steps, result: 'x = ' + x };
      } catch (e) { return null; }
    }

    function trySolveQuadratic(eq) {
      try {
        if (!/^[^=]+=[^=]+$/.test(eq)) return null;
        var parts = eq.split('=');
        var L = parts[0], R = parts[1];
        var expr = '(' + L + ')-(' + R + ')';
        var poly = expr.replace(/\s+/g,'');
        var partsList = poly.replace(/\-/g, '+-').split('+').filter(Boolean);
        var a = 0, b = 0, c = 0;
        partsList.forEach(function(p){
          var t = p.replace(/^\(/,'').replace(/\)$/,'');
          var m2 = t.match(/^([+\-]?\d*\.?\d*)x\^2$/i);
          if (m2) { var coeff = m2[1]; if (coeff === '' || coeff === '+') coeff = '1'; if (coeff === '-') coeff = '-1'; a += Number(coeff); return; }
          var m1 = t.match(/^([+\-]?\d*\.?\d*)x$/i);
          if (m1) { var coeff1 = m1[1]; if (coeff1 === '' || coeff1 === '+') coeff1 = '1'; if (coeff1 === '-') coeff1 = '-1'; b += Number(coeff1); return; }
          var safeNum = t.replace(/[^\d\.\+\-\*\/%^()]/g,'');
          if (safeNum.length > 0 && /^[\d\.\+\-\*\/\%\^\(\)]+$/.test(safeNum)) {
            try {
              var tok = tokenizeMath(safeNum);
              if (tok) { var rpn = shuntingYard(tok); var ev = evalRPNWithSteps(rpn); c += ev.result; return; }
            } catch(e){}
          }
        });
        if (a === 0 && b === 0 && c === 0) return null;
        var disc = b*b - 4*a*c;
        var sqrtDisc = disc < 0 ? null : Math.sqrt(disc);
        var steps = [];
        steps.push('Equation: ' + a + 'x² + ' + b + 'x + ' + c + ' = 0');
        steps.push('Δ = b² - 4ac = (' + b + ')² - 4*(' + a + ')*(' + c + ') = ' + disc);
        if (sqrtDisc === null) {
          steps.push('Δ < 0 → complex roots');
          var real = -b/(2*a);
          var imag = Math.sqrt(Math.abs(disc))/(2*a);
          steps.push('x = ' + real + ' ± ' + imag + 'i');
          return { steps: steps, result: 'x = ' + real + ' ± ' + imag + 'i' };
        } else {
          var x1 = (-b + sqrtDisc) / (2*a);
          var x2 = (-b - sqrtDisc) / (2*a);
          steps.push('sqrt(Δ) = ' + sqrtDisc);
          steps.push('x₁ = ' + x1);
          steps.push('x₂ = ' + x2);
          return { steps: steps, result: 'x₁ = ' + x1 + ', x₂ = ' + x2 };
        }
      } catch (e) { return null; }
    }

    function isPureMathExpression(s) { return /^[0-9+\-*/^().%\s]+$/.test(s.trim()); }

    function generateCodeTemplate(language, task) {
      language = (language || '').toLowerCase();
      task = task || 'utility function';
      if (language.indexOf('python') !== -1) {
        return { code: '# ' + task + ' — Python example\n' + 'def example_function(x):\n' + '    \"\"\"' + task + ' — brief docstring\"\"\"\n' + '    # TODO: implement\n' + '    return x\n\n' + "if __name__ == '__main__':\n" + '    print(example_function(3))', explain: 'Python template with function and basic test. Replace TODO with logic. Run with: python file.py' };
      }
      if (language.indexOf('javascript') !== -1 || language.indexOf('js') !== -1) {
        return { code: '// ' + task + ' — JavaScript example\nfunction exampleFunction(x) {\n  // TODO: implement\n  return x;\n}\n\nconsole.log(exampleFunction(3));', explain: 'JS template with function and console test. Run in Node: node file.js' };
      }
      if (language.indexOf('html') !== -1) {
        return { code: '<!-- ' + task + ' — HTML snippet -->\n<!doctype html>\n<html><body>\n<script>\n  function example() {\n    // TODO\n    console.log(\"example\");\n  }\n  example();\n</script>\n</body></html>', explain: 'Simple HTML + script template. Paste into an .html file and open in browser.' };
      }
      return { code: '// ' + task + ' — pseudocode / template\n/* Describe expected input/output and replace with real language implementation */', explain: 'Generic template; tell me which language you want for a full example.' };
    }

    // ---------- AI engine (math & code priority) ----------
    async function simulatedAIResponse(userText, model) {
      var priority = (licenseActive() && priorityModeCheckbox && priorityModeCheckbox.checked);
      var baseDelay = Math.max(1200, Math.min(10000, userText.length * 60));
      var delay = priority ? Math.max(350, Math.floor(baseDelay * 0.5)) : baseDelay;
      return new Promise(function(resolve) {
        setTimeout(async function() {
          var txt = userText.trim();
          var ltxt = txt.toLowerCase();

          try {
            if (txt.indexOf('=') !== -1 && /[xX]/.test(txt)) {
              var quad = trySolveQuadratic(txt);
              if (quad) {
                var out = 'I solved the equation for you.\n\n';
                quad.steps.forEach(function(s){ out += s + '\n'; });
                out += '\nSolution: ' + quad.result;
                resolve(out); return;
              }
              var lin = trySolveLinear(txt);
              if (lin) {
                var out2 = 'I solved the linear equation.\n\n';
                lin.steps.forEach(function(s){ out2 += s + '\n'; });
                out2 += '\nSolution: ' + lin.result;
                resolve(out2); return;
              }
            }
            if (isPureMathExpression(txt)) {
              var tokens = tokenizeMath(txt);
              if (!tokens) { resolve('I can\\'t parse that expression. Use numbers, parentheses and + - * / ^ %.'); return; }
              try {
                var rpn = shuntingYard(tokens);
                var evalRes = evalRPNWithSteps(rpn);
                var out3 = 'Expression: ' + txt + '\n\nStep-by-step evaluation:\n';
                evalRes.steps.forEach(function(s,i){ out3 += String(i+1) + ') ' + s + '\n'; });
                out3 += '\nResult: ' + evalRes.result;
                resolve(out3); return;
              } catch(e) { resolve('Error evaluating expression: ' + e.message); return; }
            }
          } catch(e) { console.error('Math parsing error', e); }

          var memoryNote = '';
          try {
            if (licenseActive() && convMemoryToggle.checked) {
              var mem = getMemory();
              if (mem.length) {
                var facts = mem.slice(-4).map(function(m){ return m.fact; });
                var joined = facts.join('; ');
                memoryNote = '\n\n(Stored memory: ' + joined.slice(0,150) + (joined.length > 150 ? '...' : '') + ')';
              }
            }
          } catch(e){}

          if (/\b(write|implement|create|generate|make)\b.*\b(function|script|program|class|component|api|endpoint|lambda|handler)\b/i.test(txt) || /\b(js|javascript|python|html|css|react|node|express|flask|django)\b/i.test(txt)) {
            var lang = 'python';
            var langMatch = txt.match(/\b(python|javascript|js|html|css|react|node|express|flask|django)\b/i);
            if (langMatch) lang = langMatch[1];
            var task = txt;
            var templ = generateCodeTemplate(lang, task);
            var out4 = 'I will generate a ' + lang + ' example with explanation and tests.\n\n';
            out4 += '--- Explanation ---\n' + templ.explain + '\n\n--- Code ---\n' + templ.code + '\n\n--- Next steps ---\n1) Replace TODOs with your logic.\n2) Add edge-case tests.\n3) Run the simple test included.\n' + memoryNote;
            resolve(out4); return;
          }

          var reply = 'I didn\\'t quite catch that — can you tell me more about what you\\'d like?';
          if (/^\s*(hi|hello|hey|howdy|sup)\b/.test(ltxt)) reply = 'Hey! I\\'m Gomega AI — how can I help you today?';
          else if (/\bhow are you\b|\bhow's it going\b/.test(ltxt)) reply = 'I\\'m running smoothly — tell me your goal and I\\'ll help.';
          else if (/\b(help|how do i|how to|what is|explain)\b/.test(ltxt)) reply = 'I can provide step-by-step instructions, code snippets, math steps, or explain concepts. What do you want?';
          else if (/\b(openai|api|backend|functions|server|cloud)\b/.test(ltxt)) reply = 'I can show you server code for a secure proxy and how to wire premium models — I can generate the Cloud Function or Express code.';
          else if (/\b(buy|premium|upgrade|plus)\b/.test(ltxt)) reply = 'Use Activate and paste the key. Admins register keys and can configure consumable/reusable keys.';
          else if (/\b(debug|error|stack trace|exception)\b/.test(ltxt) || /\bfix\b.*\bbug\b/.test(ltxt)) reply = 'Share the exact error or code snippet and I\\'ll suggest fixes and tests.';
          else if (ltxt.length < 30) reply = 'Give me a bit more detail — what\\'s the goal or the issue?';
          else {
            var short = txt.length > 160 ? txt.slice(0,160) + '...' : txt;
            var options = '\n\nOptions:\n1) Explain steps to achieve this.\n2) Provide a short example or template.';
            reply = 'Thanks — I understand: \"' + short + '\"' + options + memoryNote;
          }

          if (model.indexOf('v5') !== -1 && licenseActive() && betaModelsToggle.checked) reply += '\n\n(Using gomega v5.o — premium beta simulated.)';
          else if (model.indexOf('v4') !== -1 && licenseActive()) reply += '\n\n(Using gomega v4.0 mini — premium simulated.)';

          resolve(reply);
        }, delay);
      });
    }

    async function runAI(userText, model) {
      setTyping(true);
      var simulatedReply = await simulatedAIResponse(userText, model);
      var aiMsg = { role:'ai', text: simulatedReply, ts: new Date().toISOString() };
      appendMessageToDOM(aiMsg);
      pushMessage(aiMsg);
      setTyping(false);
    }

    // ---------- photo upload ----------
    photoUploadBtn.addEventListener('click', async function() {
      if (!licenseActive()) { toast('Photo upload is Premium-only'); return; }
      var file = photoInput.files && photoInput.files[0];
      if (!file) { toast('Pick a photo file first'); return; }
      if (useFirebase && storage) {
        var path = 'uploads/' + (Date.now()) + '_' + Math.random().toString(36).slice(2,8) + '_' + file.name;
        var ref = storageRef(storage, path);
        try {
          await uploadBytes(ref, file);
          var url = await getDownloadURL(ref);
          photoPreviewArea.innerHTML = '';
          var p0 = document.createElement('div'); p0.className = 'small muted'; p0.textContent = 'Uploaded to Firebase Storage:';
          var a = document.createElement('a'); a.href = url; a.target = '_blank'; a.textContent = url;
          var d = document.createElement('div'); d.style.marginTop = '8px';
          var img = document.createElement('img'); img.src = url; img.alt = 'uploaded';
          d.appendChild(img);
          photoPreviewArea.appendChild(p0); photoPreviewArea.appendChild(a); photoPreviewArea.appendChild(d);
          toast('Upload complete');
        } catch (e) { console.error(e); toast('Upload failed'); }
      } else {
        var reader = new FileReader();
        reader.onload = function(ev) {
          photoPreviewArea.innerHTML = '';
          var p0 = document.createElement('div'); p0.className = 'small muted'; p0.textContent = 'Preview (not uploaded — configure Firebase Storage to enable uploads):';
          var d = document.createElement('div'); d.style.marginTop = '8px';
          var img = document.createElement('img'); img.src = ev.target.result; img.alt = 'preview';
          d.appendChild(img);
          photoPreviewArea.appendChild(p0); photoPreviewArea.appendChild(d);
        };
        reader.readAsDataURL(file);
        toast('Preview generated (local only)');
      }
    });

    // ---------- attach events ----------
    function attachEvents() {
      $('helpBtn').addEventListener('click', function() {
        appendMessageToDOM({ role:'ai', text: 'Quick help:\n- Activate a key to unlock premium\n- Memory: send \"Remember: ...\" while Memory is enabled\n- Math: \"2*(3+4)^2\" or \"3x+2=11\"\n- Upload photos for premium users (uses Firebase Storage if configured).', ts: new Date().toISOString() });
      });

      modelSelect.addEventListener('change', function() {
        var sel = modelSelect.options[modelSelect.selectedIndex];
        if (sel.dataset && sel.dataset.premium && !licenseActive()) toast('That model needs Premium — click Activate!');
      });

      convMemoryToggle.addEventListener('change', function() {
        if (convMemoryToggle.checked && !licenseActive()) { convMemoryToggle.checked = false; toast('Memory is Premium only'); }
      });

      setInterval(loadLicenseUI, 60000);
    }

    // ---------- greeting ----------
    function startupGreeting() {
      var obj = getChatCountObj();
      if (!licenseActive() && (obj.count || 0) >= FREE_DAILY_LIMIT) {
        appendMessageToDOM({ role:'ai', text: 'You reached your free daily limit. Activate a premium key to continue chatting.', ts: new Date().toISOString() });
      } else {
        appendMessageToDOM({ role:'ai', text: 'Welcome! Ask anything — math, code, upload photos (Premium). Try \"2*(3+4)^2\" or \"3x+2=11\".', ts: new Date().toISOString() });
      }
    }

    // expose debug helpers
    window.Gomega = { getLocalKeys: getLocalKeys, saveLocalKeys: saveLocalKeys, randomKey: randomKey, getLicense: getLicense, clearLicense: clearLicense, setChatCountObj: function(o){ localStorage.setItem(CHAT_COUNT_KEY, JSON.stringify(o)); } };

    // ensure scroll on new messages
    var obs = new MutationObserver(function(){ messagesEl.scrollTop = messagesEl.scrollHeight; });
    obs.observe(messagesEl, { childList:true });
  </script>
</body>
</html>
