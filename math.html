<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Math • Solver + Steps + Camera (Beta) — Keyboard</title>
  <meta name="description" content="Solve math problems and see step-by-step solutions. Includes a Camera/Photo (Beta) mode and an on-screen math keyboard with division templates and underline-below." />
  <link rel="icon" href="data:,"></link>
  <style>
    :root{ --bg:#0f1720; --card:#0b1220; --muted:#9aa4b2; --accent:#6ee7b7; --glass: rgba(255,255,255,0.03); --chat-bg:#07101a; --user-bubble:#0ea5a8; --ai-bubble:#0b2a3a; }
    *{box-sizing:border-box}
    body{font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial; background:linear-gradient(180deg,#071021 0%, #0b1220 100%); color:#e6eef6; padding:28px;}
    .container{max-width:980px;margin:0 auto}
    header{display:flex;align-items:center;gap:16px;margin-bottom:18px}
    h1{font-size:20px;margin:0}
    p.lead{margin:0;color:var(--muted);font-size:13px}

    .card{background:var(--card);border-radius:12px;padding:18px;box-shadow:0 6px 24px rgba(2,6,23,0.6);}
    .row{display:flex;gap:14px}
    .col{flex:1}

    label{font-size:13px;color:var(--muted)}
    textarea,input{width:100%;padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:var(--glass);color:inherit;font-size:15px}
    button{background:linear-gradient(90deg,#0ea5a8,#60a5fa);padding:10px 14px;border-radius:10px;border:0;color:#06202a;font-weight:700;cursor:pointer}
    button.secondary{background:transparent;color:var(--accent);border:1px solid rgba(255,255,255,0.04);}

    .steps{margin-top:12px;padding:12px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));min-height:120px}
    .step{padding:8px;border-left:3px solid rgba(255,255,255,0.03);margin-bottom:8px}
    .step strong{display:block}

    /* keyboard */
    .keyboard{margin-top:12px}
    .kbd-grid{display:grid;grid-template-columns:repeat(10,1fr);gap:8px}
    .kbd-grid button{padding:10px;border-radius:8px;font-weight:700;background:rgba(255,255,255,0.02);color:inherit;border:1px solid rgba(255,255,255,0.02);cursor:pointer}
    .kbd-wide{grid-column:span 4}
    .kbd-ops{grid-column:span 3}

    /* Camera modal */
    .modal{position:fixed;inset:0;background:linear-gradient(180deg, rgba(1,2,6,0.7), rgba(1,2,6,0.85));display:none;align-items:center;justify-content:center;padding:24px}
    .modal.open{display:flex}
    .cam-card{width:880px;max-width:95%;background:#071428;padding:14px;border-radius:12px}
    video{width:100%;border-radius:8px;background:#000}
    canvas{display:none}
    .controls{display:flex;gap:8px;align-items:center;margin-top:8px}
    .note{font-size:12px;color:var(--muted);margin-top:6px}

    footer{margin-top:14px;color:var(--muted);font-size:13px}

    .small{font-size:13px;color:var(--muted)}

    /* subtle typing animation */
    .thinking{display:inline-block;vertical-align:middle;height:12px}
    .dot{width:6px;height:6px;background:#9aa4b2;border-radius:50%;display:inline-block;margin:0 2px;opacity:0;animation:think 1s infinite}
    .dot:nth-child(1){animation-delay:0s}
    .dot:nth-child(2){animation-delay:0.15s}
    .dot:nth-child(3){animation-delay:0.3s}
    @keyframes think{0%{opacity:0;transform:translateY(0)}40%{opacity:1;transform:translateY(-6px)}80%{opacity:0.3;transform:translateY(0)}100%{opacity:0}}

    /* monospace preview for division template */
    .division-preview{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, monospace; font-size:16px; background:rgba(255,255,255,0.02); padding:8px; border-radius:6px}

    /* Chat UI */
    .chat-card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); padding:12px;border-radius:10px;min-height:160px; max-height:360px; overflow:auto}
    .msg{display:flex;margin:8px 0;opacity:0;transform:translateY(6px);animation:fadeInUp .22s forwards}
    @keyframes fadeInUp{to{opacity:1;transform:none}}
    .msg.user{justify-content:flex-end}
    .bubble{max-width:78%;padding:10px 12px;border-radius:12px;line-height:1.3;font-size:14px}
    .bubble.user{background:linear-gradient(90deg,#06b6a4,#60a5fa);color:#032023;border-bottom-right-radius:4px}
    .bubble.ai{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.03); color:var(--muted); border-bottom-left-radius:4px}
    .typing-dots{display:inline-block;vertical-align:middle}
    .typing-dots span{display:inline-block;width:6px;height:6px;background:rgba(255,255,255,0.12);border-radius:50%;margin:0 2px;opacity:0.8;animation:typing 1s infinite}
    .typing-dots span:nth-child(1){animation-delay:0s}
    .typing-dots span:nth-child(2){animation-delay:0.12s}
    .typing-dots span:nth-child(3){animation-delay:0.24s}
    @keyframes typing{0%{transform:translateY(0);opacity:0.6}50%{transform:translateY(-6px);opacity:1}100%{transform:translateY(0);opacity:0.6}}

    @media (max-width:900px){ .row{flex-direction:column} .kbd-grid{grid-template-columns:repeat(5,1fr)} .chat-card{max-height:220px} }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>Math • Solver (step-by-step) + Keyboard</h1>
        <p class="lead">Type a math problem, use the on-screen keyboard or the Camera/Photo (Beta). Includes long-division templates and an "underline below" feature (combining low line).</p>
      </div>
    </header>

    <section class="card">
      <div class="row">
        <div class="col">
          <label for="expr">Enter problem (example: 2/3 + 4*(5-1)  OR  x^2 + 2x + 1 )</label>
          <textarea id="expr" rows="4" placeholder="Type a math problem...">2/3 + 4*(5-1)</textarea>

          <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
            <button id="solveBtn">Solve — Show steps</button>
            <button id="solveChatBtn" class="secondary" title="Solve and show as chat">Solve — Chat</button>
            <button id="cameraBtn" class="secondary">Camera / Photo (Beta)</button>
            <input id="fileInput" type="file" accept="image/*" style="display:none" />
            <button id="uploadBtn" class="secondary">Upload Photo</button>
            <button id="underlineBtn" class="secondary" title="Underline below selected character(s)">Underline below ⎯</button>
            <button id="longDivBtn" class="secondary" title="Insert long-division template">Insert Long Division</button>
            <button id="longDivExample" class="secondary" title="Insert sample: 38 ) 1127">Insert Example (38 ) 1127)</button>
            <button id="ex222" class="secondary" title="Insert 222 with underline under middle 2">EX: 222 (underline middle)</button>
          </div>

          <div class="note">Tips: Use ^ for power (e.g. 2^3). Use the on-screen keyboard below for symbols and quick templates. "Underline below" uses a Unicode combining low line (may render differently across fonts).</div>

          <!-- On-screen keyboard -->
          <div class="keyboard card">
            <label class="small">On-screen keyboard — tap to insert</label>
            <div class="kbd-grid" id="kbd">
              <!-- digits -->
              <button data-insert="7">7</button>
              <button data-insert="8">8</button>
              <button data-insert="9">9</button>
              <button data-insert="/">÷</button>
              <button data-insert="sqrt()">√()</button>

              <button data-insert="4">4</button>
              <button data-insert="5">5</button>
              <button data-insert="6">6</button>
              <button data-insert="*">×</button>
              <button data-insert="^">^</button>

              <button data-insert="1">1</button>
              <button data-insert="2">2</button>
              <button data-insert="3">3</button>
              <button data-insert="-">−</button>
              <button data-insert="( )">( )</button>

              <button data-insert="0">0</button>
              <button data-insert=".">.</button>
              <button data-insert=",">,</button>
              <button data-insert="+">+</button>
              <button data-insert="=">=</button>

              <!-- wide operators -->
              <button class="kbd-wide" data-insert="pi">π</button>
              <button class="kbd-wide" data-insert="theta">θ</button>
              <button class="kbd-ops" data-insert="sum()">∑()</button>
              <button class="kbd-ops" data-insert="int()">∫()</button>

              <!-- extra row: more math -->
              <button data-insert="(">(</button>
              <button data-insert=")">)</button>
              <button data-insert="frac( , )">a⁄b</button>
              <button data-insert="divTemplate">long ÷</button>
              <button data-insert="!">!</button>

              <button data-insert="%">%</button>
              <button data-insert="<=">&le;</button>
              <button data-insert=">=">&ge;</button>
              <button data-insert="sqrt()">√</button>
              <button data-insert="root()">ⁿ√()</button>

              <button data-insert="pi">π</button>
              <button data-insert="e">e</button>
              <button data-insert="abs()">| |</button>
              <button data-insert="mod">mod</button>
              <button data-insert="~">≈</button>
            </div>
            <div style="margin-top:8px" class="small">Tips: Cursor position is preserved when inserting. Click a pair like <code>( )</code> and it will place the cursor inside the parentheses.</div>
          </div>

        </div>

        <div class="col">
          <label>Step-by-step</label>
          <div id="steps" class="steps small">No steps yet. Press <strong>Solve</strong>.</div>

          <div style="height:12px"></div>

          <label>Chat (AI Math Assistant)</label>
          <div id="chat" class="chat-card small">
            <div class="msg ai" style="opacity:1; transform:none;">
              <div class="bubble ai">Hi! Paste a problem and press <strong>Solve — Chat</strong> to see a conversational, step-by-step explanation — or try a word problem in plain English (e.g., "If Anna has 3 times as many apples as Ben and Ben has 4, how many do they have together?").</div>
            </div>
          </div>

          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="askWordBtn" class="secondary">Ask as Word Problem</button>
            <button id="clearChat" class="secondary">Clear Chat</button>
          </div>
        </div>
      </div>

      <div style="margin-top:12px;display:flex;gap:10px;align-items:center;">
        <div class="small">Result:</div>
        <div id="result" style="font-weight:700"></div>
        <div id="thinking" style="margin-left:8px;display:none" aria-hidden>
          <span class="thinking"><span class="dot"></span><span class="dot"></span><span class="dot"></span></span>
        </div>
      </div>

    </section>

    <footer class="small">Camera mode requires HTTPS (or localhost). OCR is experimental — handwritten problems may not always be recognized correctly. This page uses math.js and mathsteps for steps.</footer>
  </div>

  <!-- Camera modal -->
  <div id="modal" class="modal" role="dialog" aria-hidden="true">
    <div class="cam-card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <strong>Camera / Photo (Beta)</strong>
        <button id="closeCam" class="secondary">Close</button>
      </div>
      <video id="video" autoplay playsinline></video>
      <canvas id="snap" width="1280" height="720"></canvas>
      <div class="controls">
        <button id="capture">Capture</button>
        <button id="retake" class="secondary">Retake</button>
        <button id="usePhoto">Use Photo</button>
        <div style="flex:1"></div>
        <div class="small">Switch to uploaded images with Upload on the main card.</div>
      </div>
      <div id="ocrProgress" class="note"></div>
    </div>
  </div>

  <!-- Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.8.0/math.min.js" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/mathsteps/dist/mathsteps.min.js"></script>
  <script src="https://unpkg.com/tesseract.js@2.1.5/dist/tesseract.min.js"></script>

  <script>
    // Elements
    const exprEl = document.getElementById('expr');
    const stepsEl = document.getElementById('steps');
    const resultEl = document.getElementById('result');
    const solveBtn = document.getElementById('solveBtn');
    const solveChatBtn = document.getElementById('solveChatBtn');
    const cameraBtn = document.getElementById('cameraBtn');
    const modal = document.getElementById('modal');
    const video = document.getElementById('video');
    const snap = document.getElementById('snap');
    const captureBtn = document.getElementById('capture');
    const closeCam = document.getElementById('closeCam');
    const usePhoto = document.getElementById('usePhoto');
    const retake = document.getElementById('retake');
    const thinking = document.getElementById('thinking');
    const ocrProgress = document.getElementById('ocrProgress');
    const uploadBtn = document.getElementById('uploadBtn');
    const fileInput = document.getElementById('fileInput');
    const underlineBtn = document.getElementById('underlineBtn');
    const longDivBtn = document.getElementById('longDivBtn');
    const longDivExample = document.getElementById('longDivExample');
    const ex222 = document.getElementById('ex222');
    const kbd = document.getElementById('kbd');

    const chatEl = document.getElementById('chat');
    const askWordBtn = document.getElementById('askWordBtn');
    const clearChatBtn = document.getElementById('clearChat');

    let stream = null;
    let lastImageDataUrl = null;

    function showThinking(on){thinking.style.display = on ? 'inline-block' : 'none'}

    // Insert text at cursor in textarea
    function insertAtCursor(text){
      const el = exprEl;
      const start = el.selectionStart;
      const end = el.selectionEnd;
      const before = el.value.substring(0,start);
      const after = el.value.substring(end);
      el.value = before + text + after;
      // move cursor inside parentheses if we inserted ()
      if(text.endsWith('()')){
        const pos = start + text.indexOf('()') + 1; // position inside
        el.selectionStart = el.selectionEnd = pos;
      } else if(text.endsWith('( )')){
        const pos = start + text.indexOf('( )') + 2;
        el.selectionStart = el.selectionEnd = pos;
      } else if(text === 'divTemplate'){
        // special template for long division
        const template = '38 ) 1127';
        el.value = before + template + after;
        el.selectionStart = el.selectionEnd = start + template.length;
      } else if(text === 'frac( , )'){
        const frag = 'frac( , )';
        el.value = before + frag + after;
        el.selectionStart = el.selectionEnd = start + 5; // position between comma
      } else {
        const pos = start + text.length;
        el.selectionStart = el.selectionEnd = pos;
      }
      el.focus();
    }

    // Keyboard button clicks
    kbd.addEventListener('click', (e)=>{
      const btn = e.target.closest('button');
      if(!btn) return;
      const t = btn.getAttribute('data-insert');
      if(!t) return;
      if(t==='pi') insertAtCursor('pi');
      else if(t==='theta') insertAtCursor('theta');
      else insertAtCursor(t);
    });

    // Underline-below: combining low line U+0332
    underlineBtn.addEventListener('click', ()=>{
      const low = '\u0332';
      const el = exprEl;
      const start = el.selectionStart;
      const end = el.selectionEnd;
      if(start !== end){
        // apply combining low line after every selected char
        const selected = el.value.substring(start,end);
        let transformed = '';
        for(const ch of selected){ transformed += ch + low; }
        insertAtSelection(transformed, start, end);
      } else {
        // if nothing selected, underline previous character if exists
        if(start>0){
          const before = el.value.substring(0,start-1);
          const char = el.value.charAt(start-1);
          const after = el.value.substring(start);
          el.value = before + char + low + after;
          el.selectionStart = el.selectionEnd = start + 1; // keep cursor after inserted low line
          el.focus();
        } else {
          // insert a blank underline marker
          insertAtCursor('_');
        }
      }
    });

    function insertAtSelection(text, s, e){
      const el = exprEl;
      const before = el.value.substring(0,s);
      const after = el.value.substring(e);
      el.value = before + text + after;
      el.selectionStart = s + text.length;
      el.selectionEnd = el.selectionStart;
      el.focus();
    }

    // Long division template insertion (simple textual template similar to the images)
    longDivBtn.addEventListener('click', ()=>{
      const divisor = prompt('Enter divisor (number to the left of the parenthesis):');
      if(divisor===null) return;
      const dividend = prompt('Enter dividend (the number under/after the parenthesis):');
      if(dividend===null) return;
      // Insert formatted as: "38 ) 1127" with non-breaking spaces for stability
      const text = divisor + ' ) ' + dividend;
      insertAtCursor(text);
    });

    longDivExample.addEventListener('click', ()=>{
      insertAtCursor('38 ) 1127');
    });

    // Example: EX 222 with underline under middle 2
    ex222.addEventListener('click', ()=>{
      const low = '\u0332';
      const ex = '2' + '2' + low + '2';
      insertAtCursor(ex);
    });

    // Solve function (same as before) — uses mathsteps or math.js fallback
    async function solveExpression(input){
      stepsEl.innerHTML = '';
      resultEl.textContent = '';

      if(!input || !input.trim()){ stepsEl.textContent = 'Please enter a problem.'; return }
      showThinking(true);

      try{
        if(window.mathsteps){
          if(input.includes('=')){
            try{
              if(typeof mathsteps.solveEquation === 'function'){
                const eqSteps = mathsteps.solveEquation(input);
                if(eqSteps && eqSteps.length){
                  renderMathSteps(eqSteps);
                  showThinking(false);
                  resultEl.textContent = eqSteps[eqSteps.length-1].newEquation ? eqSteps[eqSteps.length-1].newEquation : '';
                  return;
                }
              }
            }catch(e){ console.warn('mathsteps equation attempt failed',e); }
          }

          try{
            const s = mathsteps.simplifyExpression(input);
            if(s && s.length){
              renderMathSteps(s);
              const last = s[s.length-1];
              resultEl.textContent = last && (last.newNode ? last.newNode.toString() : last.newExpression || '') ;
              showThinking(false);
              return;
            }
          }catch(e){ console.warn('mathsteps simplify failed', e) }
        }

        const node = math.parse(input);
        const steps = [];

        function evalNode(n){
          if(n.isConstantNode){ return {value: n.value, repr: n.toString()}; }
          if(n.isSymbolNode){ return {value: null, repr: n.toString()}; }
          if(n.isOperatorNode){
            const childs = n.args.map(evalNode);
            if(childs.some(c=>c.value===null)){ return {value:null, repr: '(' + childs.map(c=>c.repr).join(' ' + n.op + ' ') + ')'}; }
            const values = childs.map(c=>c.value);
            const exprStr = '(' + childs.map(c=>c.repr).join(' ' + n.op + ' ') + ')';
            let val;
            try{ val = math.evaluate(exprStr); }catch(e){ val = null }
            steps.push({before: exprStr, after: String(val)});
            return {value: val, repr: String(val)};
          }
          if(n.isParenthesisNode){ return evalNode(n.content); }
          if(n.isFunctionNode){
            const args = n.args.map(evalNode);
            if(args.some(a=>a.value===null)) return {value:null, repr: n.toString()};
            try{
              const code = n.toString();
              const v = math.evaluate(code);
              steps.push({before: code, after: String(v)});
              return {value:v, repr:String(v)};
            }catch(e){ return {value:null, repr:n.toString()} }
          }
          return {value:null, repr: n.toString()};
        }

        const final = evalNode(node);
        if(steps.length===0){
          stepsEl.textContent = 'Could not generate numeric steps. Showing parsed expression.';
          stepsEl.innerHTML += '<div class="step">' + node.toString() + '</div>';
          resultEl.textContent = final.repr || '';
        } else {
          stepsEl.innerHTML = '';
          steps.forEach((s,i)=>{
            const el = document.createElement('div'); el.className='step';
            el.innerHTML = '<strong>Step '+(i+1)+':</strong>' + '<div>'+escapeHtml(s.before)+' &nbsp;→&nbsp; '+escapeHtml(s.after)+'</div>';
            stepsEl.appendChild(el);
          });
          resultEl.textContent = final.repr || '';
        }

      }catch(err){
        console.error(err);
        stepsEl.textContent = 'Sorry — failed to process the expression. Try a simpler expression or check your syntax.';
        resultEl.textContent = '';
      } finally{
        showThinking(false);
      }
    }

    function renderMathSteps(stepObjects){
      stepsEl.innerHTML = '';
      stepObjects.forEach((st,i)=>{
        const el = document.createElement('div'); el.className='step';
        const before = st.oldNode ? st.oldNode.toString() : st.oldExpression || st.changeType || '';
        const after = st.newNode ? st.newNode.toString() : st.newExpression || '';
        el.innerHTML = '<strong>Step '+(i+1)+':</strong> <div><code>'+escapeHtml(before)+'</code> &nbsp;→&nbsp; <code>'+escapeHtml(after)+'</code></div>';
        stepsEl.appendChild(el);
      });
    }

    function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    solveBtn.addEventListener('click', ()=> solveExpression(exprEl.value.trim()));

    // Chat utilities
    function appendChat(role, htmlContent){
      const msg = document.createElement('div');
      msg.className = 'msg ' + (role === 'user' ? 'user' : 'ai');
      const bubble = document.createElement('div');
      bubble.className = 'bubble ' + (role === 'user' ? 'user' : 'ai');
      bubble.innerHTML = htmlContent;
      msg.appendChild(bubble);
      chatEl.appendChild(msg);
      chatEl.scrollTop = chatEl.scrollHeight;
      return {msg, bubble};
    }

    function appendTyping(){
      const msg = document.createElement('div'); msg.className = 'msg ai';
      const bubble = document.createElement('div'); bubble.className = 'bubble ai';
      bubble.innerHTML = '<span class="typing-dots"><span></span><span></span><span></span></span>';
      msg.appendChild(bubble);
      chatEl.appendChild(msg);
      chatEl.scrollTop = chatEl.scrollHeight;
      return {msg, bubble};
    }

    function replaceTypingWith(msgElem, htmlContent){
      if(!msgElem) return;
      const bubble = msgElem.querySelector('.bubble');
      if(bubble) bubble.innerHTML = htmlContent;
      chatEl.scrollTop = chatEl.scrollHeight;
    }

    function sleep(ms){ return new Promise(res=>setTimeout(res, ms)); }

    // Solve as chat button
    solveChatBtn.addEventListener('click', async ()=>{
      const text = exprEl.value.trim();
      if(!text){ alert('Please enter a problem first.'); return; }
      // show user message
      appendChat('user', escapeHtml(text));
      // show assistant typing
      const typing = appendTyping();
      // call the regular solver (which updates steps area/result)
      await solveExpression(text);
      // small delay for realism
      await sleep(350 + Math.min(1000, text.length*10));
      // Build assistant reply using stepsEl content and result
      let stepsHtml = stepsEl.innerHTML || '';
      let resText = resultEl.textContent || '';
      if(!stepsHtml || stepsHtml.trim() === '' || /Please enter a problem|failed to process/.test(stepsHtml)){
        const fallback = 'I tried, but couldn\'t produce step-by-step calculations for that input. Try rewriting the expression or use a simpler form (e.g., "2/3 + 4*(5-1)").';
        replaceTypingWith(typing.msg, fallback);
        return;
      }
      // create a neat assistant bubble summarizing the steps and result
      const summary = '<div style="margin-bottom:8px"><strong>Solution:</strong> <span style="font-weight:700;color:var(--accent)">'+escapeHtml(resText)+'</span></div>' +
                      '<div style="max-height:200px;overflow:auto;padding-right:8px">' + stepsHtml + '</div>' +
                      '<div style="margin-top:8px;color:var(--muted);font-size:12px">If you want a clearer explanation for any step, ask me to "explain step 2" or "show work for step 1".</div>';
      replaceTypingWith(typing.msg, summary);
    });

    // Word-problem parsing (best-effort lightweight parser)
    function parseWordProblem(text){
      // normalize
      const t = text.toLowerCase();
      // heuristic: look for keywords that indicate a word problem
      const isWord = /\b(how many|how much|total|altogether|together|sum|difference|left|remaining|each|every|per|times|product|sum of|more than|less than)\b/.test(t);
      if(!isWord) return null;

      // try converting words to operators (common patterns)
      let s = text;
      const map = [
        [/\bplus\b/g, '+'],
        [/\bminus\b/g, '-'],
        [/\bsubtracted by\b/g, '-'],
        [/\bminus\b/g, '-'],
        [/\badd(ed)?\b/g, '+'],
        [/\band\b/g, '+'],
        [/\btotal of\b/g, '+'],
        [/\bover\b/g, '/'],
        [/\bdivided by\b/g, '/'],
        [/\bdivided\b/g, '/'],
        [/\bper\b/g, '/'],
        [/\bmultiplied by\b/g, '*'],
        [/\btimes\b/g, '*'],
        [/\bproduct of\b/g, '*'],
        [/\bmore than\b/g, '+'],
        [/\bless than\b/g, '-'],
        [/\bremaining\b/g, '-'],
        [/\bhalf of\b/g, '/2'],
        [/\bthird of\b/g, '/3']
      ];
      for(const [p, r] of map) s = s.replace(p, r);

      // extract numbers and simple nearby structure
      const numbers = s.match(/-?\d+(\.\d+)?/g);
      if(!numbers || numbers.length===0) return null;

      // attempt simple common patterns:
      // "If Anna has 3 times as many apples as Ben and Ben has 4, how many do they have together?"
      // -> detect "times" -> multiplication then addition for together
      if(/times|multiplied|product/.test(t) && /together|altogether|sum|how many do they have together/.test(t)){
        // find two numbers: ratio and base
        const nums = numbers.map(Number);
        if(nums.length>=2){
          // assume pattern: A has r times B and B has n -> A = r * n ; total = (r+1)*n
          const r = nums[0], n = nums[1];
          const expr = '(' + r + ' + 1) * ' + n;
          return expr;
        }
      }

      // "each" pattern: "Each box has 12 candies and there are 5 boxes. How many candies?"
      if(/\beach\b/.test(t) && numbers.length>=2){
        const nums = numbers.map(Number);
        // find likely pair: quantity per each and count
        const expr = nums.slice(0,2).join(' * ');
        return expr;
      }

      // "sum of" or "altogether": add all numbers
      if(/\b(add|sum|altogether|total)\b/.test(t)){
        const expr = numbers.join(' + ');
        return expr;
      }

      // "left" or "remaining": assume subtraction
      if(/\bleft|remaining|after\b/.test(t) && numbers.length>=2){
        const expr = numbers[0] + ' - ' + numbers[1];
        return expr;
      }

      // "per" or rate "miles per hour": maybe multiply
      if(/\bper\b/.test(t) && numbers.length>=2){
        return numbers[0] + ' * ' + numbers[1];
      }

      // fallback: if there are exactly two numbers and question asks difference or together
      if(numbers.length===2){
        if(/\b(together|altogether|total|sum)\b/.test(t)) return numbers[0] + ' + ' + numbers[1];
        if(/\b(difference|less|left|remaining)\b/.test(t)) return numbers[0] + ' - ' + numbers[1];
        if(/\b(product|times|multiplied)\b/.test(t)) return numbers[0] + ' * ' + numbers[1];
      }

      // otherwise try to convert any spelled-out operators and let the normal solver try
      // remove words leaving numbers and operators
      // crude transform: remove non-digit & operator characters except spaces and standard symbols
      const filtered = s.replace(/[^\d\+\-\*\/\^\.\(\)\s]/g, ' ').replace(/\s+/g,' ').trim();
      // if filtered looks like an expression with numbers and operators, return it
      if(/[0-9]/.test(filtered) && /[\+\-\*\/]/.test(filtered)) return filtered;

      return null;
    }

    // "Ask as Word Problem" button
    askWordBtn.addEventListener('click', async ()=>{
      const text = exprEl.value.trim();
      if(!text){ alert('Please enter the word problem or sentence into the input first.'); return; }
      appendChat('user', escapeHtml(text));
      const t = appendTyping();
      await sleep(500 + Math.min(1200, text.length*8));
      const expr = parseWordProblem(text);
      if(!expr){
        replaceTypingWith(t.msg, 'I couldn\'t confidently parse that as a standard word problem. Try rephrasing with numbers explicitly (e.g., "Each box has 12 candies and there are 5 boxes. How many candies total?").');
        return;
      }
      // show the interpreted expression briefly
      replaceTypingWith(t.msg, '<div><strong>Interpreting as:</strong> <code>' + escapeHtml(expr) + '</code></div><div style="color:var(--muted);font-size:12px;margin-top:6px">Calculating the result now...</div>');
      await sleep(600);
      // put expression into the input so user can edit if desired
      exprEl.value = expr;
      // run solver and then convert to chat reply by reusing solveChat flow
      appendChat('user', '<em>(interpreted expression) ' + escapeHtml(expr) + '</em>');
      const typing2 = appendTyping();
      await solveExpression(expr);
      await sleep(400 + Math.min(1000, expr.length*8));
      let stepsHtml = stepsEl.innerHTML || '';
      let resText = resultEl.textContent || '';
      if(!stepsHtml || stepsHtml.trim() === ''){
        replaceTypingWith(typing2.msg, 'I computed the expression but couldn\'t produce step-by-step details. Result: ' + (resText || '—'));
        return;
      }
      const summary = '<div style="margin-bottom:8px"><strong>Solution:</strong> <span style="font-weight:700;color:var(--accent)">'+escapeHtml(resText)+'</span></div>' +
                      '<div style="max-height:200px;overflow:auto;padding-right:8px">' + stepsHtml + '</div>';
      replaceTypingWith(typing2.msg, summary);
    });

    clearChatBtn.addEventListener('click', ()=>{
      chatEl.innerHTML = '';
      appendChat('ai', 'Hi! Paste a problem and press <strong>Solve — Chat</strong> to see a conversational, step-by-step explanation — or try a word problem in plain English (e.g., "If Anna has 3 times as many apples as Ben and Ben has 4, how many do they have together?").');
    });

    // Camera / Photo handlers
    cameraBtn.addEventListener('click', async ()=>{
      modal.classList.add('open');
      modal.setAttribute('aria-hidden','false');
      try{
        stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}, audio:false});
        video.srcObject = stream;
        await video.play();
      }catch(e){
        ocrProgress.textContent = 'Unable to access camera: ' + (e.message || e);
      }
    });

    closeCam.addEventListener('click', ()=>{ stopStream(); modal.classList.remove('open'); modal.setAttribute('aria-hidden','true'); });
    function stopStream(){ if(stream){ stream.getTracks().forEach(t=>t.stop()); stream = null; video.srcObject = null; } }

    captureBtn.addEventListener('click', ()=>{
      const ctx = snap.getContext('2d');
      snap.width = video.videoWidth || 1280;
      snap.height = video.videoHeight || 720;
      ctx.drawImage(video,0,0,snap.width,snap.height);
      lastImageDataUrl = snap.toDataURL('image/png');
      video.pause();
      ocrProgress.textContent = 'Captured image — press Use Photo to run OCR or Retake to try again.';
    });

    retake.addEventListener('click', ()=>{ if(stream){ video.play(); ocrProgress.textContent = 'Retake ready.' } else { ocrProgress.textContent='No camera active.' } });

    usePhoto.addEventListener('click', async ()=>{
      if(!lastImageDataUrl){ ocrProgress.textContent='No photo captured.'; return }
      ocrProgress.textContent = 'Running OCR (this may take a few seconds)...';
      try{
        const worker = Tesseract.createWorker({ logger: m => { /* optional: show progress */ } });
        await worker.load();
        await worker.loadLanguage('eng');
        await worker.initialize('eng');
        const res = await worker.recognize(lastImageDataUrl);
        await worker.terminate();
        const text = res && res.data && res.data.text ? res.data.text.trim() : '';
        ocrProgress.textContent = 'OCR done.';
        if(text){
          exprEl.value = text.replace(/[^0-9a-zA-Z\^\+\-\*\/=().\s]/g,'');
          modal.classList.remove('open');
          stopStream();
          solveExpression(exprEl.value);
        } else {
          ocrProgress.textContent = 'OCR returned no text. Try a clearer photo or upload an image.';
        }
      }catch(err){ console.error(err); ocrProgress.textContent = 'OCR failed: '+(err.message||err); }
    });

    // Upload image flow
    uploadBtn.addEventListener('click', ()=> fileInput.click());
    fileInput.addEventListener('change', async (ev)=>{
      const f = ev.target.files && ev.target.files[0];
      if(!f) return;
      const reader = new FileReader();
      reader.onload = async function(e){
        lastImageDataUrl = e.target.result;
        ocrProgress.textContent = 'Running OCR on uploaded image...';
        try{
          const worker = Tesseract.createWorker({ logger: m => { /*progress*/ } });
          await worker.load();
          await worker.loadLanguage('eng');
          await worker.initialize('eng');
          const res = await worker.recognize(lastImageDataUrl);
          await worker.terminate();
          const text = res && res.data && res.data.text ? res.data.text.trim() : '';
          ocrProgress.textContent = 'OCR done.';
          if(text){ exprEl.value = text.replace(/[^0-9a-zA-Z\^\+\-\*\/=().\s]/g,''); solveExpression(exprEl.value); }
          else{ ocrProgress.textContent = 'No text found by OCR.' }
        }catch(err){ console.error(err); ocrProgress.textContent = 'OCR error: '+(err.message||err) }
      };
      reader.readAsDataURL(f);
    });

    // small UX: press Ctrl+Enter to solve
    exprEl.addEventListener('keydown', (e)=>{ if((e.ctrlKey||e.metaKey) && e.key==='Enter'){ solveExpression(exprEl.value); } });

    // initial sample
    (function init(){ /* nothing special */ })();
  </script>
</body>
</html>
