<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Process Claim â€“ Gomega</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="container center">
    <h1>Processing Request</h1>
    <p id="status">Loading request details...</p>
    <button id="approveBtn">âœ… Approve</button>
    <button id="declineBtn">âŒ Decline</button>
  </div>

  <script type="module">
    import { db } from './firebase-init.js';
    import { doc, getDoc, updateDoc } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';

    const urlParams = new URLSearchParams(window.location.search);
    const id = urlParams.get('id');
    const collection = urlParams.get('type'); // 'claims' or 'optOutRequests'

    const statusEl = document.getElementById('status');
    const approveBtn = document.getElementById('approveBtn');
    const declineBtn = document.getElementById('declineBtn');

    let docRef, claimData;

    async function loadClaim() {
      try {
        if (!id || !collection) {
          statusEl.textContent = 'Missing claim ID or type.';
          approveBtn.disabled = true;
          declineBtn.disabled = true;
          return;
        }

        docRef = doc(db, collection, id);
        const docSnap = await getDoc(docRef);

        if (docSnap.exists()) {
          claimData = docSnap.data();
          statusEl.textContent = `Request by: ${claimData.email || claimData.uid || 'N/A'}`;
        } else {
          statusEl.textContent = 'Request not found.';
          approveBtn.disabled = true;
          declineBtn.disabled = true;
        }
      } catch (error) {
        console.error('Error loading claim:', error);
        statusEl.textContent = 'Error loading request.';
      }
    }

    async function updateStatus(action) {
      const newStatus = action === 'approve' ? 'approved' : 'declined';

      try {
        await updateDoc(docRef, {
          status: newStatus,
          reviewedAt: new Date().toISOString()
        });

        statusEl.textContent = `Request ${newStatus.toUpperCase()}.`;
        approveBtn.disabled = true;
        declineBtn.disabled = true;

        // Send Discord webhook (optional)
        await fetch("https://discord.com/api/webhooks/YOUR_WEBHOOK_ID/YOUR_TOKEN", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            content: `ğŸ“ ${collection === 'claims' ? 'Claim' : 'Opt-Out'} request from **${claimData.email || claimData.uid || 'N/A'}** has been **${newStatus.toUpperCase()}**.`,
          }),
        });

      } catch (error) {
        console.error('Error updating status:', error);
        statusEl.textContent = 'Failed to update request.';
      }
    }

    approveBtn.onclick = () => updateStatus('approve');
    declineBtn.onclick = () => updateStatus('decline');

    loadClaim();
  </script>
</body>
</html>
