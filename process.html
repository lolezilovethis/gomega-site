<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>View Claim – Gomega</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    body {
      font-family: 'Inter', Arial, sans-serif;
      background: linear-gradient(135deg, #0f0f0f, #1a1a1a);
      color: #fff;
      margin: 0;
      padding: 20px;
    }

    .claim-box {
      max-width: 700px;
      margin: 50px auto;
      padding: 30px;
      border-radius: 15px;
      background: rgba(30, 30, 30, 0.9);
      box-shadow: 0 4px 25px rgba(0,0,0,0.5);
      border: 1px solid #333;
    }

    .claim-box h2 {
      margin-top: 0;
      font-size: 1.8rem;
      border-bottom: 1px solid #444;
      padding-bottom: 10px;
    }

    .claim-box p {
      margin: 12px 0;
      font-size: 1rem;
      color: #ddd;
    }

    .status {
      font-weight: bold;
    }

    .status.approved { color: #4caf50; }
    .status.denied { color: #f44336; }
    .status.pending { color: #ff9800; }

    .loading {
      font-style: italic;
      color: #aaa;
    }

    a {
      display: inline-block;
      margin-top: 20px;
      text-decoration: none;
      color: #64b5f6;
      font-weight: bold;
    }

    a:hover {
      color: #90caf9;
      text-decoration: underline;
    }

    select, button {
      padding: 10px;
      border-radius: 8px;
      border: none;
      outline: none;
      margin-top: 10px;
      font-size: 1rem;
    }

    button {
      background-color: #4caf50;
      color: #fff;
      cursor: pointer;
      margin-left: 5px;
    }

    button:hover {
      background-color: #45a049;
    }
  </style>
</head>
<body>
  <div class="claim-box" id="claimContainer">
    <p class="loading">Loading Claim...</p>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { firebaseConfig } from './js/firebase.js';

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const claimContainer = document.getElementById("claimContainer");

    function getClaimIdFromURL() {
      const params = new URLSearchParams(window.location.search);
      return params.get('id');
    }

    async function loadClaim() {
      const claimId = getClaimIdFromURL();
      if (!claimId) {
        claimContainer.innerHTML = "<p style='color: red;'>❌ Error: No claim ID provided in the URL.</p>";
        return;
      }

      try {
        const docRef = doc(db, "claims", claimId);
        const docSnap = await getDoc(docRef);

        if (!docSnap.exists()) {
          claimContainer.innerHTML = "<p style='color: red;'>❌ Error: Claim not found.</p>";
          return;
        }

        const data = docSnap.data();
        const status = (data.status || "pending").toLowerCase();
        const statusText = status.charAt(0).toUpperCase() + status.slice(1);

        const schools = [
          "Pocahontas Middle School",
          "Short Pump Middle School",
          "Godwin High School",
          "Deep Run High School",
          "Hermitage High School",
          "Tuckahoe Middle School",
          "Douglas S. Freeman High School",
          "Glen Allen High School",
          "Henrico High School",
          "Varina High School",
          "Highland Springs High School",
          "Brookland Middle School",
          "Elko Middle School"
        ];

        let schoolSelectorHTML = "";
        if (!data.school) {
          schoolSelectorHTML = `
            <p><strong>Select School:</strong></p>
            <select id="schoolSelect">
              <option value="">-- Choose Your School --</option>
              ${schools.map(s => `<option value="${s}">${s}</option>`).join("")}
            </select>
            <button id="saveSchool">Save School</button>
          `;
        } else {
          schoolSelectorHTML = `<p><strong>School:</strong> ${data.school}</p>`;
        }

        claimContainer.innerHTML = `
          <h2>Claim Details</h2>
          <p><strong>Claim ID:</strong> ${claimId}</p>
          <p><strong>Platform:</strong> ${data.platform || "Unknown"}</p>
          <p><strong>Description:</strong> ${data.description || "None"}</p>
          <p><strong>Account ID:</strong> ${data.accountId || "N/A"}</p>
          <p><strong>Submitted By:</strong> ${data.email || "Anonymous"}</p>
          <p><strong>Music:</strong> ${data.music || "None"}</p>
          <p><strong>Executors:</strong> ${data.executors || "None"}</p>
          ${schoolSelectorHTML}
          <p class="status ${status}"><strong>Status:</strong> ${statusText}</p>
          <a href="claims.html">← Back to All Claims</a>
        `;

        if (!data.school) {
          document.getElementById("saveSchool").addEventListener("click", async () => {
            const selectedSchool = document.getElementById("schoolSelect").value;
            if (!selectedSchool) {
              alert("Please select a school.");
              return;
            }
            await updateDoc(docRef, { school: selectedSchool });
            alert("School saved! You cannot change it unless an admin updates it.");
            location.reload();
          });
        }

      } catch (error) {
        console.error("Error loading claim:", error);
        claimContainer.innerHTML = "<p style='color: red;'>❌ Error fetching claim. Please try again later.</p>";
      }
    }

    loadClaim();
  </script>
</body>
</html>
