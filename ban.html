<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Admin — Ban Users | Gomega Watch</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="/style.css">
  <style>
    :root{--bg:#0f0f10;--card:#141416;--muted:#9aa0a6;--accent:#00d4ff;--accent2:#0066ff;--danger:#ff5252}
    body{background:var(--bg);color:#eef2f3;font-family:Inter,Arial,Helvetica,sans-serif;margin:0;padding:24px}
    .wrap{max-width:1000px;margin:0 auto;display:grid;grid-template-columns:1fr;gap:16px}
    .card{background:var(--card);border-radius:10px;padding:16px;box-shadow:0 12px 40px rgba(0,0,0,0.6);border:1px solid rgba(255,255,255,0.02)}
    h1{margin:0 0 6px;color:var(--accent)}
    .muted{color:var(--muted)}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    input[type="text"], textarea, select {width:100%;padding:10px;border-radius:8px;border:1px solid #222;background:#0b0b0c;color:#eef2f3}
    .two{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    button.btn{background:linear-gradient(90deg,var(--accent),var(--accent2));border:none;padding:10px 12px;border-radius:8px;color:#001;font-weight:700;cursor:pointer}
    button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--accent)}
    button.danger{background:linear-gradient(90deg,#ff7b7b,#ff4040);color:#fff}
    .small{font-size:0.9rem;color:var(--muted)}
    .hidden{display:none}
    pre{background:#0a0a0a;padding:10px;border-radius:8px;overflow:auto;color:#d3f6ff}
    .status{margin-top:8px;font-weight:700}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card" id="accessCard">
      <h1>Admin — Ban Management</h1>
      <p class="muted">Only authorized admins may use this page. You must be signed in as <strong>gomegaassist@gmail.com</strong> and have the admin claim.</p>
      <div id="accessMsg" class="small muted">Checking authentication…</div>
    </div>

    <div class="card hidden" id="mainCard" aria-hidden="true">
      <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:8px">
        <div>
          <h2 style="margin:0">Find user</h2>
          <div class="small muted">Search by email (recommended) or paste UID.</div>
        </div>
        <div style="display:flex;gap:8px">
          <button class="ghost" id="signOutBtn">Sign out</button>
        </div>
      </div>

      <div style="margin-bottom:12px;">
        <div class="row" style="gap:8px">
          <input type="text" id="searchEmail" placeholder="user@example.com (search by email)" />
          <button class="btn" id="searchEmailBtn">Search</button>
        </div>
        <div style="height:8px"></div>
        <div class="row" style="gap:8px">
          <input type="text" id="manualUid" placeholder="Or paste UID here (fallback)" />
          <button class="btn" id="loadUidBtn">Load</button>
        </div>
        <div id="searchStatus" class="small muted" style="margin-top:8px"></div>
      </div>

      <hr />

      <div id="userInfo" class="hidden">
        <h3 style="margin:0 0 8px 0">User info</h3>
        <div class="two">
          <div>
            <label class="small muted">UID</label>
            <pre id="u_uid"></pre>
          </div>
          <div>
            <label class="small muted">Email</label>
            <pre id="u_email"></pre>
          </div>
        </div>

        <div style="margin-top:12px">
          <label class="small muted">Display Name</label>
          <pre id="u_name"></pre>
        </div>

        <div style="margin-top:12px">
          <h4 style="margin:0 0 6px 0">Ban history</h4>
          <div id="banHistory" class="small muted">Loading…</div>
        </div>

        <hr style="margin:12px 0" />

        <h3 style="margin:0 0 8px 0">Ban user</h3>
        <div class="small muted">Fill the form and press <strong>Ban</strong>. The server will perform the ban and set claims (admin-only).</div>

        <div style="margin-top:8px">
          <label class="small muted">Title (shown to user)</label>
          <input type="text" id="banTitle" placeholder="Banned for 6 Months" />

          <div style="height:8px"></div>

          <label class="small muted">Length</label>
          <div class="row" style="gap:8px">
            <input type="number" id="banDays" placeholder="Days (e.g. 180). Leave empty for indefinite" />
            <select id="lengthPreset">
              <option value="">-- Presets --</option>
              <option value="7">7 days</option>
              <option value="30">30 days</option>
              <option value="90">90 days</option>
              <option value="180">180 days</option>
              <option value="365">365 days</option>
            </select>
          </div>

          <div style="height:8px"></div>

          <label class="small muted">Reason</label>
          <input type="text" id="banReason" placeholder="Bullying, Exploit, etc." />

          <div style="height:8px"></div>

          <label class="small muted">Offensive item (optional)</label>
          <input type="text" id="banOffensive" placeholder="ExploitDetected - Place ID: 537413528" />

          <div style="height:8px"></div>

          <label class="small muted">Moderator note (internal)</label>
          <textarea id="banNote" placeholder="Moderator notes for audit (internal)"></textarea>

          <div style="margin-top:12px; display:flex; gap:8px">
            <button class="btn" id="banBtn">Ban</button>
            <button class="danger" id="unbanBtn">Unban</button>
            <button class="ghost" id="refreshUserBtn">Refresh</button>
          </div>

          <div id="actionStatus" class="status small muted"></div>
        </div>
      </div>
    </div>

    <div class="card">
      <h3>Notes</h3>
      <ul class="small muted">
        <li>The server functions must enforce admin-only execution. This page checks for <code>gomegaassist@gmail.com</code> and the <code>admin</code> claim before enabling UI.</li>
        <li>Required callable Cloud Functions:
          <ul>
            <li><code>getUserByEmail</code> — returns basic auth user record `{ uid, email, displayName }` for a given email.</li>
            <li><code>banUser</code> — accepts `{ uid, lengthDays, reason, moderatorNote, offensiveItem, title }` and performs ban operations server-side.</li>
            <li><code>unbanUser</code> — accepts `{ uid, moderatorNote }` and removes ban server-side.</li>
          </ul>
        </li>
        <li>If <code>getUserByEmail</code> is not available, use UID fallback by pasting UID into the UID field and pressing Load.</li>
      </ul>
    </div>
  </div>

  <script type="module">
    import { auth, db } from './js/firebase.js';
    import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-functions.js";
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    // Elements
    const accessCard = document.getElementById('accessCard');
    const accessMsg = document.getElementById('accessMsg');
    const mainCard = document.getElementById('mainCard');
    const signOutBtn = document.getElementById('signOutBtn');

    const searchEmail = document.getElementById('searchEmail');
    const searchEmailBtn = document.getElementById('searchEmailBtn');
    const manualUid = document.getElementById('manualUid');
    const loadUidBtn = document.getElementById('loadUidBtn');
    const searchStatus = document.getElementById('searchStatus');

    const userInfo = document.getElementById('userInfo');
    const u_uid = document.getElementById('u_uid');
    const u_email = document.getElementById('u_email');
    const u_name = document.getElementById('u_name');
    const banHistory = document.getElementById('banHistory');

    const banTitle = document.getElementById('banTitle');
    const banDays = document.getElementById('banDays');
    const lengthPreset = document.getElementById('lengthPreset');
    const banReason = document.getElementById('banReason');
    const banOffensive = document.getElementById('banOffensive');
    const banNote = document.getElementById('banNote');

    const banBtn = document.getElementById('banBtn');
    const unbanBtn = document.getElementById('unbanBtn');
    const refreshUserBtn = document.getElementById('refreshUserBtn');
    const actionStatus = document.getElementById('actionStatus');

    // Functions
    const functions = getFunctions();

    const getUserByEmailFn = httpsCallable(functions, 'getUserByEmail');
    const banUserFn = httpsCallable(functions, 'banUser');
    const unbanUserFn = httpsCallable(functions, 'unbanUser');

    let currentAdmin = null;
    let currentTokenClaims = null;
    let loadedUser = null; // { uid, email, displayName }

    // Helper: format date(s)
    function fmtDate(ts) {
      if (!ts) return '—';
      try {
        if (ts.toDate) return ts.toDate().toLocaleString();
        return new Date(ts).toLocaleString();
      } catch { return String(ts); }
    }

    async function showUnauthorized(msg) {
      accessMsg.textContent = msg || 'Unauthorized. Only designated admin can use this page.';
      mainCard.classList.add('hidden');
      mainCard.setAttribute('aria-hidden','true');
    }

    function showMain() {
      accessMsg.textContent = 'Authorized admin: ' + (currentAdmin.email || '');
      mainCard.classList.remove('hidden');
      mainCard.setAttribute('aria-hidden','false');
    }

    // Sign out
    signOutBtn.addEventListener('click', async () => {
      await signOut(auth);
    });

    // Auth guard: only allow gomegaassist@gmail.com + admin claim
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        accessMsg.textContent = 'Not signed in. Please sign in with the admin account.';
        showUnauthorized('Please sign in as gomegaassist@gmail.com.');
        return;
      }
      currentAdmin = user;
      // quick check for email equality
      const emailOk = (user.email && user.email.toLowerCase() === 'gomegaassist@gmail.com');
      // need to inspect claims
      try {
        const idt = await user.getIdTokenResult(true); // force refresh
        currentTokenClaims = idt.claims || {};
        const isAdminClaim = !!currentTokenClaims.admin;
        if (emailOk && isAdminClaim) {
          showMain();
        } else {
          // if email matches but admin claim missing, show helpful message
          if (!emailOk) {
            await showUnauthorized('Signed in as wrong account. Sign in as gomegaassist@gmail.com.');
          } else {
            await showUnauthorized('Account lacks admin privileges. Ensure the user has the custom claim `admin`.');
          }
        }
      } catch (err) {
        console.error('Failed to get token claims', err);
        showUnauthorized('Failed to verify admin status. Check console for details.');
      }
    });

    // Utility: load user doc from users/{uid} to show ban history (admins can read users per rules)
    async function loadUserDoc(uid) {
      banHistory.textContent = 'Loading…';
      try {
        const snap = await getDoc(doc(db, 'users', uid));
        if (!snap.exists()) {
          banHistory.innerHTML = '<div class="small muted">No user doc found in Firestore (users/{uid}).</div>';
          return;
        }
        const data = snap.data();
        const bans = Array.isArray(data.bans) ? data.bans : [];
        if (!bans.length) {
          banHistory.innerHTML = '<div class="small muted">No bans recorded for this user.</div>';
        } else {
          // Render list
          banHistory.innerHTML = '';
          bans.forEach((b, i) => {
            const div = document.createElement('div');
            div.className = 'small muted';
            const reviewed = b.reviewedAt && b.reviewedAt.toDate ? b.reviewedAt.toDate().toLocaleString() : (b.reviewedAt || '');
            const start = b.start && b.start.toDate ? b.start.toDate().toLocaleString() : (b.start || '');
            const end = b.end && b.end.toDate ? b.end.toDate().toLocaleString() : (b.end || '');
            div.innerHTML = `<strong>${b.title || 'Suspension #' + (i+1)}</strong><br/>
              Reason: ${b.reason || '—'}<br/>
              Moderator Note: ${b.moderatorNote || '—'}<br/>
              Offensive Item: ${b.offensiveItem || '—'}<br/>
              Reviewed: ${reviewed}<br/>
              Start: ${start} — Reactivate: ${end}<hr style="opacity:0.06;margin:8px 0">`;
            banHistory.appendChild(div);
          });
        }
      } catch (err) {
        console.error('loadUserDoc failed', err);
        banHistory.innerHTML = '<div class="small muted">Failed to load user document. Check console for errors.</div>';
      }
    }

    // Load user by email (via callable function)
    searchEmailBtn.addEventListener('click', async () => {
      const email = (searchEmail.value || '').trim();
      if (!email) {
        searchStatus.textContent = 'Enter an email to search.';
        return;
      }
      searchStatus.textContent = 'Searching…';
      try {
        const res = await getUserByEmailFn({ email });
        if (!res || !res.data || !res.data.uid) {
          searchStatus.textContent = 'User not found. You can paste a UID manually.';
          return;
        }
        const u = res.data;
        loadedUser = u;
        u_uid.textContent = u.uid;
        u_email.textContent = u.email || '';
        u_name.textContent = u.displayName || '—';
        userInfo.classList.remove('hidden');
        await loadUserDoc(u.uid);
        searchStatus.textContent = 'Loaded user.';
      } catch (err) {
        console.error('getUserByEmail failed', err);
        searchStatus.textContent = 'Search failed. Check console. (If function not deployed, paste UID manually.)';
      }
    });

    // Load by UID fallback
    loadUidBtn.addEventListener('click', async () => {
      const uid = (manualUid.value || '').trim();
      if (!uid) {
        searchStatus.textContent = 'Paste a UID to load.';
        return;
      }
      // update UI with UID; we don't have display info unless function exists
      loadedUser = { uid, email: '(unknown)', displayName: '(unknown)' };
      u_uid.textContent = uid;
      u_email.textContent = '(unknown)';
      u_name.textContent = '(unknown)';
      userInfo.classList.remove('hidden');
      searchStatus.textContent = 'Loaded UID; fetching Firestore user doc…';
      await loadUserDoc(uid);
      searchStatus.textContent = 'Loaded user (by UID).';
    });

    // preset length dropdown
    lengthPreset.addEventListener('change', () => {
      banDays.value = lengthPreset.value;
    });

    // Ban button
    banBtn.addEventListener('click', async () => {
      if (!loadedUser || !loadedUser.uid) {
        actionStatus.textContent = 'No user loaded.';
        return;
      }
      const uid = loadedUser.uid;
      const title = banTitle.value.trim() || null;
      const lengthDays = banDays.value ? parseInt(banDays.value, 10) : null;
      const reason = banReason.value.trim() || 'Violation of Terms';
      const offensiveItem = banOffensive.value.trim() || '';
      const moderatorNote = banNote.value.trim() || '';
      actionStatus.textContent = 'Banning…';
      banBtn.disabled = true;
      unbanBtn.disabled = true;
      try {
        const payload = { uid, lengthDays, reason, moderatorNote, offensiveItem, title };
        const res = await banUserFn(payload);
        actionStatus.textContent = 'Ban request sent — server returned: ' + JSON.stringify(res.data || res);
        // refresh doc (ban history)
        await loadUserDoc(uid);
      } catch (err) {
        console.error('banUser error', err);
        actionStatus.textContent = 'Ban failed. See console for details.';
      } finally {
        banBtn.disabled = false;
        unbanBtn.disabled = false;
      }
    });

    // Unban button
    unbanBtn.addEventListener('click', async () => {
      if (!loadedUser || !loadedUser.uid) {
        actionStatus.textContent = 'No user loaded.';
        return;
      }
      if (!confirm('Confirm unban for this user?')) return;
      const uid = loadedUser.uid;
      const moderatorNote = banNote.value.trim() || 'Unbanned by admin';
      actionStatus.textContent = 'Unbanning…';
      banBtn.disabled = true;
      unbanBtn.disabled = true;
      try {
        const res = await unbanUserFn({ uid, moderatorNote });
        actionStatus.textContent = 'Unban request sent — server returned: ' + JSON.stringify(res.data || res);
        await loadUserDoc(uid);
      } catch (err) {
        console.error('unbanUser error', err);
        actionStatus.textContent = 'Unban failed. See console for details.';
      } finally {
        banBtn.disabled = false;
        unbanBtn.disabled = false;
      }
    });

    // Refresh
    refreshUserBtn.addEventListener('click', async () => {
      if (!loadedUser || !loadedUser.uid) {
        actionStatus.textContent = 'No user loaded.';
        return;
      }
      actionStatus.textContent = 'Refreshing…';
      await loadUserDoc(loadedUser.uid);
      actionStatus.textContent = 'Refreshed.';
    });

    // Quick UX: pressing Enter in email field triggers search
    searchEmail.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') searchEmailBtn.click();
    });
    manualUid.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') loadUidBtn.click();
    });

  </script>
</body>
</html>
